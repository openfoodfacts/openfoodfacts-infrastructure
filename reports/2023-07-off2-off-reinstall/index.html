
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../2023-07-off-reinstall--prod-files-diff/">
      
      
        <link rel="next" href="../2023-08-31-off2-products-snapshots-clean/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.14">
    
    
      
        <title>2023-06-07 OFF and OFF-pro reinstall on off2 - Open Food Facts Infrastructure documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.10ba22f1.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2023-06-07-off-and-off-pro-reinstall-on-off2" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Open Food Facts Infrastructure documentation" class="md-header__button md-logo" aria-label="Open Food Facts Infrastructure documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Open Food Facts Infrastructure documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2023-06-07 OFF and OFF-pro reinstall on off2
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/openfoodfacts/openfoodfacts-infrastructure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Open Food Facts Infrastructure documentation" class="md-nav__button md-logo" aria-label="Open Food Facts Infrastructure documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Open Food Facts Infrastructure documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/openfoodfacts/openfoodfacts-infrastructure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OpenFoodFacts Infrastructure
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cicd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Continous Integration and Continuous Delivery
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../discourse/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Discourse
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../disks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Disks
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker at Open Food Facts
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../docker_architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker architecture
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../docker_onboarding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Onboarding
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../explain-server-config-in-git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Explanation on server configuration with git
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../folksonomy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Folksonomy API
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../free-datacenter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Free Datacenter
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-add-disk-space-on-qemu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to add disk space on a Qemu VM
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-fail2ban-ban-bots/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to use fail2ban to ban bots
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-fail2ban-debian-11%2B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to install fail2ban on debian 11+
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-have-server-config-in-git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to have server config in git
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-mitigate-crawlers-on-prod/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to mitigate crawlers in case of too much traffic
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux-server/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux server
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-off1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    off1 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-off2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    off2 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-off3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    off3 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-ovh1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ovh1 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-ovh2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ovh2 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-ovh3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ovh3 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mail/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mail on Open Food Facts infrastructure
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../matomo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Matomo
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mongodb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MongoDB
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../munin/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Munin
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nginx-reverse-proxy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NGINX Reverse proxy
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Observability
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../odoo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Odoo: our relationship management (connect.openfoodfacts.org)
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../postgres/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PostgreSQL
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../prod-architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Production architecture
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../producers_sftp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Producers SFTP
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../product-opener/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Product Opener
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../proxmox/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Proxmox
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rclone/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rclone
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sanoid/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sanoid
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../slackin/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    auto Slack invitation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../stunnel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Stunnel
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../zammad/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Zammad
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../zfs-overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ZFS overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_42" checked>
        
          
          <label class="md-nav__link" for="__nav_42" id="__nav_42_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reports
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_42_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_42">
            <span class="md-nav__icon md-icon"></span>
            Reports
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-02-22-matomo-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Matomo install
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-10-03-network-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    [Postmortem] OpenFoodFacts.net down (#1)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-12-21-disk-extension/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Disk extension for preprod and containers prod (ovh2)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-12-22-preprod-crash/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preprod crash 2021 12
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-18-ovh-reverse-proxy-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    [Postmortem] Reverse proxy down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-proxmox-mail-gateway-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Install of proxmox gateway server
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-remove-containers-ovh1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-02 Removing some containers on ovh1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-03-03-zammad-elasticsearch-not-running/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Elasticsearch not running on Zammad
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-03-off2-PCI-NVMe-problems/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-03 Problem with PCI supporting NVMe
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-07-08-journey-to-deploy-off-search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deploying openfoodfacts-search to staging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-07-11-infra-workshop/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Infrastructure future - workshop on 11th July 2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-07-kibana-down-es-circuit-breaking-exception/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kibana down because of Elasticsearch circuit_breaking_exception
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-08-17-openfoodfacts-net-unreachable/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-08-17 openfoodfacts.net unreachable
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-11-09-monitoring-move-to-own-vm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-11 moving monitoring to its own machine
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-13-zammad-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-02-13 Zammad down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-16-off2-shutdown/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 02 16 off2 shutdown
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-17-off2-upgrade/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-02-17 Off2 Upgrade
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-24-zfs-introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 02 24 zfs introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-03-14-off2-opff-reinstall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-03 OFF2 reinstall - opff migration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-04-27-moving-docker-stagging-to-ovh1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-04-27 moving docker staging to OVH1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-12-refresh-staging-clones/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-05-12 refresh staging clones
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-19-overload-of-osm-machine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-05-18 Mongodb down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-23-move-images-to-zfs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-05-23 move Images to ZFS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-off2-110-unreachable/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-05-23 off2 - container 110 unreachable from 101
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-01-robotoff-backups/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-01 Robotoff backups
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-07-off2-opf-obf-reinstall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-07 OPF and OBF reinstall on off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-08-stalled-zfs-sync-off-products/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2012-06-08 Stalled ZFS Sync for off products on ovh3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-30-sanoid-checks-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-30 Sanoid checks install
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-07-16-ovh3-sdc-broken/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Post-mortem 2023-07-16 Disk sdc errors on OVH3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-07-26-off1-rpool-products-full/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-07-26 rpool/off/products dataset full on off1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-07-off-reinstall--prod-files-diff/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 07 off reinstall  prod files diff
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    2023-06-07 OFF and OFF-pro reinstall on off2
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    2023-06-07 OFF and OFF-pro reinstall on off2
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#switching-to-right-branch-of-off2-and-ovh3" class="md-nav__link">
    <span class="md-ellipsis">
      switching to right branch of off2 and ovh3
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#removing-zfs-old-and-adding-as-cache-to-zfs-hdd" class="md-nav__link">
    <span class="md-ellipsis">
      removing zfs-old and adding as cache to zfs-hdd
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing-a-postgresql-container" class="md-nav__link">
    <span class="md-ellipsis">
      installing a postgresql container
    </span>
  </a>
  
    <nav class="md-nav" aria-label="installing a postgresql container">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#created-ct" class="md-nav__link">
    <span class="md-ellipsis">
      Created CT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installed-postgres" class="md-nav__link">
    <span class="md-ellipsis">
      Installed Postgres
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-off-user" class="md-nav__link">
    <span class="md-ellipsis">
      create off user
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-database-restore" class="md-nav__link">
    <span class="md-ellipsis">
      testing database restore
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing-a-memcached-container" class="md-nav__link">
    <span class="md-ellipsis">
      installing a memcached container
    </span>
  </a>
  
    <nav class="md-nav" aria-label="installing a memcached container">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-the-container" class="md-nav__link">
    <span class="md-ellipsis">
      Creating the container
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-memcached" class="md-nav__link">
    <span class="md-ellipsis">
      installing memcached
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-off-infrastructure-repository" class="md-nav__link">
    <span class="md-ellipsis">
      adding off-infrastructure repository
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuring-memcached" class="md-nav__link">
    <span class="md-ellipsis">
      configuring memcached
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#putting-data-in-zfs-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      Putting data in zfs datasets
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Putting data in zfs datasets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fixing-a-syslog-bug" class="md-nav__link">
    <span class="md-ellipsis">
      fixing a syslog bug
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      creating datasets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-to-sanoid-conf" class="md-nav__link">
    <span class="md-ellipsis">
      adding to sanoid conf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#moving-products-to-vme-zfs" class="md-nav__link">
    <span class="md-ellipsis">
      Moving products to vme zfs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Moving products to vme zfs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-datasets_1" class="md-nav__link">
    <span class="md-ellipsis">
      creating datasets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disabling-sync" class="md-nav__link">
    <span class="md-ellipsis">
      disabling sync
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copying-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      copying datasets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enabling-sync-again" class="md-nav__link">
    <span class="md-ellipsis">
      enabling sync again
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#changing-containers-mount-points" class="md-nav__link">
    <span class="md-ellipsis">
      changing containers mount points
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migrating-root-datasets-on-ovh3" class="md-nav__link">
    <span class="md-ellipsis">
      migrating root datasets on ovh3
    </span>
  </a>
  
    <nav class="md-nav" aria-label="migrating root datasets on ovh3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prepare" class="md-nav__link">
    <span class="md-ellipsis">
      prepare
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-new-target-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      create new target datasets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#move-off-pro-products-to-new-dataset-and-swap-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      move off-pro products to new dataset and swap datasets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#moving-off-products-and-images-to-new-dataset-and-swapping" class="md-nav__link">
    <span class="md-ellipsis">
      moving off products and images to new dataset and swapping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recreating-clones" class="md-nav__link">
    <span class="md-ellipsis">
      Recreating clones
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-sync" class="md-nav__link">
    <span class="md-ellipsis">
      setup sync
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copying-users-and-orgs" class="md-nav__link">
    <span class="md-ellipsis">
      Copying users and orgs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copying-off-pro-images" class="md-nav__link">
    <span class="md-ellipsis">
      Copying off-pro images
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copying-other-data" class="md-nav__link">
    <span class="md-ellipsis">
      Copying other data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copying-secrets" class="md-nav__link">
    <span class="md-ellipsis">
      Copying secrets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-much-sugar-data" class="md-nav__link">
    <span class="md-ellipsis">
      How much sugar data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logs" class="md-nav__link">
    <span class="md-ellipsis">
      logs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-containers" class="md-nav__link">
    <span class="md-ellipsis">
      Creating Containers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating Containers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing-generic-packages" class="md-nav__link">
    <span class="md-ellipsis">
      Installing generic packages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoip-with-updates" class="md-nav__link">
    <span class="md-ellipsis">
      Geoip with updates
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clone-off-as-off-pro" class="md-nav__link">
    <span class="md-ellipsis">
      Clone off as off-pro
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-packages" class="md-nav__link">
    <span class="md-ellipsis">
      Installing packages
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mounting-volumes" class="md-nav__link">
    <span class="md-ellipsis">
      Mounting volumes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Mounting volumes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#changing-lxc-confs" class="md-nav__link">
    <span class="md-ellipsis">
      changing lxc confs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-off-user_1" class="md-nav__link">
    <span class="md-ellipsis">
      Create off user
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-the-code" class="md-nav__link">
    <span class="md-ellipsis">
      Getting the code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Getting the code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#copying-production-code" class="md-nav__link">
    <span class="md-ellipsis">
      Copying production code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Copying production code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#verifying-what-to-exclude" class="md-nav__link">
    <span class="md-ellipsis">
      Verifying what to exclude
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copying-code" class="md-nav__link">
    <span class="md-ellipsis">
      Copying code
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloning-off-server-repository" class="md-nav__link">
    <span class="md-ellipsis">
      Cloning off-server repository
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#finding-git-commit" class="md-nav__link">
    <span class="md-ellipsis">
      Finding git commit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#finding-difference-with-prod" class="md-nav__link">
    <span class="md-ellipsis">
      Finding difference with prod
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing" class="md-nav__link">
    <span class="md-ellipsis">
      Installing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Installing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#symlinks-to-mimic-old-structure" class="md-nav__link">
    <span class="md-ellipsis">
      symlinks to mimic old structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linking-data" class="md-nav__link">
    <span class="md-ellipsis">
      linking data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linking-logs" class="md-nav__link">
    <span class="md-ellipsis">
      linking logs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy-and-verify-config-links" class="md-nav__link">
    <span class="md-ellipsis">
      copy and verify config links
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify-broken-links" class="md-nav__link">
    <span class="md-ellipsis">
      Verify broken links
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-dists" class="md-nav__link">
    <span class="md-ellipsis">
      Adding dists
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-openfoodfacts-web" class="md-nav__link">
    <span class="md-ellipsis">
      Adding openfoodfacts-web
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Adding openfoodfacts-web">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cloning-repo" class="md-nav__link">
    <span class="md-ellipsis">
      Cloning repo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linking-content" class="md-nav__link">
    <span class="md-ellipsis">
      Linking content
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-cpan" class="md-nav__link">
    <span class="md-ellipsis">
      Installing CPAN
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fixing-directory-problems" class="md-nav__link">
    <span class="md-ellipsis">
      Fixing directory problems
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-services" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up services
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setting up services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modify-settings-for-memcached-and-postgresql" class="md-nav__link">
    <span class="md-ellipsis">
      Modify settings for memcached and postgresql
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx-for-off-and-off-pro-inside-their-container" class="md-nav__link">
    <span class="md-ellipsis">
      NGINX for off and off-pro (inside their container)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apache" class="md-nav__link">
    <span class="md-ellipsis">
      Apache
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-systemd-units-for-timers-gen-feeds-jobs-and-apache-and-nginx" class="md-nav__link">
    <span class="md-ellipsis">
      creating systemd units for timers gen feeds jobs and apache and nginx
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-systemd-units-for-minions-and-ocr" class="md-nav__link">
    <span class="md-ellipsis">
      creating systemd units for minions and OCR
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#log-rotate-perl-logs" class="md-nav__link">
    <span class="md-ellipsis">
      log rotate perl logs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-mongodb-client" class="md-nav__link">
    <span class="md-ellipsis">
      Installing mongodb client
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-with-curl" class="md-nav__link">
    <span class="md-ellipsis">
      Test with curl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx-for-madenearme-on-off" class="md-nav__link">
    <span class="md-ellipsis">
      Nginx for madenearme on off
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx-for-how-much-sugar-on-off" class="md-nav__link">
    <span class="md-ellipsis">
      Nginx for how much sugar on off
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reverse-proxy-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Reverse proxy configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reverse proxy configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#certbot-wildcard-certificates-using-ovh-dns" class="md-nav__link">
    <span class="md-ellipsis">
      certbot wildcard certificates using OVH DNS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-site-config-for-off-and-off-pro" class="md-nav__link">
    <span class="md-ellipsis">
      Create site config for off and off-pro
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#madenearme-reverse-proxy" class="md-nav__link">
    <span class="md-ellipsis">
      Madenearme reverse proxy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Madenearme reverse proxy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-site-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      create site configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-certificates" class="md-nav__link">
    <span class="md-ellipsis">
      Generate certificates
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-much-sugar-reverse-proxy" class="md-nav__link">
    <span class="md-ellipsis">
      How much sugar reverse proxy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="How much sugar reverse proxy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-site-configuration_1" class="md-nav__link">
    <span class="md-ellipsis">
      create site configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-certificates_1" class="md-nav__link">
    <span class="md-ellipsis">
      Generate certificates
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-sftp-to-reverse-proxy" class="md-nav__link">
    <span class="md-ellipsis">
      Adding sftp to reverse proxy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Adding sftp to reverse proxy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-volume-for-data" class="md-nav__link">
    <span class="md-ellipsis">
      Add volume for data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rsync-existing-data-from-off1" class="md-nav__link">
    <span class="md-ellipsis">
      Rsync existing data from off1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-sftp" class="md-nav__link">
    <span class="md-ellipsis">
      Configure sftp
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-sftp-users" class="md-nav__link">
    <span class="md-ellipsis">
      Create sftp users
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    <span class="md-ellipsis">
      Testing
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#production-switch" class="md-nav__link">
    <span class="md-ellipsis">
      Production switch
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Production switch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#todo-before-switch" class="md-nav__link">
    <span class="md-ellipsis">
      TODO before switch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backup-data" class="md-nav__link">
    <span class="md-ellipsis">
      Backup data
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backup data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#code" class="md-nav__link">
    <span class="md-ellipsis">
      code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#users-data" class="md-nav__link">
    <span class="md-ellipsis">
      users data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#foodbatle" class="md-nav__link">
    <span class="md-ellipsis">
      foodbatle
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rsync-data" class="md-nav__link">
    <span class="md-ellipsis">
      Rsync data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#procedure-for-switch-of-off-and-off-pro-from-off1-to-off2" class="md-nav__link">
    <span class="md-ellipsis">
      Procedure for switch of off and off-pro from off1 to off2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checks-after-one-day" class="md-nav__link">
    <span class="md-ellipsis">
      Checks after one day
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checks-after-five-days" class="md-nav__link">
    <span class="md-ellipsis">
      Checks after five days
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#todo-after-off1-re-install" class="md-nav__link">
    <span class="md-ellipsis">
      TODO after off1 re-install
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#todo-to-have-more-things-working" class="md-nav__link">
    <span class="md-ellipsis">
      TODO to have more things working
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-08-31-off2-products-snapshots-clean/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-08-31 OFF2 products snapshots clean
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-09-27-expired-ssl-certificate-for-images-on-off2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-09-27 / Expired SSL certificate for images.openfoodfacts.org on off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-10-14-mongodb-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-10-14: mongodb-down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-11-28-google-drive-backup-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-11-28 setup a google drive backup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-11-28-ovh3-sdf-broken/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Post-mortem 2023-11-28 Disk sdf errors on OVH3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-12-08-off1-upgrade/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-12-18 off1 upgrade
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-12-11-matomo-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-12-11 Matomo down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-02-monitoring-disk-space/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01-02 monitoring disk space - filebeat
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-03-mongodb-migration-off1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01-03 MongoDB migration on off3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-04-setting-up-stunnel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024 01 04 setting up stunnel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-19-certbot-failure-off2-proxy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01-19 Certbot failure on off2 reverse proxy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-24-move-old-productopener-folders-to-backup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01-24 Move old Product Opener folders to backup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-matomo-perf-tunning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01 Matomo performance tunning
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-06-cleanup-products-snapshots/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-06 cleanup of products ssnapshots on off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-08-prod-redis-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-08 Production Redis install
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-13-chatwoot-translation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-13 Chatwoot translation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-20-exporter-on-mongodb-ct/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-20 Installing a prometheus exporter on mongodb container
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-28-upgrade-redis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-28 Upgrade Redis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-03-17-ovh1-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-03-17 OVH1 Down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-03-separate-hdd-docker-vms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-03 separate HDD on docker VMs
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#switching-to-right-branch-of-off2-and-ovh3" class="md-nav__link">
    <span class="md-ellipsis">
      switching to right branch of off2 and ovh3
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#removing-zfs-old-and-adding-as-cache-to-zfs-hdd" class="md-nav__link">
    <span class="md-ellipsis">
      removing zfs-old and adding as cache to zfs-hdd
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing-a-postgresql-container" class="md-nav__link">
    <span class="md-ellipsis">
      installing a postgresql container
    </span>
  </a>
  
    <nav class="md-nav" aria-label="installing a postgresql container">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#created-ct" class="md-nav__link">
    <span class="md-ellipsis">
      Created CT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installed-postgres" class="md-nav__link">
    <span class="md-ellipsis">
      Installed Postgres
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-off-user" class="md-nav__link">
    <span class="md-ellipsis">
      create off user
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-database-restore" class="md-nav__link">
    <span class="md-ellipsis">
      testing database restore
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing-a-memcached-container" class="md-nav__link">
    <span class="md-ellipsis">
      installing a memcached container
    </span>
  </a>
  
    <nav class="md-nav" aria-label="installing a memcached container">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-the-container" class="md-nav__link">
    <span class="md-ellipsis">
      Creating the container
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-memcached" class="md-nav__link">
    <span class="md-ellipsis">
      installing memcached
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-off-infrastructure-repository" class="md-nav__link">
    <span class="md-ellipsis">
      adding off-infrastructure repository
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuring-memcached" class="md-nav__link">
    <span class="md-ellipsis">
      configuring memcached
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#putting-data-in-zfs-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      Putting data in zfs datasets
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Putting data in zfs datasets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fixing-a-syslog-bug" class="md-nav__link">
    <span class="md-ellipsis">
      fixing a syslog bug
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      creating datasets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-to-sanoid-conf" class="md-nav__link">
    <span class="md-ellipsis">
      adding to sanoid conf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#moving-products-to-vme-zfs" class="md-nav__link">
    <span class="md-ellipsis">
      Moving products to vme zfs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Moving products to vme zfs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-datasets_1" class="md-nav__link">
    <span class="md-ellipsis">
      creating datasets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disabling-sync" class="md-nav__link">
    <span class="md-ellipsis">
      disabling sync
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copying-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      copying datasets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enabling-sync-again" class="md-nav__link">
    <span class="md-ellipsis">
      enabling sync again
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#changing-containers-mount-points" class="md-nav__link">
    <span class="md-ellipsis">
      changing containers mount points
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migrating-root-datasets-on-ovh3" class="md-nav__link">
    <span class="md-ellipsis">
      migrating root datasets on ovh3
    </span>
  </a>
  
    <nav class="md-nav" aria-label="migrating root datasets on ovh3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prepare" class="md-nav__link">
    <span class="md-ellipsis">
      prepare
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-new-target-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      create new target datasets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#move-off-pro-products-to-new-dataset-and-swap-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      move off-pro products to new dataset and swap datasets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#moving-off-products-and-images-to-new-dataset-and-swapping" class="md-nav__link">
    <span class="md-ellipsis">
      moving off products and images to new dataset and swapping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recreating-clones" class="md-nav__link">
    <span class="md-ellipsis">
      Recreating clones
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-sync" class="md-nav__link">
    <span class="md-ellipsis">
      setup sync
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copying-users-and-orgs" class="md-nav__link">
    <span class="md-ellipsis">
      Copying users and orgs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copying-off-pro-images" class="md-nav__link">
    <span class="md-ellipsis">
      Copying off-pro images
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copying-other-data" class="md-nav__link">
    <span class="md-ellipsis">
      Copying other data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copying-secrets" class="md-nav__link">
    <span class="md-ellipsis">
      Copying secrets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-much-sugar-data" class="md-nav__link">
    <span class="md-ellipsis">
      How much sugar data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logs" class="md-nav__link">
    <span class="md-ellipsis">
      logs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-containers" class="md-nav__link">
    <span class="md-ellipsis">
      Creating Containers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Creating Containers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing-generic-packages" class="md-nav__link">
    <span class="md-ellipsis">
      Installing generic packages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoip-with-updates" class="md-nav__link">
    <span class="md-ellipsis">
      Geoip with updates
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clone-off-as-off-pro" class="md-nav__link">
    <span class="md-ellipsis">
      Clone off as off-pro
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-packages" class="md-nav__link">
    <span class="md-ellipsis">
      Installing packages
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mounting-volumes" class="md-nav__link">
    <span class="md-ellipsis">
      Mounting volumes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Mounting volumes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#changing-lxc-confs" class="md-nav__link">
    <span class="md-ellipsis">
      changing lxc confs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-off-user_1" class="md-nav__link">
    <span class="md-ellipsis">
      Create off user
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-the-code" class="md-nav__link">
    <span class="md-ellipsis">
      Getting the code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Getting the code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#copying-production-code" class="md-nav__link">
    <span class="md-ellipsis">
      Copying production code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Copying production code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#verifying-what-to-exclude" class="md-nav__link">
    <span class="md-ellipsis">
      Verifying what to exclude
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copying-code" class="md-nav__link">
    <span class="md-ellipsis">
      Copying code
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloning-off-server-repository" class="md-nav__link">
    <span class="md-ellipsis">
      Cloning off-server repository
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#finding-git-commit" class="md-nav__link">
    <span class="md-ellipsis">
      Finding git commit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#finding-difference-with-prod" class="md-nav__link">
    <span class="md-ellipsis">
      Finding difference with prod
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing" class="md-nav__link">
    <span class="md-ellipsis">
      Installing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Installing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#symlinks-to-mimic-old-structure" class="md-nav__link">
    <span class="md-ellipsis">
      symlinks to mimic old structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linking-data" class="md-nav__link">
    <span class="md-ellipsis">
      linking data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linking-logs" class="md-nav__link">
    <span class="md-ellipsis">
      linking logs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy-and-verify-config-links" class="md-nav__link">
    <span class="md-ellipsis">
      copy and verify config links
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify-broken-links" class="md-nav__link">
    <span class="md-ellipsis">
      Verify broken links
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-dists" class="md-nav__link">
    <span class="md-ellipsis">
      Adding dists
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-openfoodfacts-web" class="md-nav__link">
    <span class="md-ellipsis">
      Adding openfoodfacts-web
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Adding openfoodfacts-web">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cloning-repo" class="md-nav__link">
    <span class="md-ellipsis">
      Cloning repo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linking-content" class="md-nav__link">
    <span class="md-ellipsis">
      Linking content
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-cpan" class="md-nav__link">
    <span class="md-ellipsis">
      Installing CPAN
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fixing-directory-problems" class="md-nav__link">
    <span class="md-ellipsis">
      Fixing directory problems
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-services" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up services
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setting up services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modify-settings-for-memcached-and-postgresql" class="md-nav__link">
    <span class="md-ellipsis">
      Modify settings for memcached and postgresql
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx-for-off-and-off-pro-inside-their-container" class="md-nav__link">
    <span class="md-ellipsis">
      NGINX for off and off-pro (inside their container)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apache" class="md-nav__link">
    <span class="md-ellipsis">
      Apache
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-systemd-units-for-timers-gen-feeds-jobs-and-apache-and-nginx" class="md-nav__link">
    <span class="md-ellipsis">
      creating systemd units for timers gen feeds jobs and apache and nginx
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-systemd-units-for-minions-and-ocr" class="md-nav__link">
    <span class="md-ellipsis">
      creating systemd units for minions and OCR
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#log-rotate-perl-logs" class="md-nav__link">
    <span class="md-ellipsis">
      log rotate perl logs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-mongodb-client" class="md-nav__link">
    <span class="md-ellipsis">
      Installing mongodb client
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-with-curl" class="md-nav__link">
    <span class="md-ellipsis">
      Test with curl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx-for-madenearme-on-off" class="md-nav__link">
    <span class="md-ellipsis">
      Nginx for madenearme on off
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx-for-how-much-sugar-on-off" class="md-nav__link">
    <span class="md-ellipsis">
      Nginx for how much sugar on off
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reverse-proxy-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Reverse proxy configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Reverse proxy configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#certbot-wildcard-certificates-using-ovh-dns" class="md-nav__link">
    <span class="md-ellipsis">
      certbot wildcard certificates using OVH DNS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-site-config-for-off-and-off-pro" class="md-nav__link">
    <span class="md-ellipsis">
      Create site config for off and off-pro
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#madenearme-reverse-proxy" class="md-nav__link">
    <span class="md-ellipsis">
      Madenearme reverse proxy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Madenearme reverse proxy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-site-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      create site configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-certificates" class="md-nav__link">
    <span class="md-ellipsis">
      Generate certificates
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-much-sugar-reverse-proxy" class="md-nav__link">
    <span class="md-ellipsis">
      How much sugar reverse proxy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="How much sugar reverse proxy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-site-configuration_1" class="md-nav__link">
    <span class="md-ellipsis">
      create site configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-certificates_1" class="md-nav__link">
    <span class="md-ellipsis">
      Generate certificates
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-sftp-to-reverse-proxy" class="md-nav__link">
    <span class="md-ellipsis">
      Adding sftp to reverse proxy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Adding sftp to reverse proxy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-volume-for-data" class="md-nav__link">
    <span class="md-ellipsis">
      Add volume for data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rsync-existing-data-from-off1" class="md-nav__link">
    <span class="md-ellipsis">
      Rsync existing data from off1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-sftp" class="md-nav__link">
    <span class="md-ellipsis">
      Configure sftp
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-sftp-users" class="md-nav__link">
    <span class="md-ellipsis">
      Create sftp users
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    <span class="md-ellipsis">
      Testing
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#production-switch" class="md-nav__link">
    <span class="md-ellipsis">
      Production switch
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Production switch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#todo-before-switch" class="md-nav__link">
    <span class="md-ellipsis">
      TODO before switch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backup-data" class="md-nav__link">
    <span class="md-ellipsis">
      Backup data
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backup data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#code" class="md-nav__link">
    <span class="md-ellipsis">
      code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#users-data" class="md-nav__link">
    <span class="md-ellipsis">
      users data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#foodbatle" class="md-nav__link">
    <span class="md-ellipsis">
      foodbatle
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rsync-data" class="md-nav__link">
    <span class="md-ellipsis">
      Rsync data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#procedure-for-switch-of-off-and-off-pro-from-off1-to-off2" class="md-nav__link">
    <span class="md-ellipsis">
      Procedure for switch of off and off-pro from off1 to off2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checks-after-one-day" class="md-nav__link">
    <span class="md-ellipsis">
      Checks after one day
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checks-after-five-days" class="md-nav__link">
    <span class="md-ellipsis">
      Checks after five days
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#todo-after-off1-re-install" class="md-nav__link">
    <span class="md-ellipsis">
      TODO after off1 re-install
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#todo-to-have-more-things-working" class="md-nav__link">
    <span class="md-ellipsis">
      TODO to have more things working
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="2023-06-07-off-and-off-pro-reinstall-on-off2">2023-06-07 OFF and OFF-pro reinstall on off2<a class="headerlink" href="#2023-06-07-off-and-off-pro-reinstall-on-off2" title="Permanent link">#</a></h1>
<p>We will follow closely what we did for <a href="../2023-03-14-off2-opff-reinstall/">OPFF reinstall on off2</a>.
Refer to it if you need more explanation on a step.
Also following <a href="../2023-06-07-off2-opf-obf-reinstall/">OPF and OBF reinstall on off2</a>.</p>
<h2 id="switching-to-right-branch-of-off2-and-ovh3">switching to right branch of off2 and ovh3<a class="headerlink" href="#switching-to-right-branch-of-off2-and-ovh3" title="Permanent link">#</a></h2>
<p>On ovh3 and off2 we will set the branch to <code>off2-off-reinstall</code> to have modifications synced.
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>/opt/openfoodfacts-infrastructure
git<span class="w"> </span>fetch
git<span class="w"> </span>checkout<span class="w"> </span>off2-off-reinstall
</code></pre></div></p>
<p>We will continuously push and pull on this branch.</p>
<h2 id="removing-zfs-old-and-adding-as-cache-to-zfs-hdd">removing zfs-old and adding as cache to zfs-hdd<a class="headerlink" href="#removing-zfs-old-and-adding-as-cache-to-zfs-hdd" title="Permanent link">#</a></h2>
<p><code>nvme3n1p2</code> is in zfs-old and has no utility right  now.</p>
<div class="highlight"><pre><span></span><code>zpool<span class="w"> </span>destroy<span class="w"> </span>zfs-old
</code></pre></div>
<p>But as <code>zfs-nvme</code> is in mirror it's no use adding it as a new  device there.</p>
<p>Instead we can add it as a cache to <code>zfs-hdd</code> to improve performance.</p>
<div class="highlight"><pre><span></span><code>zpool<span class="w"> </span>add<span class="w"> </span>zfs-hdd<span class="w"> </span>cache<span class="w"> </span>nvme3n1p2
</code></pre></div>
<h2 id="installing-a-postgresql-container">installing a postgresql container<a class="headerlink" href="#installing-a-postgresql-container" title="Permanent link">#</a></h2>
<h3 id="created-ct">Created CT<a class="headerlink" href="#created-ct" title="Permanent link">#</a></h3>
<p>I created a CT for OFF followings <a href="../../proxmox/#how-to-create-a-new-container">How to create a new Container</a> it went all smooth.</p>
<p>It's 120 (off-postgres)</p>
<p>I choosed a 20Gb disk on zfs-hdd, 0B swap, 2 Cores and 2 Gb memory.
I added a disk on zfs-nvme mounted on /var/lib/postgresql/ with 5Gb size and noatime option.</p>
<p>I did not create a user.</p>
<p>I also <a href="../mail#postfix-configuration">configure postfix</a> and tested it.</p>
<h3 id="installed-postgres">Installed Postgres<a class="headerlink" href="#installed-postgres" title="Permanent link">#</a></h3>
<p>I simply used standard distribution package.</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>postgresql<span class="w"> </span>postgresql-contrib
</code></pre></div>
<p>Change <code>/etc/postgresql/*/main/postgresql.conf</code> to set <code>listen_addresses</code> to <code>*</code> (listen on all ip).</p>
<p>Change <code>/etc/postgresql/*/main/pg_hba.conf</code> to add:
<div class="highlight"><pre><span></span><code># IPv4 local network connections:
host    all             all             10.0.0.1/8            md5
</code></pre></div></p>
<p>and restart postgresql</p>
<h3 id="create-off-user">create off user<a class="headerlink" href="#create-off-user" title="Permanent link">#</a></h3>
<p>On off1 we get user info:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>pg_dumpall<span class="w"> </span>--globals-only<span class="w">   </span><span class="p">|</span>less
...
CREATE<span class="w"> </span>ROLE<span class="w"> </span>off<span class="p">;</span>
ALTER<span class="w"> </span>ROLE<span class="w"> </span>off<span class="w"> </span>WITH<span class="w"> </span>NOSUPERUSER<span class="w"> </span>INHERIT<span class="w"> </span>NOCREATEROLE<span class="w"> </span>NOCREATEDB<span class="w"> </span>LOGIN<span class="w"> </span>NOREPLICATION<span class="w"> </span>NOBYPASSRLS<span class="w"> </span>PASSWORD<span class="w"> </span><span class="s1">&#39;******&#39;</span><span class="p">;</span>
...
</code></pre></div>
<p>And we take relevant line to create off user in the container using <code>sudo -u postgres psql</code>.</p>
<h3 id="testing-database-restore">testing database restore<a class="headerlink" href="#testing-database-restore" title="Permanent link">#</a></h3>
<p>On off1, I did a dump of postgres minion database:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>pg_dump<span class="w"> </span>-d<span class="w"> </span>minion<span class="w"> </span>--format<span class="o">=</span>custom<span class="w"> </span>--file<span class="w"> </span>/tmp/<span class="k">$(</span>date<span class="w"> </span>-Is<span class="w"> </span>-u<span class="k">)</span>-minion.dump
</code></pre></div>
<p>On off2, we scp the file and restore it:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>scp<span class="w"> </span><span class="m">10</span>.0.0.1:/tmp/2023-08-21T21:41:09+00:00-minion.dump<span class="w"> </span>/zfs-hdd/pve/subvol-120-disk-0/var/tmp/
</code></pre></div>
<p>and in the container:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>pg_restore<span class="w"> </span>--create<span class="w"> </span>--clean<span class="w"> </span>-d<span class="w"> </span>postgres<span class="w"> </span>/var/tmp/2023-08-21T21:41:09+00:00-minion.dump
</code></pre></div>
We have two errors, but they are expected.</p>
<h2 id="installing-a-memcached-container">installing a memcached container<a class="headerlink" href="#installing-a-memcached-container" title="Permanent link">#</a></h2>
<h3 id="creating-the-container">Creating the container<a class="headerlink" href="#creating-the-container" title="Permanent link">#</a></h3>
<p>I created a CT for OFF followings <a href="../../proxmox/#how-to-create-a-new-container">How to create a new Container</a> it went all smooth.</p>
<p>It's 121 (off-memcached)
I choosed a 15Gb disk on zfs-hdd, 0B swap, 2 Cores and 4 Gb memory.</p>
<p>I also <a href="../mail#postfix-configuration">configure postfix</a> and tested it.</p>
<p>I did not create a user.</p>
<h3 id="installing-memcached">installing memcached<a class="headerlink" href="#installing-memcached" title="Permanent link">#</a></h3>
<p>Inside container:</p>
<div class="highlight"><pre><span></span><code>apt<span class="w"> </span>install<span class="w"> </span>memcached
</code></pre></div>
<h3 id="adding-off-infrastructure-repository">adding off-infrastructure repository<a class="headerlink" href="#adding-off-infrastructure-repository" title="Permanent link">#</a></h3>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>ssh-keygen<span class="w"> </span>-f<span class="w"> </span>/root/.ssh/github_off-infra<span class="w"> </span>-t<span class="w"> </span>ed25519<span class="w"> </span>-C<span class="w"> </span><span class="s2">&quot;root-off-memcached-off-infra@openfoodfacts.org&quot;</span>
sudo<span class="w"> </span>vim<span class="w"> </span>/root/.ssh/config

<span class="c1"># deploy key for openfoodfacts-infra</span>
Host<span class="w"> </span>github.com-off-infra
<span class="w">        </span>Hostname<span class="w"> </span>github.com
<span class="w">        </span><span class="nv">IdentityFile</span><span class="o">=</span>/root/.ssh/github_off-infra

cat<span class="w"> </span>/root/.ssh/github_off-infra.pub
</code></pre></div>
<p>Go to github add the off pub key for off to <a href="https://github.com/openfoodfacts/openfoodfacts-infrastructure/settings/keys">off infra repository</a> with write access.</p>
<p>Then clone repo in /opt:
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>git@github.com-off-infra:openfoodfacts/openfoodfacts-infrastructure.git<span class="w"> </span>/opt/openfoodfacts-infrastructure
</code></pre></div></p>
<h3 id="configuring-memcached">configuring memcached<a class="headerlink" href="#configuring-memcached" title="Permanent link">#</a></h3>
<p>We will use the file in git:</p>
<div class="highlight"><pre><span></span><code>rm<span class="w"> </span>/etc/memcached.conf
ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/off-memcached/memcached.conf<span class="w"> </span>/etc/
systemctl<span class="w"> </span>restart<span class="w"> </span>memcached
</code></pre></div>
<h2 id="putting-data-in-zfs-datasets">Putting data in zfs datasets<a class="headerlink" href="#putting-data-in-zfs-datasets" title="Permanent link">#</a></h2>
<h3 id="fixing-a-syslog-bug">fixing a syslog bug<a class="headerlink" href="#fixing-a-syslog-bug" title="Permanent link">#</a></h3>
<p>In syslog I saw a lot of <code>zfs error: cannot open 'zfs-nvme/pve': dataset does not exist</code></p>
<p>I decided to fix it by creating this dataset:
<div class="highlight"><pre><span></span><code>zfs<span class="w"> </span>create<span class="w"> </span>zfs-nvme/pve
</code></pre></div></p>
<h3 id="creating-datasets">creating datasets<a class="headerlink" href="#creating-datasets" title="Permanent link">#</a></h3>
<p>Products and images datasets are already there, we create the other datasets.
We also create a dataset for logs as they are big on off.</p>
<p><div class="highlight"><pre><span></span><code><span class="nv">SERVICE</span><span class="o">=</span>off
zfs<span class="w"> </span>create<span class="w"> </span>zfs-hdd/<span class="nv">$SERVICE</span>/cache
zfs<span class="w"> </span>create<span class="w"> </span>zfs-hdd/<span class="nv">$SERVICE</span>/html_data
zfs<span class="w"> </span>create<span class="w"> </span>zfs-hdd/<span class="nv">$SERVICE</span>/logs
</code></pre></div>
same for <code>off-pro</code></p>
<p>but also created <code>images</code> for <code>off-pro</code></p>
<div class="highlight"><pre><span></span><code>zfs<span class="w"> </span>create<span class="w"> </span>zfs-hdd/off-pro/images
</code></pre></div>
<p>and change permissions:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>chown<span class="w"> </span><span class="m">1000</span>:1000<span class="w">  </span>/zfs-hdd/off<span class="o">{</span>,-pro<span class="o">}</span>/<span class="o">{</span>,html_data,images,cache,logs<span class="o">}</span>
</code></pre></div>
<p>We also need to create off/orgs
<div class="highlight"><pre><span></span><code>zfs<span class="w"> </span>create<span class="w"> </span>zfs-hdd/off/orgs
sudo<span class="w"> </span>chown<span class="w"> </span><span class="m">1000</span>:1000<span class="w">  </span>/zfs-hdd/off/orgs
</code></pre></div></p>
<h3 id="adding-to-sanoid-conf">adding to sanoid conf<a class="headerlink" href="#adding-to-sanoid-conf" title="Permanent link">#</a></h3>
<p>We do it asap, as we need some snapshots to be able to use syncoid later on.</p>
<p>We edit sanoid.conf to put our new datasets with <code>use_template=prod_data</code>.</p>
<p>We can launch the service immediately if we want: <code>systemctl start sanoid.service</code></p>
<h3 id="moving-products-to-vme-zfs">Moving products to vme zfs<a class="headerlink" href="#moving-products-to-vme-zfs" title="Permanent link">#</a></h3>
<h4 id="creating-datasets_1">creating datasets<a class="headerlink" href="#creating-datasets_1" title="Permanent link">#</a></h4>
<p>Because of problems at server install, we have the products in <code>zfs-hdd</code> datasets while, at least for off and off-pro, we want them in <code>zfs-nvme</code>. This will improve performances.</p>
<p>So we will move products there.
To do this:</p>
<p>On off2, we create the new zfs datasets:
<div class="highlight"><pre><span></span><code>zfs<span class="w"> </span>create<span class="w"> </span>zfs-nvme/off
zfs<span class="w"> </span>create<span class="w"> </span>zfs-nvme/off/products
zfs<span class="w"> </span>create<span class="w"> </span>zfs-nvme/off-pro
zfs<span class="w"> </span>create<span class="w"> </span>zfs-nvme/off-pro/products
</code></pre></div></p>
<h4 id="disabling-sync">disabling sync<a class="headerlink" href="#disabling-sync" title="Permanent link">#</a></h4>
<p>On off1, we temporarily disable sync to off2 by editing <code>$REMOTE</code> in <code>sto-products-sync.sh</code>.</p>
<p>On off1 we verify no send  to off2 is in progress <code>ps -elf|grep zfs.send</code></p>
<h4 id="copying-datasets">copying datasets<a class="headerlink" href="#copying-datasets" title="Permanent link">#</a></h4>
<p>On off2, we sync the <code>zfs-hdd</code> datasets to the <code>zfs-nvme</code> ones:
<div class="highlight"><pre><span></span><code><span class="nv">SERVICE</span><span class="o">=</span>off
<span class="c1"># get first and last snapshot</span>
zfs<span class="w"> </span>list<span class="w"> </span>-t<span class="w"> </span>snap<span class="w"> </span>zfs-hdd/<span class="nv">$SERVICE</span>/products
zfs-hdd/off/products@20230417-0000<span class="w">  </span><span class="m">7</span>.93G<span class="w">      </span>-<span class="w">      </span>300G<span class="w">  </span>-

zfs-hdd/off/products@20230719-0930<span class="w">     </span>0B<span class="w">      </span>-<span class="w">      </span>317G<span class="w">  </span>-

<span class="c1"># TIP from Christian Quest:</span>
<span class="c1"># * on sending side, use &quot;-w&quot; to send raw data (avoid compression etc.),</span>
<span class="c1"># * on receiving side, use -s to be able to restart from where you stopped if needed</span>

<span class="c1"># send first snapshot, this took about 5 hours (damn me, I didn&#39;t add the time)</span>
<span class="nb">time</span><span class="w"> </span>zfs<span class="w"> </span>send<span class="w"> </span>-w<span class="w"> </span>zfs-hdd/<span class="nv">$SERVICE</span>/products@20230417-0000<span class="w"> </span><span class="p">|</span><span class="w"> </span>pv<span class="w"> </span><span class="p">|</span><span class="w"> </span>zfs<span class="w"> </span>recv<span class="w"> </span>zfs-nvme/<span class="nv">$SERVICE</span>/products<span class="w"> </span>-s<span class="w"> </span>-F
<span class="c1"># send all snapshots incrementally</span>
<span class="nb">time</span><span class="w"> </span>zfs<span class="w"> </span>send<span class="w"> </span>-w<span class="w"> </span>-I<span class="w"> </span><span class="m">20230417</span>-0000<span class="w"> </span>zfs-hdd/<span class="nv">$SERVICE</span>/products@20230719-0930<span class="w"> </span><span class="p">|</span><span class="w"> </span>pv<span class="w"> </span><span class="p">|</span><span class="w"> </span>zfs<span class="w"> </span>recv<span class="w"> </span>zfs-nvme/<span class="nv">$SERVICE</span>/products<span class="w"> </span>-s
</code></pre></div></p>
<p>We do the same for <code>off-pro</code> (this time first snapshot was <code>20230418-0000</code> and last was <code>20230719-0930</code>)</p>
<h4 id="enabling-sync-again">enabling sync again<a class="headerlink" href="#enabling-sync-again" title="Permanent link">#</a></h4>
<p>On off1, we change the  <code>sto-products-sync.sh</code></p>
<ul>
<li>adding off2 IP back to<code>$REMOTE</code></li>
<li>using zfs-nvme instead of zfs-hdd</li>
</ul>
<p>After some time we verify it's working.</p>
<h4 id="changing-containers-mount-points">changing containers mount points<a class="headerlink" href="#changing-containers-mount-points" title="Permanent link">#</a></h4>
<p>As we did this operation, the lxc configuration for 113 and 114 where still using zfs-hdd mount points, we changed them to zfs-nvme for products.</p>
<h3 id="migrating-root-datasets-on-ovh3">migrating root datasets on ovh3<a class="headerlink" href="#migrating-root-datasets-on-ovh3" title="Permanent link">#</a></h3>
<p>If we want to synchronize off and off-pro root dataset, they have to be created by syncing from off2 to ovh3.
But as they already exists on ovh3, we have to create them, move products in them, and swap the old and the new one (avoiding doing so during a sync).</p>
<h4 id="prepare">prepare<a class="headerlink" href="#prepare" title="Permanent link">#</a></h4>
<p>Verify which datasets exists under the old root datasets on ovh3:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>zfs<span class="w"> </span>list<span class="w"> </span>-r<span class="w"> </span>rpool/off<span class="o">{</span>,-pro<span class="o">}</span>
NAME<span class="w">                        </span>USED<span class="w">  </span>AVAIL<span class="w">     </span>REFER<span class="w">  </span>MOUNTPOINT
rpool/off<span class="w">                  </span><span class="m">13</span>.9T<span class="w">  </span><span class="m">21</span>.8T<span class="w">      </span>272K<span class="w">  </span>/rpool/off
rpool/off-pro<span class="w">              </span><span class="m">34</span>.2G<span class="w">  </span><span class="m">21</span>.8T<span class="w">      </span>216K<span class="w">  </span>/rpool/off-pro
rpool/off-pro/products<span class="w">     </span><span class="m">34</span>.2G<span class="w">  </span><span class="m">21</span>.8T<span class="w">     </span><span class="m">25</span>.0G<span class="w">  </span>/rpool/off-pro/products
rpool/off/clones<span class="w">           </span><span class="m">1</span>.89G<span class="w">  </span><span class="m">21</span>.8T<span class="w">      </span>224K<span class="w">  </span>/rpool/off/clones
rpool/off/clones/images<span class="w">    </span><span class="m">1</span>.22G<span class="w">  </span><span class="m">21</span>.8T<span class="w">     </span><span class="m">10</span>.1T<span class="w">  </span>/rpool/off/clones/images
rpool/off/clones/orgs<span class="w">       </span>272K<span class="w">  </span><span class="m">21</span>.8T<span class="w">     </span><span class="m">51</span>.4M<span class="w">  </span>/rpool/off/clones/orgs
rpool/off/clones/products<span class="w">   </span>678M<span class="w">  </span><span class="m">21</span>.8T<span class="w">      </span>411G<span class="w">  </span>/rpool/off/clones/products
rpool/off/clones/users<span class="w">     </span><span class="m">5</span>.32M<span class="w">  </span><span class="m">21</span>.8T<span class="w">     </span><span class="m">3</span>.10G<span class="w">  </span>/rpool/off/clones/users
rpool/off/images<span class="w">           </span><span class="m">12</span>.0T<span class="w">  </span><span class="m">21</span>.8T<span class="w">     </span><span class="m">10</span>.6T<span class="w">  </span>/rpool/off/images
rpool/off/orgs<span class="w">             </span><span class="m">58</span>.0M<span class="w">  </span><span class="m">21</span>.8T<span class="w">     </span><span class="m">54</span>.2M<span class="w">  </span>/rpool/off/orgs
rpool/off/products<span class="w">         </span><span class="m">1</span>.88T<span class="w">  </span><span class="m">21</span>.8T<span class="w">      </span>430G<span class="w">  </span>/rpool/off/products
rpool/off/users<span class="w">            </span><span class="m">5</span>.20G<span class="w">  </span><span class="m">21</span>.8T<span class="w">     </span><span class="m">3</span>.18G<span class="w">  </span>/rpool/off/users
</code></pre></div>
<p>So we have to move products for off-pro, and for off we have to move products, images.</p>
<p><code>users</code> and <code>orgs</code> are just rsynced backup from off1, so we don't have to move them, we will just keep them until we re-create the clones that use them.</p>
<p>The problem now will be to pass between ZFS synchronizations.</p>
<h4 id="create-new-target-datasets">create new target datasets<a class="headerlink" href="#create-new-target-datasets" title="Permanent link">#</a></h4>
<p>On off2:</p>
<p><div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>syncoid<span class="w"> </span>--no-sync-snap<span class="w"> </span>zfs-hdd/off<span class="w">  </span>root@ovh3.openfoodfacts.org:rpool/off-new
sudo<span class="w"> </span>syncoid<span class="w"> </span>--no-sync-snap<span class="w"> </span>zfs-hdd/off-pro<span class="w">  </span>root@ovh3.openfoodfacts.org:rpool/off-pro-new
</code></pre></div>
it's very fast.</p>
<h4 id="move-off-pro-products-to-new-dataset-and-swap-datasets">move off-pro products to new dataset and swap datasets<a class="headerlink" href="#move-off-pro-products-to-new-dataset-and-swap-datasets" title="Permanent link">#</a></h4>
<p>on ovh3, we wait to have no off-pro sync running.</p>
<p><div class="highlight"><pre><span></span><code>zfs<span class="w"> </span>rename<span class="w"> </span>rpool/off-pro<span class="o">{</span>,-new<span class="o">}</span>/products<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
zfs<span class="w"> </span>rename<span class="w"> </span>rpool/off-pro<span class="o">{</span>,-old<span class="o">}</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
zfs<span class="w"> </span>rename<span class="w"> </span>rpool/off-pro<span class="o">{</span>-new,<span class="o">}</span>
</code></pre></div>
zfs-hdd/off/cache       140K  23.9T      140K  /zfs-hdd/off/cache
zfs-hdd/off/html_data   140K  23.9T      140K  /zfs-hdd/off/html_data
zfs-hdd/off/images     11.4T  23.9T     10.3T  /zfs-hdd/off/images
zfs-hdd/off/logs        140K  23.9T      140K  /zfs-hdd/off/logs
zfs-hdd/off/orgs        140K  23.9T      140K  /zfs-hdd/off/orgs
zfs-hdd/off/products    898G  23.9T      317G  /zfs-hdd/off/products
zfs-hdd/off/users      3.73G  23.9T     2.32G  /zfs-hdd/off/users</p>
<h4 id="moving-off-products-and-images-to-new-dataset-and-swapping">moving off products and images to new dataset and swapping<a class="headerlink" href="#moving-off-products-and-images-to-new-dataset-and-swapping" title="Permanent link">#</a></h4>
<p>As sync are taking a lot of time on products and images, we will disable them until we do the move</p>
<p>On off2, temporarily edit <code>/etc/sanoid/syncoid-args.conf</code> to remove the line corresponding to images.
On off1, temporarily edit <code>sto-products-sync.sh</code> and disable ovh3 target.</p>
<p>Wait until current syncs finishes (sto-products-sync.sh run newer than config change on off1 and syncoid run newer than config change on off2).</p>
<p>Because of clones, we also have to shutdown the off staging container which use those datasets. On off staging container (on ovh1):
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>/home/off/off-net/
sudo<span class="w"> </span>-u<span class="w"> </span>off<span class="w"> </span>docker-compose<span class="w"> </span>stop
</code></pre></div></p>
<p>And remove clones on ovh3:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># need this to clean stalled NFS connections</span>
systemctl<span class="w"> </span>restart<span class="w"> </span>nfs-server.service
zfs<span class="w"> </span>destroy<span class="w"> </span>rpool/off/clones/users
zfs<span class="w"> </span>destroy<span class="w"> </span>rpool/off/clones/products
zfs<span class="w"> </span>destroy<span class="w"> </span>rpool/off/clones/orgs
</code></pre></div>
<p>Then we do the move on ovh3:
<div class="highlight"><pre><span></span><code>zfs<span class="w"> </span>rename<span class="w"> </span>rpool/off<span class="o">{</span>,-new<span class="o">}</span>/products<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
zfs<span class="w"> </span>rename<span class="w"> </span>rpool/off<span class="o">{</span>,-new<span class="o">}</span>/images<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
zfs<span class="w"> </span>rename<span class="w"> </span>rpool/off<span class="o">{</span>,-new<span class="o">}</span>/clones<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
zfs<span class="w"> </span>rename<span class="w"> </span>rpool/off<span class="o">{</span>,-old<span class="o">}</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
zfs<span class="w"> </span>rename<span class="w"> </span>rpool/off<span class="o">{</span>-new,<span class="o">}</span>
</code></pre></div></p>
<p>Now we can re-enable syncoid on off2 and sto-products-sync off1.</p>
<h4 id="recreating-clones">Recreating clones<a class="headerlink" href="#recreating-clones" title="Permanent link">#</a></h4>
<p><strong>IMPORTANT</strong>: Before re-creating users and orgs and recreating clones, I follow the step to add users and orgs to syncoid and rsync users and orgs from prod (so that we have something worthful) (see <a href="#copying-users-and-orgs">copying users and orgs</a>).</p>
<p>I created the <code>off/clones</code> dataset and enable NFS share.
<div class="highlight"><pre><span></span><code>zfs<span class="w"> </span>create<span class="w"> </span>rpool/off/clones
zfs<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">sharenfs</span><span class="o">=</span><span class="s2">&quot;rw=@10.0.0.1/32,rw=@10.1.0.200/32,no_root_squash&quot;</span><span class="w"> </span>rpool/off/clones
</code></pre></div>
Then I manually created the clones following the <code>maj-clones-nfs-VM-dockers.sh</code> script.</p>
<p>I then restart the docker compose on off-net.</p>
<h4 id="setup-sync">setup sync<a class="headerlink" href="#setup-sync" title="Permanent link">#</a></h4>
<p>We can now sync them regularly by editing <code>/etc/sanoid/syncoid-args.conf</code>:</p>
<div class="highlight"><pre><span></span><code># off
--no-sync-snap zfs-hdd/opf root@ovh3.openfoodfacts.org:rpool/opf
# off-pro
--no-sync-snap zfs-hdd/$SERVICE root@ovh3.openfoodfacts.org:rpool/$SERVICE
</code></pre></div>
<p>I also added it to <code>sanoid.conf</code> ovh3, but using synced template.</p>
<h3 id="copying-users-and-orgs">Copying users and orgs<a class="headerlink" href="#copying-users-and-orgs" title="Permanent link">#</a></h3>
<p>I already have setup syncoid on off2 to sync users and orgs to ovh3:</p>
<p>On off2 (in a screen), as root:</p>
<p><div class="highlight"><pre><span></span><code><span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off/users<span class="w">  </span>/zfs-hdd/off/users<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off/orgs<span class="w">  </span>/zfs-hdd/off/orgs
</code></pre></div>
this took a few minutes.</p>
<p>I was lucky enough that syncoid just started at this very moment and let it finish.</p>
<p>After checking sync did happen correctly (<code>zfs list -t snap rpool/off/{orgs,users} &amp;&amp; ls rpool/off/{orgs,users}</code>), we can also remove old <code>users</code> and <code>orgs</code> from the old off dataset on ovh3:
<div class="highlight"><pre><span></span><code>zfs<span class="w"> </span>destroy<span class="w"> </span>rpool/off-old/<span class="o">{</span>users,orgs<span class="o">}</span>
</code></pre></div>
and as they were the last, also removed <code>rpool/off-old</code></p>
<p>I also decided to temporarily do a regular rsync of users and orgs through a cron on off1.</p>
<p>I added it to root crontab on off1:</p>
<div class="highlight"><pre><span></span><code># rsync users and orgs to off2 every hour
48 * * * *  rsync -a /srv/off/users/ 10.0.0.2:/zfs-hdd/off/users/; rsync -a /srv/off/orgs/ 10.0.0.2:/zfs-hdd/off/orgs/
</code></pre></div>
<h3 id="copying-off-pro-images">Copying off-pro images<a class="headerlink" href="#copying-off-pro-images" title="Permanent link">#</a></h3>
<div class="highlight"><pre><span></span><code><span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv2/off-pro/html/images/products<span class="w"> </span>/zfs-hdd/off-pro/images/
</code></pre></div>
<h3 id="copying-other-data">Copying other data<a class="headerlink" href="#copying-other-data" title="Permanent link">#</a></h3>
<p>I rsync cache data and other data on ofF2:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># cache</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off/<span class="o">{</span>build-cache,tmp,debug,new_images<span class="o">}</span><span class="w"> </span>/zfs-hdd/off/cache/
<span class="c1"># for off-pro I don&#39;t copy new_images as it&#39;s really full and non working ! (takes 18m)</span>
<span class="c1"># don&#39;t copy export_files it&#39;s really transient data</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off-pro/<span class="o">{</span>build-cache,tmp,debug<span class="o">}</span><span class="w"> </span>/zfs-hdd/off-pro/cache/
mkdir<span class="w"> </span>/zfs-hdd/off-pro/cache/new_imaqes
mkdir<span class="w"> </span>/zfs-hdd/off-pro/cache/export_files
mkdir<span class="w"> </span>/zfs-hdd/off/cache/export_files
mkdir<span class="w"> </span>/zfs-hdd/off/cache/export_files
mkdir<span class="w"> </span>/zfs-hdd/off/cache/export_files

chown<span class="w"> </span>-R<span class="w"> </span><span class="m">1000</span>:1000<span class="w"> </span>/zfs-hdd/off<span class="o">{</span>,-pro<span class="o">}</span>/cache

<span class="c1"># data folder (we do not copy data from off-pro for it&#39;s shared with off)</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off/data<span class="w"> </span>/zfs-hdd/off/
<span class="c1"># other</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off/<span class="o">{</span>deleted.images,deleted_products,deleted_products_images<span class="o">}</span><span class="w"> </span>/zfs-hdd/off/
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off-pro/<span class="o">{</span>deleted.images,deleted_private_products<span class="o">}</span><span class="w"> </span>/zfs-hdd/off-pro/
<span class="c1"># imports are on srv2 and only for off</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv2/off/imports<span class="w"> </span>/zfs-hdd/off/
<span class="c1"># translations on off</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off/translate<span class="w"> </span>/zfs-hdd/off/
<span class="c1"># reverted_products on off</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off/reverted_products<span class="w"> </span>/zfs-hdd/off/

<span class="c1"># html/data, took 158 and 214 mins for off, fast for off-pro</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off/html/data/<span class="w"> </span>/zfs-hdd/off/html_data
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off/html/<span class="o">{</span>files,exports<span class="o">}</span><span class="w"> </span>/zfs-hdd/off/html_data/
<span class="c1"># dump is on srv2</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv2/off/html/dump<span class="w"> </span>/zfs-hdd/off/html_data/

<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off-pro/html/data/<span class="w"> </span>/zfs-hdd/off-pro/html_data
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off-pro/html/files<span class="w"> </span>/zfs-hdd/off-pro/html_data/
<span class="c1"># some folder that will be needed but are empty for now</span>
mkdir<span class="w"> </span>/zfs-hdd/off/deleted_private_products
mkdir<span class="w"> </span>/zfs-hdd/off-pro/deleted_products
mkdir<span class="w"> </span>/zfs-hdd/off-pro/deleted_products_images
mkdir<span class="w"> </span>/zfs-hdd/off-pro/imports
mkdir<span class="w"> </span>/zfs-hdd/off-pro/reverted_products
mkdir<span class="w"> </span>/zfs-hdd/off-pro/translate
chown<span class="w"> </span><span class="m">1000</span>:1000<span class="w"> </span>/zfs-hdd/off/deleted_private_products<span class="w"> </span>/zfs-hdd/off-pro/<span class="o">{</span>deleted_products,deleted_products_images,imports<span class="o">}</span>
</code></pre></div>
<p>I already add them to <code>/etc/sanoid/syncoid-args.conf</code> so sync will happen.</p>
<p>And on ovh3 add them to <code>sanoid.conf</code> with <code>synced_data</code> template</p>
<h3 id="copying-secrets">Copying secrets<a class="headerlink" href="#copying-secrets" title="Permanent link">#</a></h3>
<p>We will put secrets in private data dir.</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>/zfs-hdd/off-pro/secrets

<span class="c1"># ftp secrets for producers</span>
rsync<span class="w"> </span><span class="m">10</span>.0.0.1:/home/off/.netrc<span class="w"> </span>/zfs-hdd/off-pro/secrets

<span class="c1"># ensure secrets</span>
chown<span class="w"> </span><span class="m">1000</span>:1000<span class="w"> </span>-R<span class="w"> </span>/zfs-hdd/off-pro/secrets
chmod<span class="w"> </span>go-rwx<span class="w"> </span>-R<span class="w"> </span>/zfs-hdd/off-pro/secrets
</code></pre></div>
<h3 id="how-much-sugar-data">How much sugar data<a class="headerlink" href="#how-much-sugar-data" title="Permanent link">#</a></h3>
<p>We will put html files of How much sugar in html_data volume as those file are kind of data (they are generated by a script), and the sto in private data</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>/zfs-hdd/off/html_data/sugar/<span class="o">{</span>en,fr<span class="o">}</span>
rsync<span class="w"> </span>-a<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/sugar/html/<span class="w"> </span>/zfs-hdd/off/html_data/sugar/en
rsync<span class="w"> </span>-a<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/sucres/html/<span class="w"> </span>/zfs-hdd/off/html_data/sugar/fr
mkdir<span class="w"> </span>-p<span class="w"> </span>/zfs-hdd/off/data/sugar/<span class="o">{</span>en,fr<span class="o">}</span>
rsync<span class="w"> </span>-a<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/sugar/data/<span class="w"> </span>/zfs-hdd/off/data/sugar/en/
rsync<span class="w"> </span>-a<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/sucres/data/<span class="w"> </span>/zfs-hdd/off/data/sugar/fr/
rsync<span class="w"> </span>-a<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/sugar/logs/sugar_log<span class="w"> </span>/zfs-hdd/off/data/sugar/old_en_sugar_log
rsync<span class="w"> </span>-a<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/sucres/logs/sugar_log<span class="w"> </span>/zfs-hdd/off/data/sugar/old_fr_sucres_log
chown<span class="w"> </span>-R<span class="w"> </span><span class="m">1000</span>:1000<span class="w"> </span>/zfs-hdd/off/html_data/sugar<span class="w"> </span>/zfs-hdd/off/data/sugar/
</code></pre></div>
<h3 id="logs">logs<a class="headerlink" href="#logs" title="Permanent link">#</a></h3>
<p>We rsync old logs in a separate files</p>
<p>Old logs were copied to ovh3:/rpool/backups/off1/srv/off/logs</p>
<h2 id="creating-containers">Creating Containers<a class="headerlink" href="#creating-containers" title="Permanent link">#</a></h2>
<p>I created a CT for OFF followings <a href="../../proxmox/#how-to-create-a-new-container">How to create a new Container</a> it went all smooth.
I choosed a 30Gb disk, 0B swap, 8 Cores and 40 Gb memory.</p>
<p>Note that my first container creation failed because unable to mount the ZFS volume ("zfs dataset is busy"), I had to destroy the dataset and re-create the container.</p>
<p>I also <a href="../mail#postfix-configuration">configure postfix</a> and tested it.</p>
<p><strong>Important:</strong> do not create any user until you changed id maping in lxc conf (see <a href="#mounting-volumes">Mounting volumes</a>). And also think about creating off user before any other user to avoid having to change users uids, off must have uid 1000.</p>
<h3 id="installing-generic-packages">Installing generic packages<a class="headerlink" href="#installing-generic-packages" title="Permanent link">#</a></h3>
<p>I also installed generic packages:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>apache2<span class="w"> </span>apt-utils<span class="w"> </span>g++<span class="w"> </span>gcc<span class="w"> </span>less<span class="w"> </span>make<span class="w"> </span>gettext<span class="w"> </span>wget<span class="w"> </span>vim
</code></pre></div>
<h3 id="geoip-with-updates">Geoip with updates<a class="headerlink" href="#geoip-with-updates" title="Permanent link">#</a></h3>
<p>Installed geoip with updates, and copied <code>/etc/GeoIP.conf</code> from opff:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>geoipupdate
vim<span class="w"> </span>/etc/GeoIP.conf

sudo<span class="w"> </span>chmod<span class="w"> </span>o-rwx<span class="w"> </span>/etc/GeoIP.conf
</code></pre></div></p>
<p>Test it:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>geoipupdate.service
sudo<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>geoipupdate.service

juin<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">16</span>:18:34<span class="w"> </span><span class="nv">$SERVICE</span><span class="w"> </span>systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>geoipupdate.service:<span class="w"> </span>Succeeded.
juin<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">16</span>:18:34<span class="w"> </span><span class="nv">$SERVICE</span><span class="w"> </span>systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>Finished<span class="w"> </span>Weekly<span class="w"> </span>GeoIP<span class="w"> </span>update.
juin<span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">16</span>:18:34<span class="w"> </span><span class="nv">$SERVICE</span><span class="w"> </span>systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>geoipupdate.service:<span class="w"> </span>Consumed<span class="w"> </span><span class="m">3</span>.231s<span class="w"> </span>CPU<span class="w"> </span>time.

</code></pre></div></p>
<h3 id="clone-off-as-off-pro">Clone off as off-pro<a class="headerlink" href="#clone-off-as-off-pro" title="Permanent link">#</a></h3>
<p>I then shutdow the $SERVICE VM and clone it as off-pro.</p>
<p>After cloning I changes to 4 cores and 6 Gb memory. change network IP address settings before starting.</p>
<h3 id="installing-packages">Installing packages<a class="headerlink" href="#installing-packages" title="Permanent link">#</a></h3>
<p>On off and off-pro (taken from Dockerfile)</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w">  </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>apache2<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>apt-utils<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>cpanminus<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>g++<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>gcc<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>less<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libapache2-mod-perl2<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>make<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>gettext<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>wget<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>imagemagick<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>graphviz<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>tesseract-ocr<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>lftp<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>gzip<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>tar<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>unzip<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>zip<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libtie-ixhash-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libwww-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libimage-magick-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libxml-encoding-perl<span class="w">  </span><span class="se">\</span>
<span class="w">   </span>libtext-unaccent-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libmime-lite-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libcache-memcached-fast-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libjson-pp-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libclone-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libcrypt-passwdmd5-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libencode-detect-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libgraphics-color-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libbarcode-zbar-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libxml-feedpp-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>liburi-find-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libxml-simple-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libexperimental-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libapache2-request-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libdigest-md5-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libtime-local-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libdbd-pg-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libtemplate-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>liburi-escape-xs-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libmath-random-secure-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libfile-copy-recursive-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libemail-stuffer-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>liblist-moreutils-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libexcel-writer-xlsx-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libpod-simple-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>liblog-any-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>liblog-log4perl-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>liblog-any-adapter-log4perl-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libgeoip2-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libemail-valid-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libmath-fibonacci-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libev-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libprobe-perl-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libmath-round-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libsoftware-license-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libtest-differences-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libtest-exception-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libmodule-build-pluggable-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libclass-accessor-lite-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libclass-singleton-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libfile-sharedir-install-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libnet-idn-encode-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libtest-nowarnings-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libfile-chmod-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libdata-dumper-concise-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libdata-printer-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libdata-validate-ip-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libio-compress-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libjson-maybexs-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>liblist-allutils-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>liblist-someutils-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libdata-section-simple-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libfile-which-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libipc-run3-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>liblog-handler-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libtest-deep-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libwant-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libfile-find-rule-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>liblinux-usermod-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>liblocale-maketext-lexicon-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>liblog-any-adapter-tap-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libcrypt-random-source-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libmath-random-isaac-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libtest-sharedfork-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libtest-warn-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libsql-abstract-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libauthen-sasl-saslprep-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libauthen-scram-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libbson-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libclass-xsaccessor-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libconfig-autoconf-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libdigest-hmac-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libpath-tiny-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libsafe-isa-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libspreadsheet-parseexcel-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libtest-number-delta-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libdevel-size-perl<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>gnumeric<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libreadline-dev<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libperl-dev<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>libapache2-mod-perl2-dev
</code></pre></div>
<h2 id="mounting-volumes">Mounting volumes<a class="headerlink" href="#mounting-volumes" title="Permanent link">#</a></h2>
<p>In our target production we will have everything in off2,
so we cross mount their products and images volumes.</p>
<p>We will change config for opff, opf and $SERVICE at migration time.</p>
<h3 id="changing-lxc-confs">changing lxc confs<a class="headerlink" href="#changing-lxc-confs" title="Permanent link">#</a></h3>
<p>On off2.</p>
<p>So for off, editing <code>/etc/pve/lxc/113.conf</code>:
<div class="highlight"><pre><span></span><code>mp0: /zfs-hdd/off,mp=/mnt/off
mp1: /zfs-nvme/off/products,mp=/mnt/off/products
mp2: /zfs-hdd/off/users,mp=/mnt/off-pro/users
mp3: /zfs-hdd/off/orgs,mp=/mnt/off/orgs
mp4: /zfs-hdd/off/images,mp=/mnt/off/images
mp5: /zfs-hdd/off/html_data,mp=/mnt/off/html_data
mp6: /zfs-hdd/off/cache,mp=/mnt/off/cache
mp7: /zfs-hdd/$SERVICE/products,mp=/mnt/$SERVICE/products
mp8: /zfs-hdd/$SERVICE/images,mp=/mnt/$SERVICE/images
mp9: /zfs-hdd/opff/products,mp=/mnt/opff/products
mp10: /zfs-hdd/opff/images,mp=/mnt/opff/images
mp11: /zfs-hdd/opf/products,mp=/mnt/opf/products
mp12: /zfs-hdd/opf/images,mp=/mnt/opf/images
mp13: /zfs-hdd/off/logs,mp=/mnt/off/logs
mp14: /zfs-hdd/off-pro/cache/export_files,mp=/mnt/off-pro/cache/export_files
mp15: /zfs-hdd/off-pro/images,mp=/mnt/off-pro/images

lxc.idmap: u 0 100000 999
lxc.idmap: g 0 100000 999
lxc.idmap: u 1000 1000 10
lxc.idmap: g 1000 1000 10
lxc.idmap: u 1011 101011 64525
lxc.idmap: g 1011 101011 64525
</code></pre></div></p>
<div class="highlight"><pre><span></span><code>pct<span class="w"> </span>reboot<span class="w"> </span><span class="m">113</span>
</code></pre></div>
<p>for off-pro we don't need to cross mount the other platforms, but we need to share <code>off/data</code> folder !
and also <code>off/products</code> (because of <code>internal_code.sto</code>)
editing <code>/etc/pve/lxc/114.conf</code>:
<div class="highlight"><pre><span></span><code>mp0: /zfs-hdd/off-pro,mp=/mnt/off-pro
mp1: /zfs-nvme/off-pro/products,mp=/mnt/off-pro/products
mp10: /zfs-nvme/off/products,mp=/mnt/off/products
mp2: /zfs-hdd/off/users,mp=/mnt/off-pro/users
mp3: /zfs-hdd/off/orgs,mp=/mnt/off-pro/orgs
mp4: /zfs-hdd/off-pro/images,mp=/mnt/off-pro/images
mp5: /zfs-hdd/off-pro/html_data,mp=/mnt/off-pro/html_data
mp6: /zfs-hdd/off-pro/cache,mp=/mnt/off-pro/cache
mp7: /zfs-hdd/off/data,mp=/mnt/off-pro/data
mp8: /zfs-hdd/off-pro/sftp,mp=/mnt/off-pro/sftp
mp9: /zfs-hdd/off-pro/logs,mp=/mnt/off-pro/logs

lxc.idmap: u 0 100000 999
lxc.idmap: g 0 100000 999
lxc.idmap: u 1000 1000 10
lxc.idmap: g 1000 1000 10
lxc.idmap: u 1011 101011 64525
lxc.idmap: g 1011 101011 64525
</code></pre></div></p>
<div class="highlight"><pre><span></span><code>pct<span class="w"> </span>reboot<span class="w"> </span><span class="m">114</span>
</code></pre></div>
<p><strong>Warning</strong>: after changing lxc idmap, the alex user which I already created, now as an id which is not mapped correctly. More over it was a mistake to create it immediatly as it have id 1000, which should be reserved to <em>off</em> user. This makes it impossible to log with ssh as .ssh/authorized_keys is not readable !</p>
<p>To remedy that, on $SERVICE and opf, using pct enter 111/2, we will also create off user:
<div class="highlight"><pre><span></span><code>usermod<span class="w"> </span>-u<span class="w"> </span><span class="m">1001</span><span class="w"> </span>alex
groupmod<span class="w"> </span>-g<span class="w"> </span><span class="m">1001</span><span class="w"> </span>alex
adduser<span class="w"> </span>--uid<span class="w"> </span><span class="m">1000</span><span class="w"> </span>off
</code></pre></div>
And then from off2, we will change ownership on the mounted ZFS dataset.
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>chown<span class="w"> </span><span class="m">1001</span>:1001<span class="w"> </span>-R<span class="w"> </span>/zfs-hdd/pve/subvol-11<span class="o">{</span><span class="m">1</span>,2<span class="o">}</span>-disk-0/home/alex
</code></pre></div></p>
<h3 id="create-off-user_1">Create off user<a class="headerlink" href="#create-off-user_1" title="Permanent link">#</a></h3>
<p>This is the first user to create so that it got 1000 uid.</p>
<p>On off and off-pro</p>
<div class="highlight"><pre><span></span><code>adduser<span class="w"> </span>off
</code></pre></div>
<h2 id="getting-the-code">Getting the code<a class="headerlink" href="#getting-the-code" title="Permanent link">#</a></h2>
<h3 id="copying-production-code">Copying production code<a class="headerlink" href="#copying-production-code" title="Permanent link">#</a></h3>
<p>I started by copying current code from off1 to each container, while avoiding data. I put code in <code>/srv/off-old/</code> and <code>/srv/off-pro-old/</code> so that I can easily compare to git code later on.</p>
<h4 id="verifying-what-to-exclude">Verifying what to exclude<a class="headerlink" href="#verifying-what-to-exclude" title="Permanent link">#</a></h4>
<p>I first did the rsync but got the disks completely full ! So I gave a better look at disk usage on off1:</p>
<p>For off:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>du<span class="w"> </span>-sh<span class="w"> </span>-x<span class="w"> </span>/srv/off/*<span class="p">|</span>sort<span class="w"> </span>-h

493M<span class="w">    </span>/srv/off/taxonomies
606M<span class="w">    </span>/srv/off/build-cache
662M<span class="w">    </span>/srv/off/users<span class="w">  </span><span class="c1"># this will go in zfs</span>
878M<span class="w">    </span>/srv/off/data<span class="w">  </span><span class="c1"># this will go in zfs </span>
<span class="m">1</span>.4G<span class="w">    </span>/srv/off/lists<span class="w">  </span><span class="c1"># those are html files generated on facets ?</span>
<span class="m">3</span>.0G<span class="w">    </span>/srv/off/deleted.images<span class="w">  </span><span class="c1"># if we keep them it should go it data</span>
<span class="m">4</span>.9G<span class="w">    </span>/srv/off/debug
<span class="m">6</span>.2G<span class="w">    </span>/srv/off/scripts<span class="w"> </span><span class="c1"># see below</span>
<span class="m">7</span>.7G<span class="w">    </span>/srv/off/tmp<span class="w">  </span><span class="c1"># we can ditch, I suppose !</span>
191G<span class="w">    </span>/srv/off/html<span class="w">  </span><span class="c1"># see below</span>
<span class="m">1</span>.8T<span class="w">    </span>/srv/off/logs<span class="w">  </span><span class="c1"># no need to carry arround --&gt; SHOULD also be a specific volume maybe in zfs ?</span>

<span class="c1"># what makes html so big ?</span>
410M<span class="w">    </span>/srv/off/html/js
844M<span class="w">    </span>/srv/off/html/illustrations<span class="w">  </span><span class="c1"># not in git</span>
1001M<span class="w">   </span>/srv/off/html/images<span class="w">  </span><span class="c1"># a lot of files not in git</span>
24G<span class="w"> </span>/srv/off/html/files<span class="w">  </span><span class="c1"># should be in data</span>
165G<span class="w">    </span>/srv/off/html/exports<span class="w">  </span><span class="c1"># should be in data</span>
<span class="c1"># what makes htm/files so big ?</span>
527M<span class="w">    </span>/srv/off/html/files/mongod.20181230.log.gz
1003M<span class="w">   </span>/srv/off/html/files/annotate
<span class="m">1</span>.7G<span class="w">    </span>/srv/off/html/files/debug
<span class="m">2</span>.0G<span class="w">    </span>/srv/off/html/files/presskit
<span class="m">4</span>.5G<span class="w">    </span>/srv/off/html/files/best_remap
<span class="m">5</span>.9G<span class="w">    </span>/srv/off/html/files/300.tar.gz
<span class="m">5</span>.9G<span class="w">    </span>/srv/off/html/files/products-20200324-890.tar.gz

<span class="c1"># what makes scripts so big ?</span>
102M<span class="w">    </span>/srv/off/scripts/x
144M<span class="w">    </span>/srv/off/scripts/scanbot.2020
485M<span class="w">    </span>/srv/off/scripts/scanbot.old
868M<span class="w">    </span>/srv/off/scripts/best_remap_202105_fr.filtered2.csv
951M<span class="w">    </span>/srv/off/scripts/bak
<span class="m">1</span>.3G<span class="w">    </span>/srv/off/scripts/best_remap_202105_fr.filtered.csv
<span class="m">1</span>.3G<span class="w">    </span>/srv/off/scripts/best_remap_202105_fr.unfiltered.csv
</code></pre></div></p>
<p>For off-pro
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>du<span class="w"> </span>-sh<span class="w"> </span>-x<span class="w"> </span>/srv/off-pro/*<span class="p">|</span>sort<span class="w"> </span>-h

191M<span class="w">    </span>/srv/off-pro/debug<span class="w">  </span><span class="c1"># avoid it</span>
273M<span class="w">    </span>/srv/off-pro/node_modules.old<span class="w"> </span><span class="c1"># no need</span>
276M<span class="w">    </span>/srv/off-pro/node_modules<span class="w"> </span><span class="c1"># no need</span>
295M<span class="w">    </span>/srv/off-pro/build-cache<span class="w"> </span><span class="c1"># goes in zfs</span>
364M<span class="w">    </span>/srv/off-pro/html
885M<span class="w">    </span>/srv/off-pro/new_images<span class="w"> </span><span class="c1"># should not be so big ! do not take it - we need the incron for it ?</span>
<span class="m">1</span>.4G<span class="w">    </span>/srv/off-pro/export_files<span class="w">  </span><span class="c1"># should go in zfs</span>
<span class="m">7</span>.6G<span class="w">    </span>/srv/off-pro/deleted.images<span class="w">  </span><span class="c1"># Not sure what to do</span>
28G<span class="w"> </span>/srv/off-pro/tmp<span class="w">  </span><span class="c1"># ditch it !</span>
47G<span class="w"> </span>/srv/off-pro/logs<span class="w">  </span><span class="c1"># no need, but logs should however go in zfs</span>
60G<span class="w"> </span>/srv/off-pro/import_files<span class="w">  </span><span class="c1"># should be in data zfs volume</span>
138G<span class="w">    </span>/srv/off-pro/deleted_private_products
</code></pre></div></p>
<h4 id="copying-code">Copying code<a class="headerlink" href="#copying-code" title="Permanent link">#</a></h4>
<p>On off2 as root:
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>/zfs-hdd/pve/subvol-113-disk-0/srv/off-old/
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>-x<span class="w"> </span>-a<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;logs/&quot;</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;html/images/products/&quot;</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;html/data&quot;</span><span class="w"> </span>--exclude<span class="o">=</span><span class="s2">&quot;html/illustrations&quot;</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;html/files&quot;</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;html/exports&quot;</span><span class="w">  </span>--exclude<span class="w"> </span><span class="s2">&quot;scripts/*.csv&quot;</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;deleted.images&quot;</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;tmp/&quot;</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;new_images/&quot;</span><span class="w"> </span>--exclude<span class="o">=</span><span class="s2">&quot;build-cache&quot;</span><span class="w"> </span>--exclude<span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="w"> </span>--exclude<span class="o">=</span><span class="s2">&quot;node_modules&quot;</span><span class="w"> </span>--exclude<span class="o">=</span><span class="s2">&quot;node_modules.old&quot;</span><span class="w"> </span>--exclude<span class="o">=</span><span class="s2">&quot;users&quot;</span><span class="w"> </span>--exclude<span class="o">=</span><span class="s2">&quot;lists&quot;</span><span class="w"> </span>--exclude<span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="w"> </span>--exclude<span class="o">=</span><span class="s2">&quot;orgs&quot;</span><span class="w">  </span>off1.openfoodfacts.org:/srv/off/<span class="w"> </span>/zfs-hdd/pve/subvol-113-disk-0/srv/off-old/
<span class="c1"># took 121m</span>
<span class="c1"># there are some permissions problems</span>
<span class="nb">time</span><span class="w"> </span>sudo<span class="w"> </span>chown<span class="w"> </span><span class="m">1000</span>:1000<span class="w"> </span>-R<span class="w"> </span>/zfs-hdd/pve/subvol-113-disk-0/srv/off-old/

mkdir<span class="w"> </span>/zfs-hdd/pve/subvol-114-disk-0/srv/off-pro-old/
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>-x<span class="w"> </span>-a<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;logs/&quot;</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;html/images/products/&quot;</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;html/data&quot;</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;html/&quot;</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;deleted.images&quot;</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;tmp/&quot;</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;debug/&quot;</span><span class="w"> </span>--exclude<span class="o">=</span><span class="s2">&quot;node_modules&quot;</span><span class="w"> </span>--exclude<span class="o">=</span><span class="s2">&quot;node_modules.old&quot;</span><span class="w">   </span>--exclude<span class="w"> </span><span class="s2">&quot;new_images/&quot;</span><span class="w"> </span>--exclude<span class="o">=</span><span class="s2">&quot;build-cache&quot;</span><span class="w"> </span>--exclude<span class="o">=</span><span class="s2">&quot;users&quot;</span><span class="w"> </span>--exclude<span class="o">=</span><span class="s2">&quot;orgs&quot;</span><span class="w"> </span>--exclude<span class="o">=</span><span class="s2">&quot;import_files&quot;</span><span class="w"> </span>--exclude<span class="o">=</span><span class="s2">&quot;deleted_private_products&quot;</span><span class="w"> </span>--exclude<span class="o">=</span><span class="s2">&quot;export_files&quot;</span><span class="w"> </span>off1.openfoodfacts.org:/srv/off-pro/<span class="w"> </span>/zfs-hdd/pve/subvol-114-disk-0/srv/off-pro-old/
<span class="c1"># there are some permissions problems</span>
<span class="nb">time</span><span class="w"> </span>sudo<span class="w"> </span>chown<span class="w"> </span><span class="m">1000</span>:1000<span class="w"> </span>-R<span class="w"> </span>/zfs-hdd/pve/subvol-114-disk-0/srv/off-pro-old/
</code></pre></div></p>
<h3 id="cloning-off-server-repository">Cloning off-server repository<a class="headerlink" href="#cloning-off-server-repository" title="Permanent link">#</a></h3>
<p>First I create a key for off to access off-server repo:
<div class="highlight"><pre><span></span><code><span class="c1"># off or off-pro</span>
<span class="nv">SERVICE</span><span class="o">=</span>off
sudo<span class="w"> </span>-u<span class="w"> </span>off<span class="w"> </span>ssh-keygen<span class="w"> </span>-f<span class="w"> </span>/home/off/.ssh/github_off-server<span class="w"> </span>-t<span class="w"> </span>ed25519<span class="w"> </span>-C<span class="w"> </span><span class="s2">&quot;off+off-server@</span><span class="nv">$SERVICE</span><span class="s2">.openfoodfacts.org&quot;</span>
sudo<span class="w"> </span>-u<span class="w"> </span>off<span class="w"> </span>vim<span class="w"> </span>/home/off/.ssh/config

<span class="c1"># deploy key for openfoodfacts-server</span>
Host<span class="w"> </span>github.com-off-server
<span class="w">        </span>Hostname<span class="w"> </span>github.com
<span class="w">        </span><span class="nv">IdentityFile</span><span class="o">=</span>/home/off/.ssh/github_off-server

cat<span class="w"> </span>/home/off/.ssh/github_off-server.pub
</code></pre></div></p>
<p>Go to github add the off pub key for off to <a href="https://github.com/openfoodfacts/openfoodfacts-server/settings/keys">productopener repository</a> with write access:</p>
<p>Then clone repository, on off:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>mkdir<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>
sudo<span class="w"> </span>chown<span class="w"> </span>off:off<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>
sudo<span class="w"> </span>-u<span class="w"> </span>off<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>git@github.com-off-server:openfoodfacts/openfoodfacts-server.git<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>
sudo<span class="w"> </span>-u<span class="w"> </span>off<span class="w"> </span>git<span class="w"> </span>config<span class="w"> </span>pull.ff<span class="w"> </span>only
</code></pre></div>
<p>Make it shared:
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>/srv/<span class="nv">$SERVICE</span>
sudo<span class="w"> </span>-u<span class="w"> </span>off<span class="w"> </span>git<span class="w"> </span>config<span class="w"> </span>core.sharedRepository<span class="w"> </span><span class="nb">true</span>
sudo<span class="w"> </span>chmod<span class="w"> </span>g+rwX<span class="w"> </span>-R<span class="w"> </span>.
</code></pre></div></p>
<p>I will generaly work to modify / commit to the repository using my user alex, while using off only to push.
So as alex on off / off-pro:
<div class="highlight"><pre><span></span><code>git config --global --add safe.directory /srv/$SERVICE
git config --global --add author.name &quot;Alex Garel&quot;
git config --global --add author.email &quot;alex@openfoodfacts.org&quot;
git config --global --add user.name &quot;Alex Garel&quot;
git config --global --add user.email &quot;alex@openfoodfacts.org&quot;
</code></pre></div></p>
<p>Do the same on off-pro.</p>
<h3 id="finding-git-commit">Finding git commit<a class="headerlink" href="#finding-git-commit" title="Permanent link">#</a></h3>
<p>Contrary to $SERVICE, opf and opff we don't have to do this, as we know we are on the last version !</p>
<h3 id="finding-difference-with-prod">Finding difference with prod<a class="headerlink" href="#finding-difference-with-prod" title="Permanent link">#</a></h3>
<p>diff -r -u  --exclude "logs/" --exclude "html/images/products/" --exclude "html/data" --exclude="html/illustrations" --exclude "html/files" --exclude "html/exports"  --exclude "scripts/*.csv" --exclude "deleted.images" --exclude "tmp/" --exclude "new_images/" --exclude="build-cache" --exclude="debug" --exclude="node_modules" --exclude="node_modules.old" --exclude="users" --exclude="lists" --exclude="data" --exclude="orgs" --exclude="html/images/products" --exclude=".git" /home/off/openfoodfacts-server /srv/off &gt; /tmp/off-diff.patch</p>
<h2 id="installing">Installing<a class="headerlink" href="#installing" title="Permanent link">#</a></h2>
<h3 id="symlinks-to-mimic-old-structure">symlinks to mimic old structure<a class="headerlink" href="#symlinks-to-mimic-old-structure" title="Permanent link">#</a></h3>
<p>Now we create symlinks to mimic old structure so that we can move products between instances:</p>
<p>On off, as root:
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span>site<span class="w"> </span><span class="k">in</span><span class="w"> </span>o<span class="o">{</span>b,p,pf<span class="o">}</span>f<span class="p">;</span><span class="k">do</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/srv/<span class="nv">$site</span>/html/images/<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>chown<span class="w"> </span>-R<span class="w"> </span>off:off<span class="w"> </span>-R<span class="w"> </span>/srv/<span class="nv">$site</span>/<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>

<span class="w">  </span>ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$site</span>/products<span class="w"> </span>/srv/<span class="nv">$site</span>/products<span class="p">;</span><span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$site</span>/images/products<span class="w"> </span>/srv/<span class="nv">$site</span>/html/images/products<span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="k">done</span>
ls<span class="w"> </span>-l<span class="w"> </span>/srv/o<span class="o">{</span>b,p,pf<span class="o">}</span>f/<span class="w"> </span>/srv/o<span class="o">{</span>b,p,pf<span class="o">}</span>f/html/images
</code></pre></div></p>
<p>We don't need it for off-pro</p>
<h3 id="linking-data">linking data<a class="headerlink" href="#linking-data" title="Permanent link">#</a></h3>
<p>Unless stated otherwise operation are done with user off.</p>
<p>Create links for users, orgs and products</p>
<div class="highlight"><pre><span></span><code><span class="c1"># off or off-pro</span>
<span class="nv">SERVICE</span><span class="o">=</span>off
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/products<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/products
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/users<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/users
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/orgs<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/orgs
<span class="c1"># verify</span>
ls<span class="w"> </span>-l<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/products<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/users<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/orgs<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/data
</code></pre></div>
<p>Create links for data folders:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># off or off-pro</span>
<span class="nv">SERVICE</span><span class="o">=</span>off
<span class="c1"># html data</span>
mv<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/html/data/data-fields.*<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/html_data/
rmdir<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/html/data
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/html_data<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/html/data
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/html_data/exports<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/html/exports
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/html_data/dump<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/html/dump
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/html_data/files<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/html/files
<span class="c1"># product images</span>
rm<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/html/images/products/.empty<span class="p">;</span><span class="w"> </span>rmdir<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/html/images/products/
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/images/products<span class="w">  </span>/srv/<span class="nv">$SERVICE</span>/html/images/products
<span class="c1"># verify</span>
ls<span class="w"> </span>-ld<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/html/images/products<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/html/<span class="o">{</span>data,exports,dump,files<span class="o">}</span>
</code></pre></div>
<p>some direct links:
<div class="highlight"><pre><span></span><code><span class="c1"># off or off-pro</span>
<span class="nv">SERVICE</span><span class="o">=</span>off

ln<span class="w"> </span>-s<span class="w">  </span>/mnt/<span class="nv">$SERVICE</span>/deleted.images<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>
ln<span class="w"> </span>-s<span class="w">  </span>/mnt/<span class="nv">$SERVICE</span>/deleted_products<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>
ln<span class="w"> </span>-s<span class="w">  </span>/mnt/<span class="nv">$SERVICE</span>/deleted_products_images<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>
ln<span class="w"> </span>-s<span class="w">  </span>/mnt/<span class="nv">$SERVICE</span>/imports<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>
ln<span class="w"> </span>-s<span class="w">  </span>/mnt/<span class="nv">$SERVICE</span>/deleted_private_products<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>
ln<span class="w"> </span>-s<span class="w">  </span>/mnt/<span class="nv">$SERVICE</span>/reverted_products<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>
ln<span class="w"> </span>-s<span class="w">  </span>/mnt/<span class="nv">$SERVICE</span>/translate<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>
ln<span class="w"> </span>-s<span class="w">  </span>/mnt/<span class="nv">$SERVICE</span>/cache/debug<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/
ln<span class="w"> </span>-s<span class="w">  </span>/mnt/<span class="nv">$SERVICE</span>/import_files<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/import_files
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/data<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/data
<span class="c1"># verify</span>
ls<span class="w"> </span>-l<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/<span class="o">{</span>deleted.images,deleted_products,deleted_products_images,imports,deleted_private_products,reverted_products,translate,debug<span class="o">}</span>
</code></pre></div></p>
<p>for off-pro we also need a link to <code>internal_code.sto</code>:
<div class="highlight"><pre><span></span><code>ln<span class="w"> </span>-s<span class="w"> </span>/mnt/off/products/internal_code.sto<span class="w"> </span>/srv/off-pro/products/
</code></pre></div></p>
<p>Create and link cache folders:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># off or off-pro</span>
<span class="nv">SERVICE</span><span class="o">=</span>off
<span class="nb">cd</span><span class="w"> </span>/srv/<span class="nv">$SERVICE</span>
rm<span class="w"> </span>build-cache/taxonomies/README.md<span class="p">;</span><span class="w"> </span>rmdir<span class="w"> </span>build-cache/taxonomies<span class="p">;</span><span class="w"> </span>rmdir<span class="w"> </span>build-cache
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/cache/build-cache<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/build-cache
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/cache/tmp<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/tmp
rm<span class="w"> </span>debug/.empty<span class="p">;</span><span class="w"> </span>rmdir<span class="w"> </span>debug
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/cache/debug<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/debug
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/cache/new_images<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/new_images
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/cache/export_files<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/export_files
<span class="c1"># verify</span>
ls<span class="w"> </span>-l<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/<span class="o">{</span>build-cache,tmp,debug,new_images,export_files<span class="o">}</span>
</code></pre></div>
<p>And on off, we need to be able to reach off-pro <code>export_files</code> and images:
<div class="highlight"><pre><span></span><code><span class="c1"># only for off !</span>
sudo<span class="w"> </span>mkdir<span class="w"> </span>/srv/off-pro/
sudo<span class="w"> </span>chown<span class="w"> </span>off:off<span class="w"> </span>/srv/off-pro/
sudo<span class="w"> </span>-u<span class="w"> </span>off<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/mnt/off-pro/cache/export_files<span class="w"> </span>/srv/off-pro/export_files
sudo<span class="w"> </span>-u<span class="w"> </span>off<span class="w"> </span>mkdir<span class="w"> </span>/srv/off-pro/html
sudo<span class="w"> </span>-u<span class="w"> </span>off<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/mnt/off-pro/images<span class="w"> </span>/srv/off-pro/html/images
<span class="c1"># verify</span>
ls<span class="w"> </span>-l<span class="w"> </span>/srv/off-pro/export_files<span class="o">{</span>,/<span class="o">}</span><span class="w"> </span>/srv/off-pro/images<span class="o">{</span>,/<span class="o">}</span>
</code></pre></div></p>
<p>We also want to move html/data/data-field.txt outside the data volume and link it, as user off.
<div class="highlight"><pre><span></span><code><span class="c1"># off or off-pro</span>
<span class="nv">SERVICE</span><span class="o">=</span>off
<span class="nb">cd</span><span class="w"> </span>srv/<span class="nv">$SERVICE</span>
mv<span class="w"> </span>html/data/data-field.txt<span class="w"> </span>html/data-field.txt
ln<span class="w"> </span>-s<span class="w"> </span>../data-fields.txt<span class="w"> </span>html/data/data-fields.txt
</code></pre></div></p>
<h3 id="linking-logs">linking logs<a class="headerlink" href="#linking-logs" title="Permanent link">#</a></h3>
<p>We want logs to go in /var/logs and really in /mnt/off/logs .</p>
<p>We will create a directory for instance (off/off-pro) and also add links to nginx and apache2 logs.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># off or off-pro</span>
<span class="nv">SERVICE</span><span class="o">=</span>off

<span class="c1"># be sure to avoid having apache2 or nginx writing</span>

sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>apache2<span class="w"> </span>nginx
sudo<span class="w"> </span>-u<span class="w"> </span>off<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/logs/

sudo<span class="w"> </span>mkdir<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/logs/<span class="nv">$SERVICE</span>
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/logs/<span class="nv">$SERVICE</span><span class="w"> </span>/var/log/
sudo<span class="w"> </span>chown<span class="w"> </span>off:off<span class="w"> </span>-R<span class="w"> </span>/var/log/<span class="nv">$SERVICE</span>
sudo<span class="w"> </span>-u<span class="w"> </span>off<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/logs/<span class="nv">$SERVICE</span><span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/logs

<span class="c1"># also move nginx and apache logs</span>
sudo<span class="w"> </span>mv<span class="w"> </span>/var/log/nginx<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/logs
sudo<span class="w"> </span>mv<span class="w"> </span>/var/log/apache2<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/logs
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/logs/nginx<span class="w"> </span>/var/log
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$SERVICE</span>/logs/apache2<span class="w"> </span>/var/log

sudo<span class="w">  </span>-u<span class="w"> </span>off<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>../apache2<span class="w"> </span>/var/log/<span class="nv">$SERVICE</span>
sudo<span class="w"> </span>-u<span class="w"> </span>off<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>../nginx<span class="w"> </span>/var/log/<span class="nv">$SERVICE</span>

<span class="c1"># verify</span>
ls<span class="w"> </span>-l<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/logs<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/logs/<span class="w"> </span>/var/log/<span class="o">{</span><span class="nv">$SERVICE</span>,nginx,apache2<span class="o">}</span>
</code></pre></div>
<p>Copy original <code>log.conf</code> and <code>minion_log.conf</code> and make it a symlink.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># off or off-pro</span>
<span class="nv">SERVICE</span><span class="o">=</span>off

mv<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>-old/log.conf<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/<span class="nv">$SERVICE</span>-log.conf
rm<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/log.conf
ln<span class="w"> </span>-s<span class="w"> </span>conf/<span class="nv">$SERVICE</span>-log.conf<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/log.conf
mv<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>-old/minion_log.conf<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/<span class="nv">$SERVICE</span>-minion_log.conf
rm<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/minion_log.conf
ln<span class="w"> </span>-s<span class="w"> </span>conf/<span class="nv">$SERVICE</span>-minion_log.conf<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/minion_log.conf
<span class="c1"># verify</span>
ls<span class="w"> </span>-l<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/<span class="o">{</span>,minion_<span class="o">}</span>log.conf<span class="w"> </span>
</code></pre></div>
<h3 id="copy-and-verify-config-links">copy and verify config links<a class="headerlink" href="#copy-and-verify-config-links" title="Permanent link">#</a></h3>
<p>Config files:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># off or off-pro</span>
<span class="nv">SERVICE</span><span class="o">=</span>off

cp<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>-old/lib/ProductOpener/Config2.pm<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/lib/ProductOpener/Config2.pm
ln<span class="w"> </span>-s<span class="w"> </span>Config_off.pm<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/lib/ProductOpener/Config.pm
<span class="c1"># verify</span>
ls<span class="w"> </span>-l<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/lib/ProductOpener/<span class="o">{</span>Config,Config2<span class="o">}</span>.pm
</code></pre></div>
<p>Specific translations:
<div class="highlight"><pre><span></span><code>ln<span class="w"> </span>-s<span class="w"> </span>openfoodfacts<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/po/site-specific
</code></pre></div></p>
<h3 id="verify-broken-links">Verify broken links<a class="headerlink" href="#verify-broken-links" title="Permanent link">#</a></h3>
<p><code>sudo find /srv/$SERVICE-old -xtype l | xargs ls -l</code></p>
<p>On off-pro it reveals: <code>/srv/off-pro-old/index -&gt; /srv/off/index</code>
but it's old stuff, it's now in <code>data/index</code></p>
<h3 id="adding-dists">Adding dists<a class="headerlink" href="#adding-dists" title="Permanent link">#</a></h3>
<p>Create folders for dist:
<div class="highlight"><pre><span></span><code><span class="c1"># off or off-pro</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">SERVICE</span><span class="o">=</span>off

sudo<span class="w"> </span>-E<span class="w"> </span>mkdir<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>-dist
sudo<span class="w"> </span>-E<span class="w"> </span>chown<span class="w"> </span>off:off<span class="w"> </span>-R<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>-dist
</code></pre></div></p>
<p>and unpack last dist release there (as user off):</p>
<div class="highlight"><pre><span></span><code>wget<span class="w"> </span>https://github.com/openfoodfacts/openfoodfacts-server/releases/download/v2.15.0/frontend-dist.tgz<span class="w"> </span>-O<span class="w"> </span>/tmp/frontend-dist.tgz
tar<span class="w"> </span>xzf<span class="w"> </span>/tmp/frontend-dist.tgz<span class="w"> </span>-C<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>-dist
</code></pre></div>
<p>And use symbolic links in folders (as user off):</p>
<div class="highlight"><pre><span></span><code><span class="c1"># first link for whole folder</span>
ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>-dist<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/dist
<span class="c1"># relative links for the rest</span>
ln<span class="w"> </span>-s<span class="w"> </span>../../../dist/icons<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/html/images/icons/dist
ln<span class="w"> </span>-s<span class="w"> </span>../../../dist/attributes<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/html/images/attributes/dist
ln<span class="w"> </span>-s<span class="w"> </span>../../dist/css<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/html/css/dist
ln<span class="w"> </span>-s<span class="w"> </span>../../dist/js<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/html/js/dist
<span class="c1"># verify</span>
ls<span class="w"> </span>-l<span class="w">  </span>/srv/<span class="nv">$SERVICE</span>/dist<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/html/<span class="o">{</span>images/icons,images/attributesoovaf0fieKe<span class="p">|</span>yae<span class="s2">&quot;,css,js}/dist</span>
</code></pre></div>
<h3 id="adding-openfoodfacts-web">Adding openfoodfacts-web<a class="headerlink" href="#adding-openfoodfacts-web" title="Permanent link">#</a></h3>
<h4 id="cloning-repo">Cloning repo<a class="headerlink" href="#cloning-repo" title="Permanent link">#</a></h4>
<p>Note that I add to make two deploys keys as explained in <a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/managing-deploy-keys#using-multiple-repositories-on-one-server">github documentation</a> and use a specific ssh_config hostname for openfoodfacts-web:</p>
<p>Create new key, as off:
<div class="highlight"><pre><span></span><code><span class="c1"># off or off-pro</span>
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">SERVICE</span><span class="o">=</span>off

<span class="c1"># deploy key for openfoodfacts-web</span>
ssh-keygen<span class="w"> </span>-t<span class="w"> </span>ed25519<span class="w"> </span>-C<span class="w"> </span><span class="s2">&quot;off+off-web@</span><span class="nv">$SERVICE</span><span class="s2">.openfoodfacts.org&quot;</span><span class="w"> </span>-f<span class="w"> </span>/home/off/.ssh/github_off-web
</code></pre></div></p>
<p>Add a specific host in ssh config
<div class="highlight"><pre><span></span><code># /home/off/.ssh/config
Host github.com-off-web
    Hostname github.com
    IdentityFile=/home/off/.ssh/github_off-web
</code></pre></div></p>
<p>In github add the <code>/home/off/.ssh/github_off-web.pub</code> to deploy keys for openfoodfacts-web.</p>
<p>Cloning:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>mkdir<span class="w"> </span>/srv/openfoodfacts-web
sudo<span class="w"> </span>chown<span class="w"> </span>off:off<span class="w"> </span>/srv/openfoodfacts-web
sudo<span class="w"> </span>-u<span class="w"> </span>off<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>git@github.com-off-web:openfoodfacts/openfoodfacts-web.git<span class="w"> </span>/srv/openfoodfacts-web
</code></pre></div></p>
<h4 id="linking-content">Linking content<a class="headerlink" href="#linking-content" title="Permanent link">#</a></h4>
<p>We clearly want off and off-pro lang folder to come from off-web:</p>
<div class="highlight"><pre><span></span><code>ln<span class="w"> </span>-s<span class="w"> </span>/srv/openfoodfacts-web/lang<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/

<span class="c1"># verify</span>
ls<span class="w"> </span>-ld<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/lang
</code></pre></div>
<h3 id="installing-cpan">Installing CPAN<a class="headerlink" href="#installing-cpan" title="Permanent link">#</a></h3>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>/srv/off
sudo<span class="w"> </span>cpanm<span class="w"> </span>--notest<span class="w"> </span>--quiet<span class="w"> </span>--skip-satisfied<span class="w"> </span><span class="s2">&quot;Apache::Bootstrap&quot;</span>
sudo<span class="w"> </span>cpanm<span class="w"> </span>--notest<span class="w"> </span>--quiet<span class="w"> </span>--skip-satisfied<span class="w"> </span>--installdeps<span class="w"> </span>.
</code></pre></div>
<h2 id="fixing-directory-problems">Fixing directory problems<a class="headerlink" href="#fixing-directory-problems" title="Permanent link">#</a></h2>
<p>We have a problem because some directory present in git are transformed to symlinks in production environement.
So this disallow making simple git pull to update code. Where this was one of the goal to maintain a clean deployment.</p>
<p>A solution to that is to remove those directory in the git. But to avoid complexifying usage, an idea is to centralize principal directory creation in the code itself.</p>
<h2 id="setting-up-services">Setting up services<a class="headerlink" href="#setting-up-services" title="Permanent link">#</a></h2>
<h3 id="modify-settings-for-memcached-and-postgresql">Modify settings for memcached and postgresql<a class="headerlink" href="#modify-settings-for-memcached-and-postgresql" title="Permanent link">#</a></h3>
<p>On off, edit <code>Config2.pm</code> to change:</p>
<ul>
<li><code>$memd_servers</code> to 10.1.0.121</li>
<li><code>$server_options{minion_backend}{Pg}</code> to use 10.1.0.120 as the Postgres host</li>
</ul>
<h3 id="nginx-for-off-and-off-pro-inside-their-container">NGINX for off and off-pro (inside their container)<a class="headerlink" href="#nginx-for-off-and-off-pro-inside-their-container" title="Permanent link">#</a></h3>
<p>Installed nginx <code>sudo apt install nginx</code>.</p>
<p>Removed default site <code>sudo unlink /etc/nginx/sites-enabled/default</code></p>
<p>I added /srv/off/conf/nginx/conf.d/log_format_realip.conf (it's now in git).</p>
<p>Then made symlinks:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/nginx/sites-available/<span class="nv">$SERVICE</span><span class="w"> </span>/etc/nginx/sites-enabled/
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/nginx/snippets/expires-no-json-xml.conf<span class="w"> </span>/etc/nginx/snippets
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/nginx/snippets/off.cors-headers.include<span class="w"> </span>/etc/nginx/snippets
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/nginx/snippets/off.domain-redirects.include<span class="w"> </span>/etc/nginx/snippets
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/nginx/snippets/off.locations-redirects.include<span class="w"> </span>/etc/nginx/snippets
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/nginx/conf.d/log_format_realip.conf<span class="w"> </span>/etc/nginx/conf.d
sudo<span class="w"> </span>rm<span class="w"> </span>/etc/nginx/mime.types
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/nginx/mime.types<span class="w"> </span>/etc/nginx/
<span class="c1"># verify</span>
ls<span class="w"> </span>-l<span class="w"> </span>/etc/nginx/sites-enabled/<span class="w"> </span>/etc/nginx/snippets/<span class="w"> </span>/etc/nginx/conf.d/log_format_realip.conf<span class="w"> </span>/etc/nginx/mime.types
</code></pre></div></p>
<p>On off and off-pro Modified their configuration to remove ssl section, change log path and access log format, and to set real_ip_resursive options (it's all in git)</p>
<p>test it:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>nginx<span class="w"> </span>-t
</code></pre></div></p>
<h3 id="apache">Apache<a class="headerlink" href="#apache" title="Permanent link">#</a></h3>
<p>We start by removing default config and disabling mpm_event in favor of mpm_prefork, and change logs permissions
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>unlink<span class="w"> </span>/etc/apache2/sites-enabled/000-default.conf
sudo<span class="w"> </span>a2dismod<span class="w"> </span>mpm_event
sudo<span class="w"> </span>a2enmod<span class="w"> </span>mpm_prefork
sudo<span class="w"> </span>chown<span class="w"> </span>off:off<span class="w"> </span>-R<span class="w"> </span>/var/log/apache2<span class="w"> </span>/var/run/apache2
</code></pre></div>
and edit <code>/etc/apache2/envvars</code> to use off user:
<div class="highlight"><pre><span></span><code>#export APACHE_RUN_USER=www-data
export APACHE_RUN_USER=off
#export APACHE_RUN_GROUP=www-data
export APACHE_RUN_GROUP=off
</code></pre></div></p>
<ul>
<li>Add configuration in sites enabled
  <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/apache-2.4/sites-available/<span class="nv">$SERVICE</span>.conf<span class="w"> </span>/etc/apache2/sites-enabled/
</code></pre></div></li>
<li>link <code>mpm_prefork.conf</code> to a file in git, identical as the one in production
  <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>rm<span class="w"> </span>/etc/apache2/mods-available/mpm_prefork.conf
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/apache-2.4/<span class="nv">$SERVICE</span>-mpm_prefork.conf<span class="w"> </span>/etc/apache2/mods-available/mpm_prefork.conf
</code></pre></div></li>
<li>use customized ports.conf (8004 and 8014)
  <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>rm<span class="w"> </span>/etc/apache2/ports.conf
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/apache-2.4/<span class="nv">$SERVICE</span>-ports.conf<span class="w"> </span>/etc/apache2/ports.conf
</code></pre></div></li>
</ul>
<p>test it in both container:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apache2ctl<span class="w"> </span>configtest
</code></pre></div></p>
<p>We can restart apache2 then nginx:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>apache2
sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>nginx
</code></pre></div></p>
<h3 id="creating-systemd-units-for-timers-gen-feeds-jobs-and-apache-and-nginx">creating systemd units for timers gen feeds jobs and apache and nginx<a class="headerlink" href="#creating-systemd-units-for-timers-gen-feeds-jobs-and-apache-and-nginx" title="Permanent link">#</a></h3>
<p>We install mailx</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>mailutils
</code></pre></div>
<p>We copy the units from opff branch in the current branch.</p>
<p><div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>origin/opff-main<span class="w"> </span>conf/systemd/
git<span class="w"> </span>add<span class="w"> </span>conf/systemd/
git<span class="w"> </span>commit<span class="w"> </span>-a<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;build: added systemd units&quot;</span>
</code></pre></div>
and link them at system level
<div class="highlight"><pre><span></span><code><span class="c1"># off or off-pro</span>
<span class="nv">$SERVICE</span><span class="o">=</span>off

sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/systemd/gen_feeds<span class="se">\@</span>.timer<span class="w"> </span>/etc/systemd/system
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/systemd/gen_feeds<span class="se">\@</span>.service<span class="w"> </span>/etc/systemd/system
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/systemd/gen_feeds_daily<span class="se">\@</span>.service<span class="w"> </span>/etc/systemd/system
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/systemd/gen_feeds_daily<span class="se">\@</span>.timer<span class="w"> </span>/etc/systemd/system
<span class="c1"># those are overides to get emails on failures</span>
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/systemd/apache2.service.d<span class="w"> </span>/etc/systemd/system
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/systemd/nginx.service.d<span class="w"> </span>/etc/systemd/system
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/systemd/email-failures<span class="se">\@</span>.service<span class="w"> </span>/etc/systemd/system
<span class="c1"># account for new services</span>
sudo<span class="w"> </span>systemctl<span class="w"> </span>daemon-reload
</code></pre></div></p>
<p>Test failure notification is working:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>email-failures@gen_feeds__<span class="nv">$SERVICE</span>.service
</code></pre></div>
<p><strong>TODO</strong> Test systemctl gen_feeds services are working:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>gen_feeds_daily@<span class="nv">$SERVICE</span>.service
sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>gen_feeds@<span class="nv">$SERVICE</span>.service
</code></pre></div>
<p><strong>TODO</strong> Activate systemd units:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>gen_feeds@<span class="nv">$SERVICE</span>.timer
sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>gen_feeds_daily@<span class="nv">$SERVICE</span>.timer
sudo<span class="w"> </span>systemctl<span class="w"> </span>daemon-reload
</code></pre></div>
<h3 id="creating-systemd-units-for-minions-and-ocr">creating systemd units for minions and OCR<a class="headerlink" href="#creating-systemd-units-for-minions-and-ocr" title="Permanent link">#</a></h3>
<p>For minions and process that send images to OCR, we simply link them:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/systemd/minion<span class="se">\@</span>.service<span class="w"> </span>/etc/systemd/system
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/systemd/cloud_vision_ocr<span class="se">\@</span>.service<span class="w"> </span>/etc/systemd/system
sudo<span class="w"> </span>systemctl<span class="w"> </span>daemon-reload
</code></pre></div>
<p><strong>TODO</strong> Activate systemd units:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>minion@<span class="nv">$SERVICE</span>.service
sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>cloud_vision_ocr@<span class="nv">$SERVICE</span>.service
sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>minion@<span class="nv">$SERVICE</span>.service
sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>cloud_vision_ocr@<span class="nv">$SERVICE</span>.service
</code></pre></div>
<p><strong>TODO</strong> Test it's working</p>
<h3 id="log-rotate-perl-logs">log rotate perl logs<a class="headerlink" href="#log-rotate-perl-logs" title="Permanent link">#</a></h3>
<div class="highlight"><pre><span></span><code><span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">SERVICE</span><span class="o">=</span>off
</code></pre></div>
<p>We get <code>conf/logrotate/apache</code> from opff in git repository:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>rm<span class="w"> </span>/etc/logrotate.d/apache2
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/logrotate/apache2<span class="w"> </span>/etc/logrotate.d/apache2
<span class="c1"># logrotate needs root ownerships</span>
sudo<span class="w"> </span>chown<span class="w"> </span>root:root<span class="w"> </span>/srv/<span class="nv">$SERVICE</span>/conf/logrotate/apache2
</code></pre></div>
<p>We can test with:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>logrotate<span class="w"> </span>/etc/logrotate.conf<span class="w"> </span>--debug
</code></pre></div></p>
<h3 id="installing-mongodb-client">Installing mongodb client<a class="headerlink" href="#installing-mongodb-client" title="Permanent link">#</a></h3>
<p>We need mongodb client to be able to export the database in gen_feeds.</p>
<p>I'll follow official doc for 4.4 https://www.mongodb.com/docs/v4.4/tutorial/install-mongodb-on-debian/,
but we are on bullseye, and we just want to install tools.</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://pgp.mongodb.com/server-4.4.asc<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>sudo<span class="w"> </span>gpg<span class="w"> </span>-o<span class="w"> </span>/usr/share/keyrings/mongodb-server-4.4.gpg<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--dearmor
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;deb [ signed-by=/usr/share/keyrings/mongodb-server-4.4.gpg ] http://repo.mongodb.org/apt/debian bullseye/mongodb-org/4.4 main&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/mongodb-org-4.4.list
sudo<span class="w"> </span>apt<span class="w"> </span>update
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w">  </span>mongodb-database-tools
</code></pre></div>
<h3 id="test-with-curl">Test with curl<a class="headerlink" href="#test-with-curl" title="Permanent link">#</a></h3>
<p>for off:
<div class="highlight"><pre><span></span><code><span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">DOMAIN_NAME</span><span class="o">=</span>openfoodfacts
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">PORT_NUM</span><span class="o">=</span><span class="m">8004</span>
</code></pre></div></p>
<p>for off-pro:
<div class="highlight"><pre><span></span><code><span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">DOMAIN_NAME</span><span class="o">=</span>pro.openfoodfacts
<span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">PORT_NUM</span><span class="o">=</span><span class="m">8014</span>
</code></pre></div></p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>nginx<span class="w"> </span>apache2
</code></pre></div>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>localhost:<span class="nv">$PORT_NUM</span>/cgi/display.pl<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Host: fr.</span><span class="nv">$DOMAIN_NAME</span><span class="s2">.org&quot;</span>
</code></pre></div>
<p>Nginx call
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>localhost<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Host: fr.</span><span class="nv">$DOMAIN_NAME</span><span class="s2">.org&quot;</span>
curl<span class="w"> </span>localhost/css/dist/app-ltr.css<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Host: static.</span><span class="nv">$DOMAIN_NAME</span><span class="s2">.org&quot;</span>
</code></pre></div></p>
<h3 id="nginx-for-madenearme-on-off">Nginx for madenearme on off<a class="headerlink" href="#nginx-for-madenearme-on-off" title="Permanent link">#</a></h3>
<p>We want to serve madenearme websites from the off container using nginx.</p>
<p>It's the simplest way as it shares resources with off website.</p>
<p>I first reworked the madenearme nginx configuration file to support uk and fr as well at once.</p>
<p>Then linked config:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/off/conf/nginx/sites-available/madenearme<span class="w"> </span>/etc/nginx/sites-enabled/
<span class="c1"># test</span>
sudo<span class="w"> </span>nginx<span class="w"> </span>-t
<span class="c1"># restart</span>
sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>nginx
</code></pre></div>
<p>Test locally:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>localhost<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Host: madenear.me&quot;</span>
curl<span class="w"> </span>localhost/<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Host: cestemballepresdechezvous.fr&quot;</span>
curl<span class="w"> </span>localhost/<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Host: madenear.me.uk&quot;</span>
</code></pre></div>
<h3 id="nginx-for-how-much-sugar-on-off">Nginx for how much sugar on off<a class="headerlink" href="#nginx-for-how-much-sugar-on-off" title="Permanent link">#</a></h3>
<p>We want to serve how-much-sugar websites from the off container using nginx.</p>
<p>It's the simplest way as it shares resources with off website.</p>
<p>I first reworked the how-much-sugar nginx configuration file to support en and fr as well at once
and use the off public data directory (has html pages are generated, so considered data).</p>
<p>Then linked config:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/off/conf/nginx/sites-available/howmuchsugar<span class="w"> </span>/etc/nginx/sites-enabled/
<span class="c1"># test</span>
sudo<span class="w"> </span>nginx<span class="w"> </span>-t
<span class="c1"># restart</span>
sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>nginx
</code></pre></div>
<p>Test locally:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>localhost<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Host: howmuchsugar.in&quot;</span>
curl<span class="w"> </span>localhost/zest-sun-dried-tomato-paste-zest.html<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Host: howmuchsugar</span>
<span class="s2">.in&quot;</span>
curl<span class="w"> </span>localhost/cgi/sugar_random.pl<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Host: howmuchsugar.in&quot;</span>
curl<span class="w"> </span>localhost/<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Host: combiendesucres.fr&quot;</span>
curl<span class="w"> </span>localhost/cgi/sugar_random.pl<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Host: combiendesucres.fr&quot;</span>
</code></pre></div>
<h2 id="reverse-proxy-configuration">Reverse proxy configuration<a class="headerlink" href="#reverse-proxy-configuration" title="Permanent link">#</a></h2>
<h3 id="certbot-wildcard-certificates-using-ovh-dns">certbot wildcard certificates using OVH DNS<a class="headerlink" href="#certbot-wildcard-certificates-using-ovh-dns" title="Permanent link">#</a></h3>
<p>We already install <code>python3-certbot-dns-ovh</code> so we just need to add credentials.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nb">declare</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">DOMAIN_NAME</span><span class="o">=</span>openfoodfacts
</code></pre></div>
<p><strong>Note:</strong> off-pro does not use the same wildcard certificate as off because <em>.pro.openfoodfacts.org is not in </em>.openfoodfacts.org. But it can use the same OVH credentials.</p>
<p>Generate credential, following https://eu.api.ovh.com/createToken/</p>
<p>Using (for off):</p>
<ul>
<li>name: <code>off proxy openfoodfacts.org</code></li>
<li>description: <code>nginx proxy on off2 for openfoodfacts.org</code></li>
<li>validity: <code>unlimited</code></li>
<li>GET <code>/domain/zone/</code>
  (note: the last <code>/</code> is important !)</li>
<li>GET/PUT/POST/DELETE <code>/domain/zone/openfoodfacts.org/*</code></li>
</ul>
<p>and we put config file in <code>/root/.ovhapi/openfoodfacts.org</code>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mkdir<span class="w"> </span>/root/.ovhapi
$<span class="w"> </span>vim<span class="w"> </span>/root/.ovhapi/<span class="nv">$DOMAIN_NAME</span>.org
...
$<span class="w"> </span>cat<span class="w"> </span>/root/.ovhapi/<span class="nv">$DOMAIN_NAME</span>.org
<span class="c1"># OVH API credentials used by Certbot</span>
<span class="nv">dns_ovh_endpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ovh-eu
<span class="nv">dns_ovh_application_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>***********
<span class="nv">dns_ovh_application_secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>***********
<span class="nv">dns_ovh_consumer_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>***********

<span class="c1"># ensure no reading by others</span>
$<span class="w"> </span>chmod<span class="w"> </span>og-rwx<span class="w"> </span>-R<span class="w"> </span>/root/.ovhapi
</code></pre></div></p>
<p>Try to get a wildcard using certbot, we will choose to obtain certificates using a DNS TXT record, and use tech -at- off.org for notifications. We first try with <code>--test-cert</code>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>certbot<span class="w"> </span>certonly<span class="w"> </span>--test-cert<span class="w"> </span>--dns-ovh<span class="w"> </span>--dns-ovh-credentials<span class="w"> </span>/root/.ovhapi/<span class="nv">$DOMAIN_NAME</span>.org<span class="w"> </span>-d<span class="w"> </span><span class="nv">$DOMAIN_NAME</span>.org<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;*.</span><span class="nv">$DOMAIN_NAME</span><span class="s2">.org&quot;</span>
...
...

<span class="w"> </span>-<span class="w"> </span>Congratulations!<span class="w"> </span>Your<span class="w"> </span>certificate<span class="w"> </span>and<span class="w"> </span>chain<span class="w"> </span>have<span class="w"> </span>been<span class="w"> </span>saved<span class="w"> </span>at:
<span class="w">   </span>/etc/letsencrypt/live/xxxxx.org/fullchain.pem
</code></pre></div>
and then without <code>--test-cert</code>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>certbot<span class="w"> </span>certonly<span class="w"> </span>--dns-ovh<span class="w"> </span>--dns-ovh-credentials<span class="w"> </span>/root/.ovhapi/<span class="nv">$DOMAIN_NAME</span>.org<span class="w"> </span>-d<span class="w"> </span><span class="nv">$DOMAIN_NAME</span>.org<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;*.</span><span class="nv">$DOMAIN_NAME</span><span class="s2">.org&quot;</span>
...
...
<span class="w"> </span>-<span class="w"> </span>Congratulations!<span class="w"> </span>Your<span class="w"> </span>certificate<span class="w"> </span>and<span class="w"> </span>chain<span class="w"> </span>have<span class="w"> </span>been<span class="w"> </span>saved<span class="w"> </span>at:
<span class="w">   </span>/etc/letsencrypt/live/xxxxx.org/fullchain.pem
...
</code></pre></div></p>
<p>For off-pro we use:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>certbot<span class="w"> </span>certonly<span class="w"> </span>--dns-ovh<span class="w"> </span>--dns-ovh-credentials<span class="w"> </span>/root/.ovhapi/<span class="nv">$DOMAIN_NAME</span>.org<span class="w"> </span>-d<span class="w"> </span>pro.<span class="nv">$DOMAIN_NAME</span>.org<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;*.pro.</span><span class="nv">$DOMAIN_NAME</span><span class="s2">.org&quot;</span>
</code></pre></div>
<h3 id="create-site-config-for-off-and-off-pro">Create site config for off and off-pro<a class="headerlink" href="#create-site-config-for-off-and-off-pro" title="Permanent link">#</a></h3>
<p>In the git repository, we copied the openpetfoodfacts config and changed names to the right domain.</p>
<p>Then we linked them:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/proxy-off/nginx/openfoodfacts.org<span class="w"> </span>/etc/nginx/sites-enabled/
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/proxy-off/nginx/pro.openfoodfacts.org<span class="w"> </span>/etc/nginx/sites-enabled/
<span class="c1"># test</span>
nginx<span class="w"> </span>-t
systemctl<span class="w"> </span>restart<span class="w"> </span>nginx
</code></pre></div></p>
<h3 id="madenearme-reverse-proxy">Madenearme reverse proxy<a class="headerlink" href="#madenearme-reverse-proxy" title="Permanent link">#</a></h3>
<h4 id="create-site-configuration">create site configuration<a class="headerlink" href="#create-site-configuration" title="Permanent link">#</a></h4>
<p>We created the configuration and activate it:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/proxy-off/nginx/madenear.me<span class="w"> </span>/etc/nginx/sites-enabled/
<span class="c1"># test</span>
sudo<span class="w"> </span>nginx<span class="w"> </span>-t
<span class="c1"># reload config</span>
sudo<span class="w"> </span>systemctl<span class="w"> </span>reload<span class="w"> </span>nginx
</code></pre></div>
<h4 id="generate-certificates">Generate certificates<a class="headerlink" href="#generate-certificates" title="Permanent link">#</a></h4>
<p>We can't generate certificates with certbot while madenearme does not resolve to the right server
and on old server, those are separate file, I don't want this here.
But to test it, I did a copy of those of off1, only for madenearme domain.</p>
<p>I tested it ok modifying my /etc/hosts to contain:
<code>213.36.253.214 madenear.me</code></p>
<h3 id="how-much-sugar-reverse-proxy">How much sugar reverse proxy<a class="headerlink" href="#how-much-sugar-reverse-proxy" title="Permanent link">#</a></h3>
<h4 id="create-site-configuration_1">create site configuration<a class="headerlink" href="#create-site-configuration_1" title="Permanent link">#</a></h4>
<p>We created the configuration and activate it:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/proxy-off/nginx/howmuchsugar.in<span class="w"> </span>/etc/nginx/sites-enabled/
<span class="c1"># test</span>
sudo<span class="w"> </span>nginx<span class="w"> </span>-t
<span class="c1"># reload config</span>
sudo<span class="w"> </span>systemctl<span class="w"> </span>reload<span class="w"> </span>nginx
</code></pre></div>
<h4 id="generate-certificates_1">Generate certificates<a class="headerlink" href="#generate-certificates_1" title="Permanent link">#</a></h4>
<p>We can't generate certificates with certbot while howmuchsugar.in does not resolve to the right server
and on old server, those are separate file, I don't want this here.
But to test it, I did a copy of those of off1, only for howmuchsugar.in domain.</p>
<p>I tested it ok modifying my /etc/hosts to contain:
<code>213.36.253.214 howmuchsugar.in</code></p>
<h2 id="adding-sftp-to-reverse-proxy">Adding sftp to reverse proxy<a class="headerlink" href="#adding-sftp-to-reverse-proxy" title="Permanent link">#</a></h2>
<p>We want to add the sftp server on the reveres proxy so we can use it's public IP.</p>
<h3 id="add-volume-for-data">Add volume for data<a class="headerlink" href="#add-volume-for-data" title="Permanent link">#</a></h3>
<p>We want a shared ZFS dataset for sftp data between the reverse proxy and off-pro container.</p>
<p>Create ZFS dataset, on off2:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>zfs<span class="w"> </span>create<span class="w"> </span>zfs-hdd/off-pro/sftp
<span class="c1"># make top folders accessible to root inside a container (where id 0 is mapped to 100000)</span>
chown<span class="w"> </span><span class="m">100000</span>:100000<span class="w"> </span>/zfs-hdd/off-pro/sftp/<span class="w"> </span>/zfs-hdd/off-pro/sftp/*
</code></pre></div></p>
<p>We then change reverse proxy configuration (<code>/etc/pve/lxc/101.conf</code>) and off-pro (<code>/etc/pve/lxc/114.conf</code>) config to add a mount point. Somthing like <code>mp8: /zfs-hdd/off-pro/sftp,mp=/mnt/off-pro/sftp</code> (number after mp, depends on already existing one).</p>
<p>But we also need to remap ids in 101 so that id above 1000 to keep their id on the host.
So in <code>/etc/pve/lxc/101.conf</code>, we add similar sections as in the other containers.
As we add more users for sftp, we will reserve for a big number of account (all above 1000).</p>
<p><div class="highlight"><pre><span></span><code>lxc.idmap: u 0 100000 999
lxc.idmap: g 0 100000 999
lxc.idmap: u 1000 1000 64536
lxc.idmap: g 1000 1000 64536
</code></pre></div>
I also had to change <code>/etc/subuid</code> and <code>/etc/subgid</code>  to enable this, and have</p>
<div class="highlight"><pre><span></span><code>root:1000:64536
</code></pre></div>
<p>After that we have to reboot both containers.
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>pct<span class="w"> </span>reboot<span class="w"> </span><span class="m">101</span>
sudo<span class="w"> </span>pct<span class="w"> </span>reboot<span class="w"> </span><span class="m">114</span>
</code></pre></div></p>
<p>We verify it's working and we save config in off-infra project:
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>/opt/openfoodfacts-infrastructure/
<span class="k">for</span><span class="w"> </span>ct<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>ls<span class="w"> </span>/etc/pve/lxc/*.conf<span class="k">)</span>
<span class="k">do</span>
<span class="w">  </span><span class="nv">num</span><span class="o">=</span><span class="k">$(</span>basename<span class="w"> </span><span class="nv">$ct</span><span class="w"> </span>.conf<span class="k">)</span>
<span class="w">  </span>cp<span class="w"> </span>/etc/pve/lxc/<span class="nv">$num</span>.conf<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/off2/pve/lxc_<span class="nv">$num</span>.conf
<span class="k">done</span>
cp<span class="w"> </span>/etc/pve/lxc/101.conf<span class="w"> </span>confs/off2/pve/lxc_101.conf
cp<span class="w"> </span>/etc/pve/lxc/114.conf<span class="w"> </span>confs/off2/pve/lxc_114.conf
git<span class="w"> </span>status<span class="w"> </span>

</code></pre></div></p>
<h3 id="rsync-existing-data-from-off1">Rsync existing data from off1<a class="headerlink" href="#rsync-existing-data-from-off1" title="Permanent link">#</a></h3>
<p>on off2:
<div class="highlight"><pre><span></span><code><span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>-a<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/sftp/<span class="w"> </span>/zfs-hdd/off-pro/sftp/
<span class="c1"># change root dirs permission to correspond to root inside container</span>
chown<span class="w"> </span><span class="m">100000</span>:100000<span class="w"> </span>/zfs-hdd/off-pro/sftp/<span class="w"> </span>/zfs-hdd/off-pro/sftp/*
</code></pre></div>
it's quite fast.</p>
<h3 id="configure-sftp">Configure sftp<a class="headerlink" href="#configure-sftp" title="Permanent link">#</a></h3>
<p>In the reverse proxy container:
We create a config file for sftp in our repository and link it:</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/proxy-off/sshd_config
touch<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/proxy-off/sshd_config/sftp
ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/proxy-off/sshd_config/sftp<span class="w"> </span>/etc/ssh/sshd_config.d/
</code></pre></div>
<p>We then edit the file, the same way as on off1</p>
<h3 id="create-sftp-users">Create sftp users<a class="headerlink" href="#create-sftp-users" title="Permanent link">#</a></h3>
<p>We want to re-create sftp users as they where on off1.
So instead of using command that creates them, we will copy them directly in /etc/passwd and /etc/groups in nginx proxy container. We also have to change their home directory.</p>
<p>First, on off1, I did verify we have same users in our sshd config by using:</p>
<div class="highlight"><pre><span></span><code>grep<span class="w"> </span><span class="s2">&quot;^Match User&quot;</span><span class="w"> </span>/etc/ssh/sshd_config<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot; &quot;</span><span class="w"> </span>-f<span class="w"> </span><span class="m">3</span><span class="p">|</span><span class="w"> </span>sort
grep<span class="w"> </span>/home/sftp<span class="w"> </span>/etc/passwd<span class="p">|</span>cut<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;:&quot;</span><span class="w"> </span>-f<span class="w"> </span><span class="m">1</span><span class="p">|</span>sort
</code></pre></div>
<ul>
<li>sodebo is repeated in sshd_config, I fixed that.</li>
<li>test is in /etc/passwd but not in sshd_config, so I removed it.</li>
</ul>
<p>On off1:
<div class="highlight"><pre><span></span><code>grep<span class="w"> </span>/home/sftp<span class="w"> </span>/etc/passwd
</code></pre></div></p>
<p>I made a regexp to get all name and grep them from shadow and groups
<div class="highlight"><pre><span></span><code><span class="nv">exp</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span>/home/sftp<span class="w"> </span>/etc/passwd<span class="p">|</span>cut<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;:&quot;</span><span class="w"> </span>-f<span class="w"> </span><span class="m">1</span><span class="p">|</span>sort<span class="p">|</span>tr<span class="w">  </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="s1">&#39;|&#39;</span><span class="k">)</span>
<span class="nv">exp</span><span class="o">=</span><span class="s2">&quot;(&quot;</span><span class="nv">$exp</span><span class="s2">&quot;nonexistinguser)&quot;</span>

sudo<span class="w"> </span>grep<span class="w"> </span>-P<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$exp</span><span class="s2">&quot;</span><span class="w"> </span>/etc/shadow
sudo<span class="w"> </span>grep<span class="w"> </span>-P<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$exp</span><span class="s2">&quot;</span><span class="w"> </span>/etc/groups
</code></pre></div></p>
<p>We add the corresponding result on the reverse proxy to <code>/etc/passwd</code> and <code>/etc/shadow</code>,
using <code>vipw -p</code> and <code>vipw -s</code>.</p>
<p>We also have to change their home directory in <code>/etc/passwd</code> to point to the shared directory. We do so using <code>vipw -p</code> (in vi: <code>:%s!\/home\/sftp!\/mnt/off-pro/sftp!g</code>)</p>
<p>All those users are in sftponly group. So on reverse proxy we first add the group to <code>/etc/groups</code> using <code>vipw -g</code> (adding <code>sftponly:x:1006:</code>).
As this is the primary group for all those users, it is already set in <code>/etc/passwd</code> by previous edit</p>
<h2 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">#</a></h2>
<p>To test my installation I added this to <code>/etc/hosts</code> on my computer:
<div class="highlight"><pre><span></span><code>213.36.253.214 fr.openfoodfacts.org world-fr.openfoodfacts.org static.openfoodfacts.org images.openfoodfacts.org world.openfoodfacts.org
213.36.253.214 fr.pro.openfoodfacts.org world-fr.pro.openfoodfacts.org static.pro.openfoodfacts.org images.pro.openfoodfacts.org world.pro.openfoodfacts.org
</code></pre></div></p>
<h2 id="production-switch">Production switch<a class="headerlink" href="#production-switch" title="Permanent link">#</a></h2>
<h3 id="todo-before-switch">TODO before switch<a class="headerlink" href="#todo-before-switch" title="Permanent link">#</a></h3>
<ul>
<li><strong>DONE</strong> snapshot_purge should handle zfs/nvme !!!</li>
<li><strong>DONE</strong> handle sftp server for imports --&gt; on proxy to have direct network</li>
<li><strong>DONE</strong> handles html/files - should be in git ?<ul>
<li>keep files in data</li>
<li>rename in git<ul>
<li>keep tagline ?</li>
<li>keep ingredients analysis</li>
</ul>
</li>
<li>link needed files there</li>
<li>move data/debug</li>
</ul>
</li>
<li><strong>DONE</strong> move away things that are in html/files or do symlink for content that is in git ? Also files/debug for knowledge panels</li>
<li><strong>DONE</strong> create ZFS dataset for <code>/var/log</code></li>
<li><strong>DONE</strong> consider labelme deprecated. No data to recover it was on off2</li>
</ul>
<ul>
<li><strong>DONE</strong> is there anything to save for foodbattle ?<ul>
<li>(done) code in /srv2/foodbattle</li>
<li>data in mongodb (none)</li>
<li>shared users folder with off</li>
</ul>
</li>
<li><strong>DONE</strong> do we need as same as /root/scripts/renew_wildcard_certificates.sh on VM 101 (reverse proxy) on ovh1 ?<ul>
<li>I don't think so, because certbot is able to handle this thanks to info in /etc/letsencrypt/renewal/openfoodfacts.org.conf</li>
</ul>
</li>
</ul>
<ul>
<li><strong>DONE</strong> (alex): make agena and equadis imports run on off-pro side<ul>
<li>(alex) modify scripts</li>
<li>(stephane) test xml_to_json.pl vs xml_to_json.js</li>
<li>(alex) make a specific systemd task for producers imports</li>
<li><strong>DONE</strong> (alex) test scripts (up to the maximum) </li>
</ul>
</li>
</ul>
<ul>
<li><strong>DONE</strong> make a list of what we will rsync and what to backup from off1<ul>
<li>we already have backup of /srv and /srv2 on ovh3 !</li>
</ul>
</li>
</ul>
<ul>
<li><strong>DONE</strong> move madenearme<em>.htm and cestemballe</em>.html in ZFS and serve with nginx - or just serve them with nginx in container ?<ul>
<li>(done) test map with reverse proxy</li>
<li>(done) make a specific systemd task for madenear.me generation</li>
<li>(done) install and test it</li>
</ul>
</li>
</ul>
<ul>
<li><strong>DONE</strong> (alex) migrate howmanysugar<ul>
<li>put html in html/data</li>
<li>it's ok if gen_sugar does not work</li>
<li>sugar_random and sugar_check should work (to fix)</li>
</ul>
</li>
</ul>
<ul>
<li><strong>DONE</strong> have a well identified secrets directory for various secrets used by sh scripts (for those of perl, use Config2) --&gt; see <a href="#copying-secrets">Copying secrets</a><ul>
<li>ftp secrets (.netrc)</li>
</ul>
</li>
</ul>
<ul>
<li><strong>WONTFIX</strong> do we need /srv/off/imports where to put it in new layout (not yet in Paths.pm)<ul>
<li>We finally get rid of it</li>
</ul>
</li>
</ul>
<ul>
<li><strong>DONE:</strong> migrate ip tables rules<ul>
<li>on reverse proxy</li>
<li>(done) use fail2ban instead of iptables - see <a href="../../how-to-fail2ban-ban-bots/">How to use fail2ban to ban bots</a></li>
<li>(wontfix) we dont continue with the cron tail -n 10000 /srv/off/logs/access_log | grep search | /srv/off/logs/ban_abusive_ip.pl &gt; /dev/null 2&gt;&amp;1 for now</li>
<li>NOTE: in parallel we are setting up rate limiting with nginx which could then be combined with fail2ban on 409 errors (easy to add to auth error bans)</li>
</ul>
</li>
</ul>
<ul>
<li><strong>WONTFIX</strong> fix all scripts (eg. split_gs1_codeonline_json.pl) which use /srv/codeonline/imports as input and /srv2/off/codeonline/imports as output !<ul>
<li>codeonline is obsolete --&gt; moved to obsolete</li>
</ul>
</li>
</ul>
<ul>
<li><strong>DONE</strong> what about zfs-old, can we add it to zfs-nvme ? (no)<ul>
<li>see <a href="#removing-zfs-old-and-adding-as-cache-to-zfs-hdd">removing zfs-old and adding as cache to zfs-hdd</a></li>
</ul>
</li>
</ul>
<ul>
<li><strong>DONE</strong> change my user uid/gid on off2 and create a off user with uid 1000
  to avoid ps -elf giving misleading information.<ul>
<li>I ssh on off2 from off1 as root (because I will need to kill sshd process for alex)</li>
<li>change name and description: <code>usermod  -c "OFF service account" -l off alex</code> (after killing some processes though)</li>
<li>change group name <code>groupmod -n off alex</code> and remove from sudo <code>deluser off sudo</code></li>
<li><code>mkdir /home/off; cp /etc/skel/.* /home/off/; chown -R off:off /home/off; usermod -d /home/off off</code></li>
<li>recreated my user <code>adduser alex</code> and change home owner <code>chown -R alex:alex /home/alex</code> and add to sudoers <code>adduser alex sudo</code></li>
</ul>
</li>
</ul>
<ul>
<li><strong>WONTFIX</strong> high fragmentation on ssd -- seems ok since it's not a problem for read and it will write back small files</li>
</ul>
<ul>
<li>are we writting to lang/ ?<ul>
<li><strong>WONTFIX</strong> Missions.pm does --&gt; we don't use it anymore ? however change the code to be sure (dying)</li>
<li><strong>WONTFIX</strong> added a fixme to gen_sucres.pl and gen_sugar.pl</li>
<li><strong>DONE</strong> gen_top_tags_per_country does --&gt; move it to another folder (data/stats) and change display.pm logic</li>
</ul>
</li>
</ul>
<ul>
<li>(done) add export_producers_platform_data_to_public_database.sh to producers import task on off-pro (instead of a specific cron)</li>
</ul>
<ul>
<li><strong>DOING</strong> backup problem on 114<ul>
<li>this seems to be a permission problem, fixed by Stephane</li>
</ul>
</li>
</ul>
<ul>
<li><strong>DOING</strong> imports (to run on off-pro side):<ul>
<li><strong>DONE</strong> agena3000 (almost done - to test)</li>
<li><strong>DONE</strong> equadis (almost done - to test)</li>
<li><strong>DONE</strong> carrefour<ul>
<li>modify to run on off-pro side + convert to new syntax + avoid having script inside sftp folder</li>
</ul>
</li>
<li>fleurymichon deactivated (no data since 2021 - to be relaunched)</li>
<li>systemu is manual</li>
<li>casino was manual</li>
<li>bayard is a wip</li>
<li>intermarches is not auto but manual yet</li>
</ul>
</li>
</ul>
<ul>
<li>docs:<ul>
<li><strong>FIXME</strong> update all the documentation from install logs !</li>
<li><strong>TODO</strong> migrate https://docs.google.com/document/d/1w5PpPB80knF0GR_nevWudz3zh7oNerJaQUJH0vIPjPQ/edit#heading=h.j4z4jdw3tr8r to this documentation</li>
</ul>
</li>
</ul>
<ul>
<li><strong>WONTFIX</strong>  stress test VM on CPU and on Memory</li>
</ul>
<ul>
<li><strong>DONE</strong> schedule gen feeds smartly -- easy start off at 2am, the other platforms before</li>
</ul>
<ul>
<li><strong>DONE</strong> review the VM limits configurations<ul>
<li>see https://docs.google.com/spreadsheets/d/19RePmE_-1V_He73fpMJYukEMjPWNmav1610yjpGKfD0/edit#gid=28709804</li>
</ul>
</li>
<li><strong>FIXME</strong>: communicate on sftp IP change.</li>
<li><strong>FIXME</strong> see how to have rules to block ips for images nginx which is directly on off2<ul>
<li>rate limit test running on off2</li>
<li>fail2ban might be a good idea</li>
</ul>
</li>
</ul>
<ul>
<li><strong>DOING</strong> make a point on backup:<ul>
<li>see what is in the backups of vz_dump: only the container disks</li>
<li>containers - on ZFS why don't we sync them on ovh3</li>
<li>eg imagine a fire at free - can we re-install ?</li>
<li><strong>DOING</strong> syncing PVE volumes to OVH3</li>
</ul>
</li>
</ul>
<ul>
<li><strong>DONE</strong> logrotate problem on nginx logs on reverse proxy</li>
</ul>
<ul>
<li><strong>DONE</strong> add alerting on logrotate failing</li>
</ul>
<div class="highlight"><pre><span></span><code>service: Failed to set up mount namespacing: /run/systemd/unit-root/proc: Permission denied
service: Failed at step NAMESPACE spawning /usr/sbin/logrotate: Permission denied
</code></pre></div>
<h3 id="backup-data">Backup data<a class="headerlink" href="#backup-data" title="Permanent link">#</a></h3>
<p><strong>FIXME</strong>: list what we should backup</p>
<p>html/illustrations
scripts/*.csv
/srv2/backup ?</p>
<p>/home/off ?
/home/off ?
/home/off ?</p>
<h4 id="code">code<a class="headerlink" href="#code" title="Permanent link">#</a></h4>
<ul>
<li>/home/scripts - already done in off-infrastructure<ul>
<li>ftpbackup - obsolete (warning password inside)</li>
<li>remote_backup.sh - obsolete</li>
</ul>
</li>
</ul>
<h4 id="users-data">users data<a class="headerlink" href="#users-data" title="Permanent link">#</a></h4>
<div class="highlight"><pre><span></span><code>rsync<span class="w"> </span>-a<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv2/stephane<span class="w"> </span>/zfs-hdd/backups/off1-2023/srv2-stephane
rsync<span class="w"> </span>-a<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv2/teolemon<span class="w"> </span>/zfs-hdd/backups/off1-2023/srv2-teolemon
</code></pre></div>
<h4 id="foodbatle">foodbatle<a class="headerlink" href="#foodbatle" title="Permanent link">#</a></h4>
<p>on off2:
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>/zfs-hdd/backups/off1-2023
rsync<span class="w"> </span>-a<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv2/foodbattle<span class="w"> </span>/zfs-hdd/backups/off1-2023/
</code></pre></div></p>
<p>I look at the mongodb but did not find any foodbattle databas</p>
<h3 id="rsync-data">Rsync data<a class="headerlink" href="#rsync-data" title="Permanent link">#</a></h3>
<p>This is the data rsync sequence:</p>
<p>off:</p>
<div class="highlight"><pre><span></span><code>date<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;== users -- note: also done in crontab&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off/users<span class="w">  </span>/zfs-hdd/off/users<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;== orgs -- note: also done in crontab&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off/orgs<span class="w">  </span>/zfs-hdd/off/orgs<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;== some cache folders&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off/<span class="o">{</span>build-cache,tmp,debug,new_images<span class="o">}</span><span class="w"> </span>/zfs-hdd/off/cache/<span class="w"> </span><span class="p">;</span><span class="se">\</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;== data folders (shared with off-pro)&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off/data<span class="w"> </span>/zfs-hdd/off/<span class="w"> </span><span class="p">;</span><span class="se">\</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;== other data&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off/<span class="o">{</span>deleted.images,deleted_products,deleted_products_images<span class="o">}</span><span class="w"> </span>/zfs-hdd/off/<span class="w"> </span><span class="p">;</span><span class="se">\</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;== imports for off&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv2/off/imports<span class="w"> </span>/zfs-hdd/off/<span class="w"> </span><span class="p">;</span><span class="se">\</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;== translations for off&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off/translate<span class="w"> </span>/zfs-hdd/off/<span class="w"> </span><span class="p">;</span><span class="se">\</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;== reverted_products on off&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off/reverted_products<span class="w"> </span>/zfs-hdd/off/<span class="w"> </span><span class="p">;</span><span class="se">\</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;== html/data&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off/html/data/<span class="w"> </span>/zfs-hdd/off/html_data<span class="w"> </span><span class="p">;</span><span class="se">\</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off/html/<span class="o">{</span>files,exports<span class="o">}</span><span class="w"> </span>/zfs-hdd/off/html_data/<span class="w"> </span><span class="p">;</span><span class="se">\</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv2/off/html/dump<span class="w"> </span>/zfs-hdd/off/html_data/<span class="w"> </span><span class="p">;</span><span class="se">\</span>
date
</code></pre></div>
<p>off-pro:</p>
<div class="highlight"><pre><span></span><code>date<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;== pro images&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv2/off-pro/html/images/products<span class="w"> </span>/zfs-hdd/off-pro/images/<span class="w"> </span><span class="p">;</span><span class="se">\</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;== some cache folders&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off-pro/<span class="o">{</span>build-cache,tmp,debug<span class="o">}</span><span class="w"> </span>/zfs-hdd/off-pro/cache/<span class="w"> </span><span class="p">;</span><span class="se">\</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;== other data&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off-pro/<span class="o">{</span>deleted.images,deleted_private_products<span class="o">}</span><span class="w"> </span>/zfs-hdd/off-pro/<span class="w"> </span><span class="p">;</span><span class="se">\</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;== html/data&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off-pro/html/data/<span class="w"> </span>/zfs-hdd/off-pro/html_data<span class="w"> </span><span class="p">;</span><span class="se">\</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/off-pro/html/files<span class="w"> </span>/zfs-hdd/off-pro/html_data/<span class="w"> </span><span class="p">;</span><span class="se">\</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;== sftp&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>-a<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/sftp/<span class="w"> </span>/zfs-hdd/off-pro/sftp/<span class="w"> </span><span class="p">;</span><span class="se">\</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;== sugar&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>-a<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/sugar/logs/sugar_log<span class="w"> </span>/zfs-hdd/off/data/sugar/old_sugar_log<span class="w"> </span><span class="p">;</span><span class="se">\</span>
date
</code></pre></div>
<p>This took a bit more than 6 hours on 2023-11-22.</p>
<p>Don't forget to also change ownership if needed</p>
<div class="highlight"><pre><span></span><code>chown<span class="w"> </span>-R<span class="w"> </span><span class="m">1000</span>:1000<span class="w"> </span>/zfs-hdd/off<span class="o">{</span>,-pro<span class="o">}</span>/cache
</code></pre></div>
<h3 id="procedure-for-switch-of-off-and-off-pro-from-off1-to-off2">Procedure for switch of off and off-pro from off1 to off2<a class="headerlink" href="#procedure-for-switch-of-off-and-off-pro-from-off1-to-off2" title="Permanent link">#</a></h3>
<p><strong>NOTE</strong>: we do both in a row because we don't want to deal with NFS for off / off-pro communication</p>
<p><strong>WARNING</strong>: finish writing it before running it !!!</p>
<ol>
<li>
<p>change TTL to a low value in DNS</p>
<ul>
<li><strong>DONE</strong> for openfoodfacts domains (including pro)</li>
<li>for madenear.me madenear.me.uk cestemballepresdechezvous and all other domains</li>
<li>for howmuchsugar.in combiendesucres.fr and all other domains</li>
</ul>
</li>
<li>
<p>update the product to latest changes in <code>/srv/off</code> or <code>/srv/off-pro</code> and <code>/srv/openfoodfacts-web</code></p>
</li>
<li>
<p>Redeploy the dist of off and off-pro on off2</p>
</li>
<li>
<p>verify differences between Config2 files (for off and off-pro) between off1 and off</p>
<ul>
<li>I had to add <code>query_url</code> which is new</li>
</ul>
</li>
<li>
<p>restart:</p>
<ul>
<li>on off: <code>sudo systemctl restart apache2.service nginx.service cloud_vision_ocr@off.service minion@off.service</code></li>
<li>on off-pro: <code>sudo systemctl restart apache2.service nginx.service cloud_vision_ocr@off-pro.service minion@off-pro.service</code></li>
</ul>
</li>
<li>
<p>do a last test:</p>
<ul>
<li>I had to redo a <code>sudo cpanm --notest --quiet --skip-satisfied --installdeps .</code></li>
<li>I forgot to run the build_lang and build_taxonomies scripts</li>
<li>problem on pro platform for products without barcode: <code>internal_code.sto</code> not accessible on pro platform</li>
</ul>
</li>
<li>
<p>shutdown:</p>
<ul>
<li>off on <strong>off2</strong> <code>sudo systemctl stop apache2 nginx</code></li>
<li>off-pro on <strong>off2</strong> <code>sudo systemctl stop apache2 nginx</code></li>
</ul>
</li>
<li>
<p>on off1 comment users and orgs rsync in crontab</p>
</li>
<li>
<p>Rync all data (on off2):
   see above  <a href="#rsync-data">Rsync data</a></p>
</li>
<li>
<p>products sync, on off1:</p>
<ul>
<li>comment sto-products-sync.sh in root crontab</li>
<li>launch it a last time by hand</li>
</ul>
</li>
<li>
<p>clean cron:</p>
<ul>
<li>comment gen_all_feeds and gen_all_feeds_daily from crontab</li>
</ul>
</li>
<li>
<p>shutdown off and off-pro on both side
   on off1:
   <div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>stop<span class="w"> </span>apache2@off
systemctl<span class="w"> </span>stop<span class="w"> </span>apache2@off-pro
unlink<span class="w"> </span>/etc/nginx/sites-enabled/off<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>unlink<span class="w"> </span>/etc/nginx/sites-enabled/off-pro<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>systemctl<span class="w"> </span>reload<span class="w"> </span>nginx
</code></pre></div></p>
</li>
<li>
<p>change DNS to point to new machine for openfoodfacts.org pro.openfoodfacts.org</p>
</li>
<li>
<p>Rsync and zfs sync again (see above)</p>
</li>
<li>
<p>ensure migrations works using mounts for off2 apps, and point to new user folder:</p>
<ul>
<li>edit 110 to 112 mount points to mount off volumes (products and users) instead of NFS shares, by editing <code>/etc/pve/lxc/11{0..2}.conf</code></li>
<li>restart 110 to 112: <code>for num in 11{0..2}; do  pct reboot $num; done</code></li>
<li>save your new settings to git folder: <code>for num in 11{0..2}; do cp /etc/pve/lxc/$num.conf /opt/openfoodfacts-infrastructure/confs/off2/pve/lxc_$num.conf; done</code></li>
</ul>
</li>
<li>
<p>start :</p>
<ul>
<li>off on container off2/113 (off): <code>sudo systemctl start apache2 nginx</code></li>
<li>off-pro  on container off2/114 (off-pro): <code>sudo systemctl start apache2 nginx</code></li>
</ul>
</li>
<li>
<p>check it works (remember to also clean your /etc/hosts if you modified it for tests)</p>
</li>
<li>
<p>change DNS for madenear.me cestemballepresdechezvous.fr madenear.me.uk</p>
</li>
<li>
<p>regenerate the certificate for madenearme to have all domains:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test first</span>
certbot<span class="w"> </span>certonly<span class="w"> </span>--test-cert<span class="w"> </span>-d<span class="w"> </span>madenear.me<span class="w"> </span>-d<span class="w"> </span>cestemballepresdechezvous.fr<span class="w"> </span>-d<span class="w"> </span>madenear.me.uk
<span class="c1"># do it for real</span>
certbot<span class="w"> </span>certonly<span class="w"> </span>-d<span class="w"> </span>madenear.me<span class="w"> </span>-d<span class="w"> </span>cestemballepresdechezvous.fr<span class="w"> </span>-d<span class="w"> </span>madenear.me.uk
</code></pre></div>
<p>(note: we had to change nginx site configuration and use web root authenticator)</p>
</li>
<li>
<p>change DNS for howmuchsugar.in combiendesucres.fr</p>
</li>
<li>
<p>regenerate the certificate for howmuchsugar.in to have all domains:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># test first</span>
certbot<span class="w"> </span>certonly<span class="w"> </span>--test-cert<span class="w"> </span>-d<span class="w"> </span>howmuchsugar.in<span class="w"> </span>-d<span class="w"> </span>combiendesucres.fr
<span class="c1"># do it for real</span>
certbot<span class="w"> </span>certonly<span class="w"> </span>-d<span class="w"> </span>howmuchsugar.in<span class="w"> </span>-d<span class="w"> </span>combiendesucres.fr
</code></pre></div>
<p>(note: we had to change nginx site configuration and use web root authenticator)</p>
</li>
<li>
<p>disable off and off-pro service on off1:</p>
<ul>
<li><code>systemctl disable apache2@off</code></li>
<li><code>systemctl disable apache2@off-pro</code></li>
<li><strong>TODO</strong> <code>unlink /etc/nginx/sites-enabled/off &amp;&amp; unlink /etc/nginx/sites-enabled/off-pro &amp;&amp; sytemctl reload nginx</code> (if not already done)</li>
</ul>
</li>
<li>
<p>remove off and off-pro from snapshot-purge.sh on ovh3 (now handled by sanoid)</p>
</li>
<li>on off2 and ovh3 modify sanoid configuration to have off/products and off-pro/products handled by sanoid and synced to ovh3</li>
<li>
<p>don't forget to test that it still works after that</p>
</li>
<li>
<p>off1 cleanup:
    - remove or comment <code>/etc/logrotate.d/apache2-off</code>
    - remove or comment <code>/etc/logrotate.d/apache2-off-pro</code></p>
</li>
<li>
<p>off2 cleanup:
    - remove the NFS mounts of off1 off and off-pro data</p>
</li>
</ol>
<h3 id="checks-after-one-day">Checks after one day<a class="headerlink" href="#checks-after-one-day" title="Permanent link">#</a></h3>
<ul>
<li>check OCR is working</li>
<li>check syncs happens</li>
<li>check tag line is accessible (eg: https://world.openfoodfacts.org/files/tagline-off.json https://world.openfoodfacts.org/files/app/tagline/tagline-off-ios.json) even after removing those files from /srv/off/html/files/
<strong>FIXME</strong>: add more</li>
</ul>
<p>see also: https://github.com/openfoodfacts/openfoodfacts-server/issues/9373</p>
<h3 id="checks-after-five-days">Checks after five days<a class="headerlink" href="#checks-after-five-days" title="Permanent link">#</a></h3>
<ul>
<li>check OCR is working</li>
<li>check syncs happens</li>
<li>check sftp still happens
<strong>FIXME</strong>: add more</li>
</ul>
<h3 id="todo-after-off1-re-install">TODO after off1 re-install<a class="headerlink" href="#todo-after-off1-re-install" title="Permanent link">#</a></h3>
<ul>
<li>add replications</li>
</ul>
<ul>
<li>add a restart of nginx in the certbot thing (or at night)
<div class="highlight"><pre><span></span><code># restart nginx to reload SSL certs
0 11 * * * systemctl restart nginx
</code></pre></div></li>
</ul>
<h3 id="todo-to-have-more-things-working">TODO to have more things working<a class="headerlink" href="#todo-to-have-more-things-working" title="Permanent link">#</a></h3>
<ul>
<li>add prometheus exporters to all machines:<ul>
<li>for nginx on reverse proxy</li>
<li>for memcached on memcached container</li>
<li>for postgres on postgresql container</li>
<li>for apache on off/obf/opf/opff/off-pro</li>
</ul>
</li>
</ul>
<ul>
<li><strong>FIXME</strong> put logs on zfs dataset for obf / opf / opff</li>
</ul>
<ul>
<li>add go access report on reverse proxy</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.bd41221c.min.js"></script>
      
    
  <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>