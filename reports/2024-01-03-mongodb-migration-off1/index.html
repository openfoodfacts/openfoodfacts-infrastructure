
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../2024-01-02-monitoring-disk-space/">
      
      
        <link rel="next" href="../2024-01-04-setting-up-stunnel/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.40">
    
    
      
        <title>2024-01-03 MongoDB migration on off3 - Open Food Facts Infrastructure documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8c3ca2c6.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2024-01-03-mongodb-migration-on-off3" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Open Food Facts Infrastructure documentation" class="md-header__button md-logo" aria-label="Open Food Facts Infrastructure documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Open Food Facts Infrastructure documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2024-01-03 MongoDB migration on off3
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/openfoodfacts/openfoodfacts-infrastructure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Open Food Facts Infrastructure documentation" class="md-nav__button md-logo" aria-label="Open Food Facts Infrastructure documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Open Food Facts Infrastructure documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/openfoodfacts/openfoodfacts-infrastructure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Open Food Facts Infrastructure
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cicd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Continous Integration and Continuous Delivery
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../discourse/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Discourse
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../disks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Disks
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker at Open Food Facts
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../docker_architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker architecture
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../docker_onboarding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Onboarding
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../explain-server-config-in-git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Explanation on server configuration with git
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../folksonomy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Folksonomy API
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../free-datacenter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Free Datacenter
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-add-disk-space-on-qemu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to add disk space on a Qemu VM
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-fail2ban-ban-bots/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to use fail2ban to ban bots
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-fail2ban-debian-11%2B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to install fail2ban on debian 11+
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-have-server-config-in-git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to have server config in git
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-mitigate-crawlers-on-prod/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to mitigate crawlers in case of too much traffic
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-resync-zfs-replication/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to resync ZFS replication
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux-server/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux server
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-off1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    off1 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-off2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    off2 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-off3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    off3 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-ovh1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ovh1 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-ovh2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ovh2 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-ovh3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ovh3 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mail/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mail on Open Food Facts infrastructure
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../matomo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Matomo
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../moji-datacenter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Moji Datacenter
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mongodb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MongoDB
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../munin/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Munin
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nginx-reverse-proxy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NGINX Reverse proxy
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Observability
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../odoo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Odoo: our relationship management (connect.openfoodfacts.org)
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../openfoodfacts-query/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Open Food Facts Query
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Infrastructure overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../postgres/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PostgreSQL
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../prod-architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Production architecture
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../producers_sftp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Producers SFTP
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../product-opener/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Product Opener
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../proxmox/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Proxmox
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rclone/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rclone
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sanoid/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sanoid
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../slackin/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    auto Slack invitation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../stunnel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Stunnel
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../zammad/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Zammad
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../zfs-overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ZFS overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_46" checked>
        
          
          <label class="md-nav__link" for="__nav_46" id="__nav_46_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reports
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_46_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_46">
            <span class="md-nav__icon md-icon"></span>
            Reports
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-02-22-matomo-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Matomo install
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-10-03-network-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    [Postmortem] OpenFoodFacts.net down (#1)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-12-21-disk-extension/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Disk extension for preprod and containers prod (ovh2)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-12-22-preprod-crash/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preprod crash 2021 12
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-18-ovh-reverse-proxy-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    [Postmortem] Reverse proxy down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-proxmox-mail-gateway-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Install of proxmox gateway server
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-remove-containers-ovh1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-02 Removing some containers on ovh1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-03-03-zammad-elasticsearch-not-running/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Elasticsearch not running on Zammad
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-03-off2-PCI-NVMe-problems/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-03 Problem with PCI supporting NVMe
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-07-08-journey-to-deploy-off-search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deploying openfoodfacts-search to staging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-07-11-infra-workshop/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Infrastructure future - workshop on 11th July 2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-07-kibana-down-es-circuit-breaking-exception/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kibana down because of Elasticsearch circuit_breaking_exception
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-08-17-openfoodfacts-net-unreachable/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-08-17 openfoodfacts.net unreachable
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-09-23-odoo-setup-for-pro-platform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup of Odoo for pro platform
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-11-09-monitoring-move-to-own-vm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-11 moving monitoring to its own machine
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-13-zammad-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-02-13 Zammad down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-16-off2-shutdown/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 02 16 off2 shutdown
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-17-off2-upgrade/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-02-17 Off2 Upgrade
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-24-zfs-introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 02 24 zfs introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-03-14-off2-opff-reinstall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-03 OFF2 reinstall - opff migration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-04-27-moving-docker-stagging-to-ovh1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-04-27 moving docker staging to OVH1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-12-refresh-staging-clones/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-05-12 refresh staging clones
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-19-overload-of-osm-machine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-05-18 Mongodb down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-23-move-images-to-zfs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-05-23 move Images to ZFS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-off2-110-unreachable/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-05-23 off2 - container 110 unreachable from 101
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-01-robotoff-backups/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-01 Robotoff backups
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-07-off2-opf-obf-reinstall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-07 OPF and OBF reinstall on off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-08-stalled-zfs-sync-off-products/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2012-06-08 Stalled ZFS Sync for off products on ovh3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-30-sanoid-checks-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-30 Sanoid checks install
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-07-16-ovh3-sdc-broken/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Post-mortem 2023-07-16 Disk sdc errors on OVH3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-07-26-off1-rpool-products-full/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-07-26 rpool/off/products dataset full on off1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-07-off-reinstall--prod-files-diff/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 07 off reinstall  prod files diff
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-07-off2-off-reinstall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-07 OFF and OFF-pro reinstall on off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-08-31-off2-products-snapshots-clean/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-08-31 OFF2 products snapshots clean
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-09-27-expired-ssl-certificate-for-images-on-off2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-09-27 / Expired SSL certificate for images.openfoodfacts.org on off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-10-14-mongodb-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-10-14: mongodb-down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-11-28-google-drive-backup-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-11-28 setup a google drive backup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-11-28-ovh3-sdf-broken/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Post-mortem 2023-11-28 Disk sdf errors on OVH3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-12-08-off1-upgrade/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-12-08 off1 upgrade
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-12-11-matomo-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-12-11 Matomo down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-02-monitoring-disk-space/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01-02 monitoring disk space - filebeat
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    2024-01-03 MongoDB migration on off3
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    2024-01-03 MongoDB migration on off3
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#context" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-container" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a container
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing-mongodb" class="md-nav__link">
    <span class="md-ellipsis">
      Installing MongoDB
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cloning-repos" class="md-nav__link">
    <span class="md-ellipsis">
      cloning repos
    </span>
  </a>
  
    <nav class="md-nav" aria-label="cloning repos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#infrastructure-repository" class="md-nav__link">
    <span class="md-ellipsis">
      Infrastructure repository
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#off-server-repository" class="md-nav__link">
    <span class="md-ellipsis">
      OFF server repository
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setting up">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-up-cron-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      setting up cron jobs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migrating-data-for-a-test" class="md-nav__link">
    <span class="md-ellipsis">
      Migrating data for a test
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Migrating data for a test">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#trying-with-a-simple-rsync-does-not-works" class="md-nav__link">
    <span class="md-ellipsis">
      trying with a simple rsync (does not works)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-stunnel" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up stunnel
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cron-job-for-tags-collection-generation-on-opf-opff-obf" class="md-nav__link">
    <span class="md-ellipsis">
      Cron job for tags collection generation on opf / opff / obf
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migration-procedure" class="md-nav__link">
    <span class="md-ellipsis">
      Migration procedure
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-04-setting-up-stunnel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024 01 04 setting up stunnel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-19-certbot-failure-off2-proxy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01-19 Certbot failure on off2 reverse proxy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-24-move-old-productopener-folders-to-backup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01-24 Move old Product Opener folders to backup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-matomo-perf-tunning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01 Matomo performance tunning
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-06-cleanup-products-snapshots/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-06 cleanup of products ssnapshots on off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-08-prod-redis-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-08 Production Redis install
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-13-chatwoot-translation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-13 Chatwoot translation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-13-matomo-fix-queue0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2014-02-13 Matomo fix Queue0
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-20-exporter-on-mongodb-ct/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-20 Installing a prometheus exporter on mongodb container
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-28-upgrade-redis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-28 Upgrade Redis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-03-17-ovh1-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-03-17 OVH1 Down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-03-restructure-backups/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-03 Restructure backups
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-03-separate-hdd-docker-vms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-03 separate HDD on docker VMs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-04-03-moving-opf-obf-opff-logs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-03-04 Moving opf, obf and opff logs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-04-12-install-off-query-off1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-04 install off-query on off1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-04-18-matomo-multi-archival/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-04-18 Matomo multi archival
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-04-18-setup-dkim-google-workspace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-04-18 Setup DKIM on Google Workspace
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-04-26-off2-obf-new-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-07 New install of OBF on OFF2 with new generic code
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-05-27-nginx-exporter-off2-proxy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Nginx exporter on off2 proxy and off
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-06-05-off1-reverse-proxy-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-06 OFF1 reverse proxy install + OFF images container
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-06-10-move-off-query-volume-to-nvme/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Move off query volume to NVME
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-06-20-move-ean8-directories/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Move EAN8 directories
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-08-03-ovh-reverse-proxy-ip-lost/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-08-03 OVH Reverse proxy IP lost
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-08-07-wordpress-off-contents-fresh-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-08-07-wordpress-off-contents-fresh-install
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-08-13-moji-server-installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Moji server installation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-08-22-postfix-exporter-on-pmg/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-08-22 Adding postfix exporter to Proxmox Mail Gateway
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-09-04-move-off-query-to-moji/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-09-04 Move off query to moji
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-09-05-adding-ipv6-to-off2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-09-05 adding ipv6 to off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-09-06-moji-post-installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Moji - Post-installation &amp; backup sync
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-09-06-test-folksonomy-openproductsfacts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-09-06 test folksonomy Open Products Facts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-09-24-kimsufi-stor-ks1-installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kimsufi STOR - ks1 installation
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#context" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-container" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a container
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing-mongodb" class="md-nav__link">
    <span class="md-ellipsis">
      Installing MongoDB
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cloning-repos" class="md-nav__link">
    <span class="md-ellipsis">
      cloning repos
    </span>
  </a>
  
    <nav class="md-nav" aria-label="cloning repos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#infrastructure-repository" class="md-nav__link">
    <span class="md-ellipsis">
      Infrastructure repository
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#off-server-repository" class="md-nav__link">
    <span class="md-ellipsis">
      OFF server repository
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setting up">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-up-cron-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      setting up cron jobs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migrating-data-for-a-test" class="md-nav__link">
    <span class="md-ellipsis">
      Migrating data for a test
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Migrating data for a test">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#trying-with-a-simple-rsync-does-not-works" class="md-nav__link">
    <span class="md-ellipsis">
      trying with a simple rsync (does not works)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-stunnel" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up stunnel
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cron-job-for-tags-collection-generation-on-opf-opff-obf" class="md-nav__link">
    <span class="md-ellipsis">
      Cron job for tags collection generation on opf / opff / obf
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migration-procedure" class="md-nav__link">
    <span class="md-ellipsis">
      Migration procedure
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="2024-01-03-mongodb-migration-on-off3">2024-01-03 MongoDB migration on off3<a class="headerlink" href="#2024-01-03-mongodb-migration-on-off3" title="Permanent link">#</a></h1>
<h2 id="context">Context<a class="headerlink" href="#context" title="Permanent link">#</a></h2>
<p>To <a href="../2023-02-17-off2-upgrade/">upgrade off2</a>, we moved MongoDB to a VM kindly provided by Open Street Map France (VM codename off3) on a server located in the same datacenter.</p>
<p>We Then moved all the stuff from off1 to off2. We then <a href="../2023-12-08-off1-upgrade/">upgrade off1</a>.</p>
<p>It's now time to move back MongoDB instance to the upgraded off1 server. It will be installed in a container as we now use <a href="../../proxmox/">proxmox</a></p>
<h2 id="creating-a-container">Creating a container<a class="headerlink" href="#creating-a-container" title="Permanent link">#</a></h2>
<p>We followed usual procedure to <a href="../../proxmox/#how-to-create-a-new-container">create a proxmox container</a>:</p>
<ul>
<li>of id 102</li>
<li>choosed a debian 10 (<strong>important</strong>: org version of mongodb 4.4 is not available in newly debian versions)</li>
<li>default storage on zfs-hdd (for system) 30Gb, noatime</li>
<li>add another storage mountpoint 0, on zfs-nvme mounted as /mongo with 96 Gb, noatime</li>
<li>15 cores</li>
<li>memory 131072 Mb (128 Gb), no swap</li>
</ul>
<p>Before running the ctpostinstall script, I had to change buster in sources list to oldoldstable.</p>
<p>I also <a href="../../mail/#postfix-configuration">configured email</a> in the container.</p>
<p>I also immediately created a off user for it to have id 1000.</p>
<h2 id="installing-mongodb">Installing MongoDB<a class="headerlink" href="#installing-mongodb" title="Permanent link">#</a></h2>
<p>We follow <a href="https://www.mongodb.com/docs/v4.4/tutorial/install-mongodb-on-debian/">MongoDB 4.4 install procedure</a></p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>gnupg<span class="w"> </span>curl
curl<span class="w"> </span>-fsSL<span class="w"> </span>https://pgp.mongodb.com/server-4.4.asc<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>sudo<span class="w"> </span>gpg<span class="w"> </span>-o<span class="w"> </span>/usr/share/keyrings/mongodb-server-4.4.gpg<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--dearmor
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;deb [ signed-by=/usr/share/keyrings/mongodb-server-4.4.gpg ] http://repo.mongodb.org/apt/debian buster/mongodb-org/4.4 main&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/mongodb-org-4.4.list
sudo<span class="w"> </span>apt-get<span class="w"> </span>update
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>mongodb-org

sudo<span class="w"> </span>systemctl<span class="w"> </span>daemon-reload
sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>mongod
sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>mongod
<span class="c1"># verify</span>
sudo<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>mongod
</code></pre></div>
<h2 id="cloning-repos">cloning repos<a class="headerlink" href="#cloning-repos" title="Permanent link">#</a></h2>
<h3 id="infrastructure-repository">Infrastructure repository<a class="headerlink" href="#infrastructure-repository" title="Permanent link">#</a></h3>
<p>Create root ssh key: <code>ssh-keygen -t ed25519 -C "root@mongodb"</code></p>
<p>Added root ssh pub key (<code>cat /root/.ssh/id_ed25519.pub</code>) as a <a href="https://github.com/openfoodfacts/openfoodfacts-infrastructure/settings/keys">deploy key to github infrastructure repository</a></p>
<p>Cloned
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>/opt
git<span class="w"> </span>clone<span class="w"> </span>git@github.com:openfoodfacts/openfoodfacts-infrastructure.git
</code></pre></div></p>
<h3 id="off-server-repository">OFF server repository<a class="headerlink" href="#off-server-repository" title="Permanent link">#</a></h3>
<p>We need Product Opener repository to get scripts we need to run routinely.</p>
<p>We can't use the same certificate for the git repository</p>
<p>Create root ssh key: <code>ssh-keygen -t ed25519 -C "root+off-server@mongodb" -f /root/.ssh/github_off-server -N ''</code></p>
<p>Added root ssh pub key (<code>cat /root/.ssh/github_off-server.pub</code>) as a <a href="https://github.com/openfoodfacts/openfoodfacts-server/settings/keys">deploy key to github server repository</a></p>
<p>Modified git config to use right key to connect to the repository:</p>
<div class="highlight"><pre><span></span><code>vim<span class="w"> </span>/root/.ssh/config
...
Host<span class="w"> </span>github.com-off-server
<span class="w">  </span>Hostname<span class="w"> </span>github.com
<span class="w">  </span><span class="nv">IdentityFile</span><span class="o">=</span>/root/.ssh/github_off-server
</code></pre></div>
<p>Cloned:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>/opt
git<span class="w"> </span>clone<span class="w"> </span>git@github.com-off-server:openfoodfacts/openfoodfacts-server.git
</code></pre></div>
<h2 id="setting-up">Setting up<a class="headerlink" href="#setting-up" title="Permanent link">#</a></h2>
<p>First I copied the off1 root public certificate to authorized_keys on off3, and ssh once to validate the key.</p>
<p>I stopped mongodb: <code>systemctl stop mongod</code></p>
<p>Then I prepared the directory for mongodb data:</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>/mongo/db
chown<span class="w"> </span>mongodb:mongodb<span class="w"> </span>/mongo/db
rmdir<span class="w"> </span>/var/lib/mongodb
ln<span class="w"> </span>-s<span class="w"> </span>/mongo/db<span class="w"> </span>/var/lib/mongodb
</code></pre></div>
<p>Copied mongodb config from off3. On off1, as well as logrotate configs:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># mongodb config</span>
rsync<span class="w"> </span><span class="m">10</span>.0.0.3:/etc/mongod.conf<span class="w"> </span>/zfs-hdd/pve/subvol-102-disk-0/opt/openfoodfacts-infrastructure/confs/mongodb/
<span class="c1"># logrotate configs</span>
rsync<span class="w"> </span><span class="m">10</span>.0.0.3:<span class="s2">&quot;/etc/logrotate.d/mongo*&quot;</span><span class="w"> </span>/zfs-hdd/pve/subvol-102-disk-0/opt/openfoodfacts-infrastructure/confs/mongodb/logrotate.d/
</code></pre></div>
<p>Linked the config:
<div class="highlight"><pre><span></span><code>mv<span class="w"> </span>/etc/mongod.conf<span class="o">{</span>,.dist<span class="o">}</span>
ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/mongodb/mongod.conf<span class="w"> </span>/etc/mongod.conf
ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/mongodb/logrotate.d/mongod<span class="w"> </span>/etc/logrotate.d/
ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/mongodb/logrotate.d/mongo_refresh_tags<span class="w"> </span>/etc/logrotate.d/
</code></pre></div></p>
<p>And restart mongodb <code>systemctl start mongod</code></p>
<p>And check <code>systemctl start mongod</code></p>
<h3 id="setting-up-cron-jobs">setting up cron jobs<a class="headerlink" href="#setting-up-cron-jobs" title="Permanent link">#</a></h3>
<p>On off3 we launched some mongodb scripts (namely <code>refresh_products_tags.js</code>) but they now disapeared from the product opener repository as we don't need them any more thanks to openfoodfacts-query project (see <a href="https://github.com/openfoodfacts/openfoodfacts-server/commit/90180247fe23cedcdcc32249fdb9d7b25bf6051d">openfoodfacts-server commit 90180247f</a>)</p>
<p>Still we need the product_tags collections for obf, opf and opff.</p>
<p><strong>TODO:</strong>
The right solution is to add mongo shell on their respective containers and call <code>refresh_products_tags.js</code> with <code>gen_feeds_daily_*.sh</code>.</p>
<h2 id="migrating-data-for-a-test">Migrating data for a test<a class="headerlink" href="#migrating-data-for-a-test" title="Permanent link">#</a></h2>
<h3 id="trying-with-a-simple-rsync-does-not-works">trying with a simple rsync (does not works)<a class="headerlink" href="#trying-with-a-simple-rsync-does-not-works" title="Permanent link">#</a></h3>
<p>We stop mongodb in mongodb container.</p>
<p>We use rsync from off2 to get data from off3:</p>
<p><div class="highlight"><pre><span></span><code><span class="c1"># beware we are on zfs-nvme dataset</span>
<span class="c1"># we also map off and mongodb username and groupname to 100108 and 100116</span>
<span class="c1"># (corresponding to mongodb user/group in mongodb container)</span>
<span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>-a<span class="w"> </span>--delete-delay<span class="w"> </span>--usermap<span class="o">=</span>mongodb:100108,off:100108<span class="w"> </span>--groupmap<span class="o">=</span>mongodb:100116,off:100116<span class="w"> </span><span class="m">10</span>.0.0.3:/mongo/db/<span class="w"> </span>/zfs-nvme/pve/subvol-102-disk-0/db/
</code></pre></div>
(it took 15 min).</p>
<p>Then I restarted mongodb.</p>
<p>Got an error <code>variable MONGODB_CONFIG_OVERRIDE_NOFORK == 1, overriding \"processManagement.fork\" to false</code>.</p>
<p>This <a href="https://stackoverflow.com/a/76293801/2886726">thread is interesting</a>.
With <code>systemctl cat mongod</code> I can see that I have <code>MONGODB_CONFIG_OVERRIDE_NOFORK</code> set on new container and not on old VM.</p>
<p>See also <a href="https://www.mongodb.com/docs/manual/reference/configuration-options/#file-format">MongoDB doc stating</a>:</p>
<blockquote>
<p>The Linux package init scripts included in the official MongoDB packages depend on specific values for systemLog.path, storage.dbPath, and processManagement.fork. If you modify these settings in the default configuration file, mongod may not start.</p>
</blockquote>
<p>The MONGODB_CONFIG_OVERRIDE_NOFORK was introduced by https://jira.mongodb.org/browse/SERVER-74845</p>
<p>Strangely in mongod.conf we keep default value which should be false...</p>
<p>Finally I <a href="https://github.com/mongodb/mongo/blob/r4.4.27/src/mongo/db/server_options_server_helpers.cpp#L132">saw in the code</a> that the message was just a log / warning not an error</p>
<p>But in <code>/var/log/mongodb/mongod.log</code> I found:
<div class="highlight"><pre><span></span><code>&quot;msg&quot;:&quot;ERROR: Cannot write pid file to {path_string}: {errAndStr_second}&quot;,&quot;attr&quot;:{&quot;path_string&quot;:&quot;/var/run/mongodb/mongod.pid&quot;,&quot;errAndStr_second&quot;:&quot;No such file or directory&quot;}
</code></pre></div></p>
<p>I removed the specific directive for pid file in mongod.conf and restarted mongodb.</p>
<p>Now I can see:
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="nt">&quot;t&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2024-01-04T16:33:33.069+00:00&quot;</span><span class="p">},</span><span class="nt">&quot;s&quot;</span><span class="p">:</span><span class="s2">&quot;W&quot;</span><span class="p">,</span><span class="w">  </span><span class="nt">&quot;c&quot;</span><span class="p">:</span><span class="s2">&quot;STORAGE&quot;</span><span class="p">,</span><span class="w">  </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">22271</span><span class="p">,</span><span class="w">   </span><span class="nt">&quot;ctx&quot;</span><span class="p">:</span><span class="s2">&quot;initan</span>
<span class="s2">dlisten&quot;</span><span class="p">,</span><span class="nt">&quot;msg&quot;</span><span class="p">:</span><span class="s2">&quot;Detected unclean shutdown - Lock file is not empty&quot;</span><span class="p">,</span><span class="nt">&quot;attr&quot;</span><span class="p">:{</span><span class="nt">&quot;lockFile&quot;</span><span class="p">:</span><span class="s2">&quot;/mongo/db/mo</span>
<span class="s2">ngod.lock&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="nt">&quot;t&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2024-01-04T16:33:33.069+00:00&quot;</span><span class="p">},</span><span class="nt">&quot;s&quot;</span><span class="p">:</span><span class="s2">&quot;I&quot;</span><span class="p">,</span><span class="w">  </span><span class="nt">&quot;c&quot;</span><span class="p">:</span><span class="s2">&quot;STORAGE&quot;</span><span class="p">,</span><span class="w">  </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">22270</span><span class="p">,</span><span class="w">   </span><span class="nt">&quot;ctx&quot;</span><span class="p">:</span><span class="s2">&quot;initan</span>
<span class="s2">dlisten&quot;</span><span class="p">,</span><span class="nt">&quot;msg&quot;</span><span class="p">:</span><span class="s2">&quot;Storage engine to use detected by data files&quot;</span><span class="p">,</span><span class="nt">&quot;attr&quot;</span><span class="p">:{</span><span class="nt">&quot;dbpath&quot;</span><span class="p">:</span><span class="s2">&quot;/mongo/db&quot;</span><span class="p">,</span><span class="nt">&quot;storageE</span>
<span class="nt">ngine&quot;</span><span class="p">:</span><span class="s2">&quot;wiredTiger&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="nt">&quot;t&quot;</span><span class="p">:{</span><span class="nt">&quot;$date&quot;</span><span class="p">:</span><span class="s2">&quot;2024-01-04T16:33:33.069+00:00&quot;</span><span class="p">},</span><span class="nt">&quot;s&quot;</span><span class="p">:</span><span class="s2">&quot;W&quot;</span><span class="p">,</span><span class="w">  </span><span class="nt">&quot;c&quot;</span><span class="p">:</span><span class="s2">&quot;STORAGE&quot;</span><span class="p">,</span><span class="w">  </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">22302</span><span class="p">,</span><span class="w">   </span><span class="nt">&quot;ctx&quot;</span><span class="p">:</span><span class="s2">&quot;initan</span>
<span class="s2">dlisten&quot;</span><span class="p">,</span><span class="nt">&quot;msg&quot;</span><span class="p">:</span><span class="s2">&quot;Recovering data from the last clean checkpoint.&quot;</span><span class="p">}</span>
<span class="err">...</span>
<span class="kc">f</span><span class="err">ile</span><span class="p">:</span><span class="err">WiredTigerHS.w</span><span class="kc">t</span><span class="p">,</span><span class="w"> </span><span class="err">hs_access</span><span class="p">:</span><span class="w"> </span><span class="err">__w</span><span class="kc">t</span><span class="err">_block_read_o</span><span class="kc">ff</span><span class="p">,</span><span class="w"> </span><span class="mi">286</span><span class="p">:</span><span class="w"> </span><span class="err">WiredTigerHS.w</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="err">po</span><span class="kc">tent</span><span class="err">ial</span><span class="w"> </span><span class="err">hardware</span>
<span class="w"> </span><span class="err">corrup</span><span class="kc">t</span><span class="err">io</span><span class="kc">n</span><span class="p">,</span><span class="w"> </span><span class="err">read</span><span class="w"> </span><span class="err">checksum</span><span class="w"> </span><span class="err">error</span><span class="w"> </span><span class="kc">f</span><span class="err">or</span><span class="w"> </span><span class="mi">4096</span><span class="err">B</span><span class="w"> </span><span class="err">block</span><span class="w"> </span><span class="err">a</span><span class="kc">t</span><span class="w"> </span><span class="err">o</span><span class="kc">ffset</span><span class="w"> </span><span class="mi">36864</span><span class="p">:</span><span class="w"> </span><span class="err">block</span><span class="w"> </span><span class="err">header</span><span class="w"> </span><span class="err">checksum</span><span class="w"> </span><span class="err">o</span><span class="kc">f</span><span class="w"> </span><span class="mi">0</span><span class="err">xe</span><span class="mf">91e380</span>
<span class="mi">0</span><span class="w"> </span><span class="err">does</span><span class="kc">n</span><span class="err">&#39;</span><span class="kc">t</span><span class="w"> </span><span class="err">ma</span><span class="kc">t</span><span class="err">ch</span><span class="w"> </span><span class="err">expec</span><span class="kc">te</span><span class="err">d</span><span class="w"> </span><span class="err">checksum</span><span class="w"> </span><span class="err">o</span><span class="kc">f</span><span class="w"> </span><span class="mi">0</span><span class="err">xd</span><span class="mi">10</span><span class="err">d</span><span class="mf">51e</span><span class="err">&quot;}}</span>
<span class="err">...</span>
<span class="err">lot of errors</span>
<span class="err">...</span>
</code></pre></div>
so thi is a problem of copy.</p>
<p>Indeed it is <a href="https://www.mongodb.com/docs/manual/core/backups/#back-up-with-cp-or-rsync">stated by documentation</a>:</p>
<blockquote>
<p>you can copy the files directly using cp, rsync, or a similar tool. Since copying multiple files is not an atomic operation, you must stop all writes to the mongod before copying the files.</p>
</blockquote>
<p>I'm not able to stop mongodb for just a test, so I will first setup other things like stunnel.</p>
<h2 id="setting-up-stunnel">Setting up stunnel<a class="headerlink" href="#setting-up-stunnel" title="Permanent link">#</a></h2>
<p>see <a href="../2024-01-04-setting-up-stunnel/">2024-01-04 Setting up stunnel</a></p>
<h2 id="cron-job-for-tags-collection-generation-on-opf-opff-obf">Cron job for tags collection generation on opf / opff / obf<a class="headerlink" href="#cron-job-for-tags-collection-generation-on-opf-opff-obf" title="Permanent link">#</a></h2>
<p>Before we directly had a script on the crontab of mongodb server to generate tags collection.</p>
<p>But it disappeared from off main version.</p>
<p>We now will launch those tasks from the different servers, it is more logical and flexible.</p>
<p>On each container: off, opf and opff</p>
<ul>
<li>install mongosh: <code>sudo apt install mongodb-mongosh</code></li>
</ul>
<h2 id="migration-procedure">Migration procedure<a class="headerlink" href="#migration-procedure" title="Permanent link">#</a></h2>
<ul>
<li>stop mongodb on mongodb container: <code>systemctl stop mongodb</code></li>
<li>rsync MongoDB data from off3 to mongodb container. On off1, as root:
  <div class="highlight"><pre><span></span><code><span class="nb">time</span><span class="w"> </span>rsync<span class="w"> </span>-a<span class="w"> </span>--delete-delay<span class="w"> </span>--usermap<span class="o">=</span>mongodb:100108,off:100108<span class="w"> </span>--groupmap<span class="o">=</span>mongodb:100116,off:100116<span class="w"> </span><span class="m">10</span>.0.0.3:/mongo/db/<span class="w"> </span>/zfs-nvme/pve/subvol-102-disk-0/db/
</code></pre></div>
  (took 15 min 56s)</li>
<li>warn slack users</li>
<li>stop mongodb on off3: <code>systemctl stop mongod</code></li>
<li>rsync again (same command as above) (took 6 min 42s)</li>
<li>(during sync)<ul>
<li>change configuration for product opener<ul>
<li>on off, off-pro<ul>
<li>edit /srv/$HOSTNAME/lib/ProductOpener/Config2.pm</li>
<li><code>sudo systemctl restart apache2.service cloud_vision_ocr@$HOSTNAME.service minion@HOSTNAME.service</code></li>
</ul>
</li>
<li>on opf, opff, obf:<ul>
<li>edit /srv/$PROJECT/lib/ProductOpener/Config2.pm</li>
<li><code>sudo systemctl restart apache2.service</code></li>
</ul>
</li>
</ul>
</li>
<li>change configuration for off-query-org and robotoff-org to point to 10.1.0.101:27017 (ovh1 proxy):<ul>
<li>going to corresponding directory</li>
<li>editing .env</li>
<li><code>sudo -u off docker-compose down &amp;&amp; sudo -u off docker-compose up -d</code></li>
</ul>
</li>
</ul>
</li>
<li>start mongodb on mongodb container (keep off3 down)</li>
<li>verify it's working on off</li>
<li>disable mongod on off3</li>
<li>merge PR to change mongodb configuration of off-query and robotoff</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.525ec568.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>