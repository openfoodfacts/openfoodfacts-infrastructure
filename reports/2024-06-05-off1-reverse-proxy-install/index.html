
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../2024-05-27-nginx-exporter-off2-proxy/">
      
      
        <link rel="next" href="../2024-06-10-move-off-query-volume-to-nvme/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.40">
    
    
      
        <title>2024-06 OFF1 reverse proxy install + OFF images container - Open Food Facts Infrastructure documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8c3ca2c6.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2024-06-off1-reverse-proxy-install-off-images-container" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Open Food Facts Infrastructure documentation" class="md-header__button md-logo" aria-label="Open Food Facts Infrastructure documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Open Food Facts Infrastructure documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2024-06 OFF1 reverse proxy install + OFF images container
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/openfoodfacts/openfoodfacts-infrastructure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Open Food Facts Infrastructure documentation" class="md-nav__button md-logo" aria-label="Open Food Facts Infrastructure documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Open Food Facts Infrastructure documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/openfoodfacts/openfoodfacts-infrastructure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Open Food Facts Infrastructure
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cicd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Continous Integration and Continuous Delivery
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../discourse/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Discourse
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../disks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Disks
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker at Open Food Facts
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../docker_architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker architecture
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../docker_onboarding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Onboarding
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../explain-server-config-in-git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Explanation on server configuration with git
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../folksonomy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Folksonomy API
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../free-datacenter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Free Datacenter
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-add-disk-space-on-qemu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to add disk space on a Qemu VM
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-fail2ban-ban-bots/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to use fail2ban to ban bots
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-fail2ban-debian-11%2B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to install fail2ban on debian 11+
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-have-server-config-in-git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to have server config in git
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-mitigate-crawlers-on-prod/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to mitigate crawlers in case of too much traffic
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-resync-zfs-replication/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to resync ZFS replication
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux-server/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux server
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-off1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    off1 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-off2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    off2 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-off3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    off3 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-ovh1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ovh1 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-ovh2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ovh2 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-ovh3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ovh3 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mail/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mail on Open Food Facts infrastructure
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../matomo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Matomo
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../moji-datacenter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Moji Datacenter
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mongodb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MongoDB
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../munin/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Munin
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nginx-reverse-proxy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NGINX Reverse proxy
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Observability
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../odoo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Odoo: our relationship management (connect.openfoodfacts.org)
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../openfoodfacts-query/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Open Food Facts Query
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Infrastructure overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../postgres/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PostgreSQL
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../prod-architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Production architecture
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../producers_sftp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Producers SFTP
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../product-opener/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Product Opener
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../proxmox/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Proxmox
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rclone/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rclone
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sanoid/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sanoid
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../slackin/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    auto Slack invitation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../stunnel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Stunnel
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../zammad/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Zammad
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../zfs-overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ZFS overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_46" checked>
        
          
          <label class="md-nav__link" for="__nav_46" id="__nav_46_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reports
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_46_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_46">
            <span class="md-nav__icon md-icon"></span>
            Reports
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-02-22-matomo-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Matomo install
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-10-03-network-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    [Postmortem] OpenFoodFacts.net down (#1)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-12-21-disk-extension/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Disk extension for preprod and containers prod (ovh2)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-12-22-preprod-crash/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preprod crash 2021 12
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-18-ovh-reverse-proxy-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    [Postmortem] Reverse proxy down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-proxmox-mail-gateway-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Install of proxmox gateway server
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-remove-containers-ovh1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-02 Removing some containers on ovh1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-03-03-zammad-elasticsearch-not-running/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Elasticsearch not running on Zammad
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-03-off2-PCI-NVMe-problems/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-03 Problem with PCI supporting NVMe
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-07-08-journey-to-deploy-off-search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deploying openfoodfacts-search to staging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-07-11-infra-workshop/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Infrastructure future - workshop on 11th July 2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-07-kibana-down-es-circuit-breaking-exception/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kibana down because of Elasticsearch circuit_breaking_exception
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-08-17-openfoodfacts-net-unreachable/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-08-17 openfoodfacts.net unreachable
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-09-23-odoo-setup-for-pro-platform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup of Odoo for pro platform
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-11-09-monitoring-move-to-own-vm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-11 moving monitoring to its own machine
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-13-zammad-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-02-13 Zammad down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-16-off2-shutdown/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 02 16 off2 shutdown
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-17-off2-upgrade/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-02-17 Off2 Upgrade
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-24-zfs-introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 02 24 zfs introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-03-14-off2-opff-reinstall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-03 OFF2 reinstall - opff migration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-04-27-moving-docker-stagging-to-ovh1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-04-27 moving docker staging to OVH1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-12-refresh-staging-clones/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-05-12 refresh staging clones
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-19-overload-of-osm-machine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-05-18 Mongodb down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-23-move-images-to-zfs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-05-23 move Images to ZFS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-off2-110-unreachable/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-05-23 off2 - container 110 unreachable from 101
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-01-robotoff-backups/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-01 Robotoff backups
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-07-off2-opf-obf-reinstall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-07 OPF and OBF reinstall on off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-08-stalled-zfs-sync-off-products/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2012-06-08 Stalled ZFS Sync for off products on ovh3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-30-sanoid-checks-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-30 Sanoid checks install
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-07-16-ovh3-sdc-broken/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Post-mortem 2023-07-16 Disk sdc errors on OVH3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-07-26-off1-rpool-products-full/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-07-26 rpool/off/products dataset full on off1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-07-off-reinstall--prod-files-diff/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 07 off reinstall  prod files diff
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-07-off2-off-reinstall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-07 OFF and OFF-pro reinstall on off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-08-31-off2-products-snapshots-clean/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-08-31 OFF2 products snapshots clean
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-09-27-expired-ssl-certificate-for-images-on-off2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-09-27 / Expired SSL certificate for images.openfoodfacts.org on off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-10-14-mongodb-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-10-14: mongodb-down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-11-28-google-drive-backup-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-11-28 setup a google drive backup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-11-28-ovh3-sdf-broken/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Post-mortem 2023-11-28 Disk sdf errors on OVH3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-12-08-off1-upgrade/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-12-08 off1 upgrade
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-12-11-matomo-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-12-11 Matomo down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-02-monitoring-disk-space/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01-02 monitoring disk space - filebeat
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-03-mongodb-migration-off1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01-03 MongoDB migration on off3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-04-setting-up-stunnel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024 01 04 setting up stunnel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-19-certbot-failure-off2-proxy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01-19 Certbot failure on off2 reverse proxy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-24-move-old-productopener-folders-to-backup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01-24 Move old Product Opener folders to backup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-matomo-perf-tunning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01 Matomo performance tunning
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-06-cleanup-products-snapshots/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-06 cleanup of products ssnapshots on off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-08-prod-redis-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-08 Production Redis install
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-13-chatwoot-translation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-13 Chatwoot translation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-13-matomo-fix-queue0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2014-02-13 Matomo fix Queue0
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-20-exporter-on-mongodb-ct/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-20 Installing a prometheus exporter on mongodb container
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-28-upgrade-redis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-28 Upgrade Redis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-03-17-ovh1-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-03-17 OVH1 Down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-03-restructure-backups/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-03 Restructure backups
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-03-separate-hdd-docker-vms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-03 separate HDD on docker VMs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-04-03-moving-opf-obf-opff-logs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-03-04 Moving opf, obf and opff logs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-04-12-install-off-query-off1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-04 install off-query on off1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-04-18-matomo-multi-archival/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-04-18 Matomo multi archival
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-04-18-setup-dkim-google-workspace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-04-18 Setup DKIM on Google Workspace
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-05-27-nginx-exporter-off2-proxy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Nginx exporter on off2 proxy and off
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    2024-06 OFF1 reverse proxy install + OFF images container
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    2024-06 OFF1 reverse proxy install + OFF images container
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#nginx-reverse-proxy-install" class="md-nav__link">
    <span class="md-ellipsis">
      NGINX reverse proxy install
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NGINX reverse proxy install">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing-container" class="md-nav__link">
    <span class="md-ellipsis">
      Installing Container
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-nginx" class="md-nav__link">
    <span class="md-ellipsis">
      Install nginx
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-the-ip" class="md-nav__link">
    <span class="md-ellipsis">
      Adding the IP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#declaring-dns-entry" class="md-nav__link">
    <span class="md-ellipsis">
      declaring DNS entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloning-git-infra-repository" class="md-nav__link">
    <span class="md-ellipsis">
      Cloning git infra repository
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#re-enforcing-security-thanks-to-fail2ban" class="md-nav__link">
    <span class="md-ellipsis">
      Re-enforcing security thanks to fail2ban
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mounting-volumes" class="md-nav__link">
    <span class="md-ellipsis">
      Mounting volumes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssl-certificates" class="md-nav__link">
    <span class="md-ellipsis">
      SSL certificates
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SSL certificates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#testing-ssl-renewals" class="md-nav__link">
    <span class="md-ellipsis">
      Testing SSL renewals
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      NGINX configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    <span class="md-ellipsis">
      Testing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-06-10-move-off-query-volume-to-nvme/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Move off query volume to NVME
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-06-20-move-ean8-directories/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Move EAN8 directories
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-08-03-ovh-reverse-proxy-ip-lost/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-08-03 OVH Reverse proxy IP lost
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-08-07-wordpress-off-contents-fresh-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-08-07-wordpress-off-contents-fresh-install
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-08-13-moji-server-installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Moji server installation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-08-22-postfix-exporter-on-pmg/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-08-22 Adding postfix exporter to Proxmox Mail Gateway
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-09-04-move-off-query-to-moji/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-09-04 Move off query to moji
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-09-05-adding-ipv6-to-off2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-09-05 adding ipv6 to off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-09-06-moji-post-installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Moji - Post-installation &amp; backup sync
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-09-06-test-folksonomy-openproductsfacts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-09-06 test folksonomy Open Products Facts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-09-24-kimsufi-stor-ks1-installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kimsufi STOR - ks1 installation
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#nginx-reverse-proxy-install" class="md-nav__link">
    <span class="md-ellipsis">
      NGINX reverse proxy install
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NGINX reverse proxy install">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing-container" class="md-nav__link">
    <span class="md-ellipsis">
      Installing Container
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-nginx" class="md-nav__link">
    <span class="md-ellipsis">
      Install nginx
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-the-ip" class="md-nav__link">
    <span class="md-ellipsis">
      Adding the IP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#declaring-dns-entry" class="md-nav__link">
    <span class="md-ellipsis">
      declaring DNS entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloning-git-infra-repository" class="md-nav__link">
    <span class="md-ellipsis">
      Cloning git infra repository
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#re-enforcing-security-thanks-to-fail2ban" class="md-nav__link">
    <span class="md-ellipsis">
      Re-enforcing security thanks to fail2ban
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mounting-volumes" class="md-nav__link">
    <span class="md-ellipsis">
      Mounting volumes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssl-certificates" class="md-nav__link">
    <span class="md-ellipsis">
      SSL certificates
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SSL certificates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#testing-ssl-renewals" class="md-nav__link">
    <span class="md-ellipsis">
      Testing SSL renewals
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      NGINX configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    <span class="md-ellipsis">
      Testing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="2024-06-off1-reverse-proxy-install-off-images-container">2024-06 OFF1 reverse proxy install + OFF images container<a class="headerlink" href="#2024-06-off1-reverse-proxy-install-off-images-container" title="Permanent link">#</a></h1>
<p><strong>⚠️ IMPORTANT:</strong> We finally didn't use this reverse proxy which was intended to serve images due to un-explained performance issues.
We didn't have the time to investigate more.</p>
<p>A new IP address has been allocated so that we can install a nginx reverse proxy on off1.
The reverse proxy will directly serve static OFF product images.</p>
<p>I (Stéphane) will follow what was done by Alex for the reverse proxy on off2: 2023-03-14-off2-opff-reinstall.md </p>
<h2 id="nginx-reverse-proxy-install">NGINX reverse proxy install<a class="headerlink" href="#nginx-reverse-proxy-install" title="Permanent link">#</a></h2>
<h3 id="installing-container">Installing Container<a class="headerlink" href="#installing-container" title="Permanent link">#</a></h3>
<p>I followed <a href="../../proxmox/#how-to-create-a-new-container">How to create a new Container</a></p>
<p>I chose 4 cpu, 2 Gb RAM, 32 Gb disk (same as proxy on off2)</p>
<p>CT number is 100</p>
<p>debian-12-standard_12.2-1
Network: name=eth0,bridge=vmbr1,ip=10.1.0.100/24,gw=10.0.0.1</p>
<h3 id="install-nginx">Install nginx<a class="headerlink" href="#install-nginx" title="Permanent link">#</a></h3>
<p>I then simply install <code>nginx</code> using apt.</p>
<p>I also <a href="../mail#postfix-configuration">configure postfix</a> and tested it.</p>
<h3 id="adding-the-ip">Adding the IP<a class="headerlink" href="#adding-the-ip" title="Permanent link">#</a></h3>
<p>Using proxmox interface, on container 100, I add net1, on vmbr0, IP 213.36.253.215/27, Gateway 213.36.253.222 (copied from Host config).</p>
<p>I reboot the container 100, and it seems to work, I can access the nginx using the IP address.</p>
<h3 id="declaring-dns-entry">declaring DNS entry<a class="headerlink" href="#declaring-dns-entry" title="Permanent link">#</a></h3>
<p>I added an A record <code>off1-proxy.openfoodfacts.org</code> to point to this IP in OVH DNS zones.</p>
<h3 id="cloning-git-infra-repository">Cloning git infra repository<a class="headerlink" href="#cloning-git-infra-repository" title="Permanent link">#</a></h3>
<p>I created a ssh key as root:
<div class="highlight"><pre><span></span><code>ssh-keygen<span class="w"> </span>-t<span class="w"> </span>ed25519<span class="w"> </span>-C<span class="w"> </span><span class="s2">&quot;off@off1-proxy.openfoodfacts.org&quot;</span>
cat<span class="w"> </span>/root/.ssh/id_ed25519.pub
</code></pre></div>
and add it as <a href="https://github.com/openfoodfacts/openfoodfacts-infrastructure/settings/keys">authorized key in openfoodfacts-infrastructure</a> with write authorization (as it will be mainly modified directly in the container).</p>
<p>Then I cloned the repository in /opt
<div class="highlight"><pre><span></span><code>cd /opt
git clone git@github.com:openfoodfacts/openfoodfacts-infrastructure.git
</code></pre></div></p>
<h3 id="re-enforcing-security-thanks-to-fail2ban">Re-enforcing security thanks to fail2ban<a class="headerlink" href="#re-enforcing-security-thanks-to-fail2ban" title="Permanent link">#</a></h3>
<p>Install fail2ban.</p>
<p>We reuse the existing <code>confs/proxy-off/fail2ban/jail.d/nginx</code> using debian provided feature for nginx
Then:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/proxy-off/fail2ban/jail.d/nginx.conf<span class="w"> </span>/etc/fail2ban/jail.d/
systemctl<span class="w"> </span>reload<span class="w"> </span>fail2ban
</code></pre></div></p>
<p><strong>NOTE</strong>: it's really not enough, but to analyze 403 / 401 we need a specific plugin that analyze logs.</p>
<h3 id="mounting-volumes">Mounting volumes<a class="headerlink" href="#mounting-volumes" title="Permanent link">#</a></h3>
<p>We will serve images directly from the reverse proxy (in order to not require to have a separate "images" container that serves images). The reason is to avoid having an extra nginx layer (with logs etc.) for image files that are requested very often.</p>
<p>I edit /etc/pve/lxc/100.conf</p>
<p>and add:</p>
<p>mp0: /zfs-hdd/off/images,mp=/mnt/off/images
mp1: /zfs-hdd/obf/images,mp=/mnt/obf/images
mp2: /zfs-hdd/opf/images,mp=/mnt/opf/images
mp3: /zfs-hdd/opff/images,mp=/mnt/opff/images</p>
<p>Initially /zfs-hdd/opf did not exist on the off1 host, because of a typo in /etc/sanoid/syncoid-args.conf on off1.
Fixed the config and ran a first sync manually:
syncoid --no-sync-snap --no-privilege-elevation --recursive off1operator@10.0.0.2:zfs-hdd/opf zfs-hdd/opf</p>
<h3 id="ssl-certificates">SSL certificates<a class="headerlink" href="#ssl-certificates" title="Permanent link">#</a></h3>
<p>I copy the letsencrypt certificates and configurations from off2 host to the off1 reverse proxy.</p>
<p>Then I install letsencrypt in the off1 reverse proxy container.</p>
<p>sudo apt install certbot python3-certbot-nginx
(fixed: at first I forgot the nginx plugin)</p>
<h4 id="testing-ssl-renewals">Testing SSL renewals<a class="headerlink" href="#testing-ssl-renewals" title="Permanent link">#</a></h4>
<p>sudo certbot renew --dry-run</p>
<p>Failed to renew certificate images.openfoodfacts.org with error: The requested nginx plugin does not appear to be installed</p>
<p>Installed python3-certbot-nginx</p>
<p>2nd try:</p>
<p>Detail: 213.36.253.208: Fetching http://images.openfoodfacts.org/.well-known/acme-challenge/GUG0men38f_steRovK_AmCPyaV4lCyJUA3N8teSWp3I: Connection refused</p>
<p>TODO: check if this is because the live images.openfoodfacts.org currently points to off2.</p>
<h3 id="nginx-configuration">NGINX configuration<a class="headerlink" href="#nginx-configuration" title="Permanent link">#</a></h3>
<p>We reuse the existing <code>nginx.conf</code>:</p>
<div class="highlight"><pre><span></span><code>mv<span class="w"> </span>/etc/nginx/nginx.conf<span class="w"> </span>/etc/nginx/nginx.conf.old
ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/proxy-off/nginx/nginx.conf<span class="w"> </span>/etc/nginx/
</code></pre></div>
<p>We reuse the existing <code>log_format.conf</code> file with log format definition:
<div class="highlight"><pre><span></span><code>log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
                  &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
                  &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;
</code></pre></div>
It's in the git repository, so then:</p>
<div class="highlight"><pre><span></span><code>ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/proxy-off/nginx/log_format.conf<span class="w"> </span>/etc/nginx/conf.d/log_format.conf
</code></pre></div>
<p>From off2 static-off configuration, I create a similar images-off site, and <a href="../confs/off1-reverse-proxy/nginx/sites-available/images-off">put it into git</a>.</p>
<div class="highlight"><pre><span></span><code>ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/off1-reverse-proxy/nginx/sites-available/images-off<span class="w"> </span>/etc/nginx/sites-enabled/
</code></pre></div>
<p>Changes from static-off:</p>
<ul>
<li>I put log files in /var/log/nginx instead of a zfs mount</li>
<li>Path to images are to /mnt/off instead of /zfs-hdd/off as we are in a container and not the host</li>
<li>Removed the upstream directive which was not used</li>
<li>Fixed paths to SSL certificates (copied from off2 host)</li>
</ul>
<h3 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">#</a></h3>
<p>To test, I change my local /etc/hosts file to add:
213.36.253.215 images.openfoodfacts.org</p>
<p>The upstream times out:</p>
<p>2024/06/04 13:25:25 [error] 1666#1666: *1 upstream timed out (110: Connection timed out) while connecting to upstream, client: 91.175.166.38, server: images.openfoodfacts.org, request: "GET /images/products/560/247/784/2456/front_fr.3.200.jpg HTTP/2.0", upstream: "https://213.36.253.214:443/images/products/560/247/784/2456/front_fr.3.200.jpg", host: "images.openfoodfacts.org", referrer: "https://fr.openfoodfacts.org/"</p>
<p>We can't access proxy2.openfoodfacts.org from inside the container (why?)</p>
<p>Changing:</p>
<p>proxy_pass              https://proxy2.openfoodfacts.org;</p>
<p>To use directly the IP of the off container:</p>
<p>proxy_pass              http://10.1.0.113:80;</p>
<p>Which works.</p>
<h1 id="services-setup">Services setup<a class="headerlink" href="#services-setup" title="Permanent link">#</a></h1>
<p>We copy the services structure we have on off2 in the proxy 101 container:</p>
<p>root@proxy:/etc/systemd/system# ls -lrt | grep opt
lrwxrwxrwx 1 root root  91 Sep  8  2023 fail2ban.service.d -&gt; /opt/openfoodfacts-infrastructure/confs/common/fail2ban-nftables/systemd/fail2ban.service.d
lrwxrwxrwx 1 root root  89 Nov 20  2023 nginx.service.d -&gt; /opt/openfoodfacts-infrastructure/confs/off2-reverse-proxy/systemd/system/nginx.service.d
lrwxrwxrwx 1 root root  93 Nov 20  2023 logrotate.service.d -&gt; /opt/openfoodfacts-infrastructure/confs/off2-reverse-proxy/systemd/system/logrotate.service.d
lrwxrwxrwx 1 root root  97 Nov 21  2023 email-failures@.service -&gt; /opt/openfoodfacts-infrastructure/confs/off2-reverse-proxy/systemd/system/email-failures@.service
lrwxrwxrwx 1 root root  93 Jan  5 18:51 stunnel@.service.d -&gt; /opt/openfoodfacts-infrastructure/confs/off2-reverse-proxy/systemd/system/stunnel@.service.d/
lrwxrwxrwx 1 root root  91 Jan 19 13:18 certbot.service.d -&gt; /opt/openfoodfacts-infrastructure/confs/off2-reverse-proxy/systemd/system/certbot.service.d
lrwxrwxrwx 1 root root 109 May 27 14:26 prometheus-nginx-exporter.service.d -&gt; /opt/openfoodfacts-infrastructure/confs/off2-reverse-proxy/systemd/system/prometheus-nginx-exporter.service.d</p>
<p>ln -s /opt/openfoodfacts-infrastructure/confs/common/fail2ban-nftables/systemd/fail2ban.service.d /etc/systemd/system
ln -s /opt/openfoodfacts-infrastructure/confs/off1-reverse-proxy/systemd/system/prometheus-nginx-exporter.service.d /etc/systemd/system/
ln -s /opt/openfoodfacts-infrastructure/confs/off1-reverse-proxy/systemd/system/logrotate.service.d /etc/systemd/system/
ln -s /opt/openfoodfacts-infrastructure/confs/off1-reverse-proxy/systemd/system/nginx.service.d /etc/systemd/system/
ln -s /opt/openfoodfacts-infrastructure/confs/off1-reverse-proxy/systemd/system/certbot.service.d /etc/systemd/system/</p>
<h1 id="nginx-exporter-on-off2-proxy-and-off">Nginx exporter on off2 proxy and off<a class="headerlink" href="#nginx-exporter-on-off2-proxy-and-off" title="Permanent link">#</a></h1>
<h2 id="on-off2-reverse-proxy">On off2 reverse proxy<a class="headerlink" href="#on-off2-reverse-proxy" title="Permanent link">#</a></h2>
<h3 id="expose-nginx-stats">Expose nginx stats<a class="headerlink" href="#expose-nginx-stats" title="Permanent link">#</a></h3>
<p>For nginx exporter we need to expose /stub_status on port 8080 (see <a href="https://github.com/nginxinc/nginx-prometheus-exporter">doc</a>) https://nginx.org/en/docs/http/ngx_http_stub_status_module.html#stub_status</p>
<p>I created the <code>stub_status</code> conf for that (linked from this repository). I limited to 127.0.0.1, it should be internal.</p>
<p>Test it: <code>curl http://127.0.0.1:8080</code></p>
<h3 id="install-prometheus-nginx-exporter">Install Prometheus nginx exporter<a class="headerlink" href="#install-prometheus-nginx-exporter" title="Permanent link">#</a></h3>
<p>In container 100, install the exporter:
<code>sudo apt install prometheus-nginx-exporter</code></p>
<p>As we are on a public interface, we don't want to expose the exporter widely, so we restrict it to 10.1.0.100 so that we can query it from the proxy container on off2.</p>
<p>For that we edit /opt/openfoodfacts-infrastructure/confs/off1-reverse-proxy/systemd/system/prometheus-nginx-exporter.service.d/override.conf to change the IP:</p>
<p><div class="highlight"><pre><span></span><code>[Service]
# ONLY listen on 10.1.0.100 for security reasons
# We do not put 127.0.0.1 as we want to access the prometheus export from the proxy container on off2.
Environment=&quot;LISTEN_ADDRESS=10.1.0.100:9113&quot;
</code></pre></div>
And moved it to versioned space:
<div class="highlight"><pre><span></span><code>mv<span class="w"> </span>/etc/systemd/system/prometheus-nginx-exporter.service.d<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/off2-reverse-proxy/systemd/system/<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/off2-reverse-proxy/systemd/system/prometheus-nginx-exporter.service.d<span class="w"> </span>/etc/systemd/system/
</code></pre></div></p>
<p>Reload: <code>systemctl daemon-reload &amp;&amp; systemctl restart prometheus-nginx-exporter</code></p>
<p>Check exporter status: <code>systemctl status prometheus-nginx-exporter</code></p>
<p>Test it from the proxy container on off2:
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>http://10.1.0.100:9113/metrics
</code></pre></div></p>
<p>Test it's not available from the public interface:
<div class="highlight"><pre><span></span><code>nc<span class="w"> </span>-vz<span class="w"> </span><span class="m">213</span>.36.253.215<span class="w"> </span><span class="m">9113</span>
nc:<span class="w"> </span>connect<span class="w"> </span>to<span class="w"> </span><span class="m">213</span>.36.253.215<span class="w"> </span>port<span class="w"> </span><span class="m">9113</span><span class="w"> </span><span class="o">(</span>tcp<span class="o">)</span><span class="w"> </span>failed:<span class="w"> </span>Connection<span class="w"> </span>refused
</code></pre></div></p>
<h3 id="expose-the-metrics">Expose the metrics<a class="headerlink" href="#expose-the-metrics" title="Permanent link">#</a></h3>
<p>Edit the <code>/etc/nginx/sites-enabled/free-exporters.openfoodfacts.org</code>
to add the right entry to the map directive:</p>
<div class="highlight"><pre><span></span><code># map from service to exporter
map $uri $exporter {
    ...
    # nginx on this proxy
    &quot;/proxy/nginx/metrics&quot; 127.0.0.1:9113;
    ...
</code></pre></div>
<p>Restart nginx and test it:
<div class="highlight"><pre><span></span><code>curl -u prometheus:**password-here**  https://free-exporters.openfoodfacts.org/proxy/nginx/metrics
</code></pre></div></p>
<h2 id="add-the-exporter-to-the-monitoring-stack">Add the exporter to the monitoring stack<a class="headerlink" href="#add-the-exporter-to-the-monitoring-stack" title="Permanent link">#</a></h2>
<p>Edit <code>prometheus/config.yml</code> to add the service path to free-exporters section.
(see <a href="https://github.com/openfoodfacts/openfoodfacts-monitoring/commit/845759a68528b60bcc47e9b5860bc72940431032">commit 845759a</a>)</p>
<p>The nginx dashboards works immediately.</p>
<h3 id="todo">TODO<a class="headerlink" href="#todo" title="Permanent link">#</a></h3>
<ul>
<li>Also do the setup for OBF, OPF, OPFF: nginx configuration, SSL certificates etc.</li>
<li>Verify that off1 can renew the images.openfoodfacts.org SSL certificate</li>
<li>Export proxy logs and static logs to prometheus?</li>
</ul>
<h2 id="20240606-performance-issues">2024/06/06 - Performance issues<a class="headerlink" href="#20240606-performance-issues" title="Permanent link">#</a></h2>
<p>We are seeing performance issues with serving images on the off1 proxy in container 100.
Some images can take 10 seconds to be served back by nginx, and it can clearly be seen when loading lists of products on the website.</p>
<p>Private message thread: https://openfoodfacts.slack.com/archives/C074EACK8TH/p1717687142646649</p>
<h3 id="trying-to-serve-images-directly-from-the-off1-host-instead-of-a-container">Trying to serve images directly from the off1 host instead of a container<a class="headerlink" href="#trying-to-serve-images-directly-from-the-off1-host-instead-of-a-container" title="Permanent link">#</a></h3>
<p>We suspect that the slowness is due to the bind mount of the zfs pool with images.
So we will try to serve images directly from the off1 host instead of the 100 container (like we currently do on off2)</p>
<p>apt-get install nginx</p>
<p>ln -s /opt/openfoodfacts-infrastructure/confs/off1/nginx/sites-available/images-off /etc/nginx/sites-enabled/
rm /etc/nginx/sites-enabled/default 
rm /etc/nginx/nginx.conf 
ln -s /opt/openfoodfacts-infrastructure/confs/proxy-off/nginx/nginx.conf /etc/nginx/
cp -a /zfs-hdd/pve/subvol-100-disk-0/etc/letsencrypt /etc/</p>
<p>TODO: properly install letsencrypt if it works and we want to keep serving images on the host.</p>
<p><strong>⚠️ IMPORTANT:</strong> We finally abandonned using off1 to server images, due to un-explained performance issues.
We didn't have the time to investigate more.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.525ec568.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>