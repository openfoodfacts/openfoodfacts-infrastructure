
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../2022-07-11-infra-workshop/">
      
      
        <link rel="next" href="../2022-08-17-openfoodfacts-net-unreachable/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.18">
    
    
      
        <title>Kibana down because of Elasticsearch circuit_breaking_exception - Open Food Facts Infrastructure documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.66ac8b77.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#kibana-down-because-of-elasticsearch-circuit_breaking_exception" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Open Food Facts Infrastructure documentation" class="md-header__button md-logo" aria-label="Open Food Facts Infrastructure documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Open Food Facts Infrastructure documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Kibana down because of Elasticsearch circuit_breaking_exception
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/openfoodfacts/openfoodfacts-infrastructure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Open Food Facts Infrastructure documentation" class="md-nav__button md-logo" aria-label="Open Food Facts Infrastructure documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Open Food Facts Infrastructure documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/openfoodfacts/openfoodfacts-infrastructure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OpenFoodFacts Infrastructure
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cicd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Continous Integration and Continuous Delivery
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../discourse/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Discourse
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../disks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Disks
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker at Open Food Facts
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../docker_architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker architecture
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../docker_onboarding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Onboarding
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../explain-server-config-in-git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Explanation on server configuration with git
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../folksonomy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Folksonomy API
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../free-datacenter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Free Datacenter
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-add-disk-space-on-qemu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to add disk space on a Qemu VM
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-fail2ban-ban-bots/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to use fail2ban to ban bots
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-fail2ban-debian-11%2B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to install fail2ban on debian 11+
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-have-server-config-in-git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to have server config in git
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-mitigate-crawlers-on-prod/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to mitigate crawlers in case of too much traffic
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux-server/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux server
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-off1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    off1 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-off2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    off2 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-off3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    off3 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-ovh1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ovh1 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-ovh2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ovh2 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-ovh3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ovh3 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mail/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mail on Open Food Facts infrastructure
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../matomo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Matomo
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mongodb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MongoDB
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../munin/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Munin
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nginx-reverse-proxy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NGINX Reverse proxy
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Observability
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../odoo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Odoo: our relationship management (connect.openfoodfacts.org)
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../postgres/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PostgreSQL
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../prod-architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Production architecture
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../producers_sftp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Producers SFTP
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../product-opener/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Product Opener
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../proxmox/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Proxmox
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rclone/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rclone
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sanoid/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sanoid
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../slackin/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    auto Slack invitation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../stunnel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Stunnel
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../zammad/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Zammad
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../zfs-overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ZFS overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_42" checked>
        
          
          <label class="md-nav__link" for="__nav_42" id="__nav_42_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reports
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_42_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_42">
            <span class="md-nav__icon md-icon"></span>
            Reports
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-02-22-matomo-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Matomo install
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-10-03-network-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    [Postmortem] OpenFoodFacts.net down (#1)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-12-21-disk-extension/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Disk extension for preprod and containers prod (ovh2)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-12-22-preprod-crash/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preprod crash 2021 12
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-18-ovh-reverse-proxy-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    [Postmortem] Reverse proxy down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-proxmox-mail-gateway-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Install of proxmox gateway server
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-remove-containers-ovh1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-02 Removing some containers on ovh1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-03-03-zammad-elasticsearch-not-running/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Elasticsearch not running on Zammad
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-03-off2-PCI-NVMe-problems/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-03 Problem with PCI supporting NVMe
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-07-08-journey-to-deploy-off-search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deploying openfoodfacts-search to staging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-07-11-infra-workshop/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Infrastructure future - workshop on 11th July 2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Kibana down because of Elasticsearch circuit_breaking_exception
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Kibana down because of Elasticsearch circuit_breaking_exception
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#symptoms" class="md-nav__link">
    <span class="md-ellipsis">
      Symptoms
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trying-to-diagnose-and-remedy" class="md-nav__link">
    <span class="md-ellipsis">
      Trying to diagnose and remedy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trying to diagnose and remedy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#base-problem" class="md-nav__link">
    <span class="md-ellipsis">
      Base problem
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#more-memory" class="md-nav__link">
    <span class="md-ellipsis">
      More memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#continue-diagnosis" class="md-nav__link">
    <span class="md-ellipsis">
      Continue diagnosis
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tunning-parent-circuit-breaker" class="md-nav__link">
    <span class="md-ellipsis">
      Tunning parent circuit breaker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#garbage-collection" class="md-nav__link">
    <span class="md-ellipsis">
      Garbage collection ?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-size" class="md-nav__link">
    <span class="md-ellipsis">
      Data size
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#too-many-shards" class="md-nav__link">
    <span class="md-ellipsis">
      Too many shards ?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#repairing-backup-then-remove-old-indices" class="md-nav__link">
    <span class="md-ellipsis">
      Repairing (backup then remove old indices)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Repairing (backup then remove old indices)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#more-memory_1" class="md-nav__link">
    <span class="md-ellipsis">
      More memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snapshoting-backup" class="md-nav__link">
    <span class="md-ellipsis">
      Snapshoting (backup)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removing-indices" class="md-nav__link">
    <span class="md-ellipsis">
      Removing indices
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fixing-snapshot-policy-and-ilm-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Fixing Snapshot policy and ILM policy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Fixing Snapshot policy and ILM policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-snapshot-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Create snapshot policy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-index-lifecycle-management-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Create Index Lifecycle Management policy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attach-policy-to-index-template" class="md-nav__link">
    <span class="md-ellipsis">
      Attach policy to index template
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attach-old-index-to-a-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Attach old index to a policy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#useful-resources" class="md-nav__link">
    <span class="md-ellipsis">
      Useful resources
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-08-17-openfoodfacts-net-unreachable/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-08-17 openfoodfacts.net unreachable
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-11-09-monitoring-move-to-own-vm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-11 moving monitoring to its own machine
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-13-zammad-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-02-13 Zammad down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-16-off2-shutdown/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 02 16 off2 shutdown
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-17-off2-upgrade/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-02-17 Off2 Upgrade
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-24-zfs-introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 02 24 zfs introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-03-14-off2-opff-reinstall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-03 OFF2 reinstall - opff migration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-04-27-moving-docker-stagging-to-ovh1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-04-27 moving docker staging to OVH1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-12-refresh-staging-clones/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-05-12 refresh staging clones
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-19-overload-of-osm-machine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-05-18 Mongodb down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-23-move-images-to-zfs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-05-23 move Images to ZFS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-off2-110-unreachable/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-05-23 off2 - container 110 unreachable from 101
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-01-robotoff-backups/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-01 Robotoff backups
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-07-off2-opf-obf-reinstall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-07 OPF and OBF reinstall on off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-08-stalled-zfs-sync-off-products/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2012-06-08 Stalled ZFS Sync for off products on ovh3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-30-sanoid-checks-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-30 Sanoid checks install
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-07-16-ovh3-sdc-broken/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Post-mortem 2023-07-16 Disk sdc errors on OVH3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-07-26-off1-rpool-products-full/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-07-26 rpool/off/products dataset full on off1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-07-off-reinstall--prod-files-diff/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 07 off reinstall  prod files diff
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-07-off2-off-reinstall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-07 OFF and OFF-pro reinstall on off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-08-31-off2-products-snapshots-clean/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-08-31 OFF2 products snapshots clean
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-09-27-expired-ssl-certificate-for-images-on-off2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-09-27 / Expired SSL certificate for images.openfoodfacts.org on off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-10-14-mongodb-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-10-14: mongodb-down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-11-28-google-drive-backup-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-11-28 setup a google drive backup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-11-28-ovh3-sdf-broken/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Post-mortem 2023-11-28 Disk sdf errors on OVH3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-12-08-off1-upgrade/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-12-08 off1 upgrade
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-12-11-matomo-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-12-11 Matomo down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-02-monitoring-disk-space/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01-02 monitoring disk space - filebeat
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-03-mongodb-migration-off1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01-03 MongoDB migration on off3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-04-setting-up-stunnel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024 01 04 setting up stunnel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-19-certbot-failure-off2-proxy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01-19 Certbot failure on off2 reverse proxy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-24-move-old-productopener-folders-to-backup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01-24 Move old Product Opener folders to backup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-matomo-perf-tunning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01 Matomo performance tunning
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-06-cleanup-products-snapshots/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-06 cleanup of products ssnapshots on off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-08-prod-redis-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-08 Production Redis install
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-13-chatwoot-translation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-13 Chatwoot translation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-13-matomo-fix-queue0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2014-02-13 Matomo fix Queue0
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-20-exporter-on-mongodb-ct/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-20 Installing a prometheus exporter on mongodb container
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-28-upgrade-redis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-28 Upgrade Redis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-03-17-ovh1-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-03-17 OVH1 Down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-03-restructure-backups/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-03 Restructure backups
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-03-separate-hdd-docker-vms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-03 separate HDD on docker VMs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-04-03-moving-opf-obf-opff-logs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-03-04 Moving opf, obf and opff logs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-04-18-matomo-multi-archival/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-04-18 Matomo multi archival
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-04-18-setup-dkim-google-workspace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-04-18 Setup DKIM on Google Workspace
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#symptoms" class="md-nav__link">
    <span class="md-ellipsis">
      Symptoms
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trying-to-diagnose-and-remedy" class="md-nav__link">
    <span class="md-ellipsis">
      Trying to diagnose and remedy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trying to diagnose and remedy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#base-problem" class="md-nav__link">
    <span class="md-ellipsis">
      Base problem
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#more-memory" class="md-nav__link">
    <span class="md-ellipsis">
      More memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#continue-diagnosis" class="md-nav__link">
    <span class="md-ellipsis">
      Continue diagnosis
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tunning-parent-circuit-breaker" class="md-nav__link">
    <span class="md-ellipsis">
      Tunning parent circuit breaker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#garbage-collection" class="md-nav__link">
    <span class="md-ellipsis">
      Garbage collection ?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-size" class="md-nav__link">
    <span class="md-ellipsis">
      Data size
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#too-many-shards" class="md-nav__link">
    <span class="md-ellipsis">
      Too many shards ?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#repairing-backup-then-remove-old-indices" class="md-nav__link">
    <span class="md-ellipsis">
      Repairing (backup then remove old indices)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Repairing (backup then remove old indices)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#more-memory_1" class="md-nav__link">
    <span class="md-ellipsis">
      More memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snapshoting-backup" class="md-nav__link">
    <span class="md-ellipsis">
      Snapshoting (backup)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removing-indices" class="md-nav__link">
    <span class="md-ellipsis">
      Removing indices
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fixing-snapshot-policy-and-ilm-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Fixing Snapshot policy and ILM policy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Fixing Snapshot policy and ILM policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-snapshot-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Create snapshot policy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-index-lifecycle-management-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Create Index Lifecycle Management policy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attach-policy-to-index-template" class="md-nav__link">
    <span class="md-ellipsis">
      Attach policy to index template
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attach-old-index-to-a-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Attach old index to a policy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#useful-resources" class="md-nav__link">
    <span class="md-ellipsis">
      Useful resources
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="kibana-down-because-of-elasticsearch-circuit_breaking_exception">Kibana down because of Elasticsearch circuit_breaking_exception<a class="headerlink" href="#kibana-down-because-of-elasticsearch-circuit_breaking_exception" title="Permanent link">#</a></h1>
<h2 id="symptoms">Symptoms<a class="headerlink" href="#symptoms" title="Permanent link">#</a></h2>
<p>We got a lot of alerts in infrastructure-alerts slack channel for:</p>
<blockquote>
<p>Service probe on URL 'https://kibana.openfoodfacts.org/status' failed for more than 5 minutes.</p>
</blockquote>
<p>Going to the status url we got a "server error".</p>
<h2 id="trying-to-diagnose-and-remedy">Trying to diagnose and remedy<a class="headerlink" href="#trying-to-diagnose-and-remedy" title="Permanent link">#</a></h2>
<h3 id="base-problem">Base problem<a class="headerlink" href="#base-problem" title="Permanent link">#</a></h3>
<p>On the machine, looking at kibana logs, while doing a request</p>
<p><div class="highlight"><pre><span></span><code>docker-compose logs --tail=0 -f kibana
</code></pre></div>
we see
<div class="highlight"><pre><span></span><code><span class="err">kiba</span><span class="kc">na</span><span class="err">_</span><span class="mi">1</span><span class="w">                  </span><span class="err">|</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;log&quot;</span><span class="p">,</span><span class="nt">&quot;@timestamp&quot;</span><span class="p">:</span><span class="s2">&quot;2022-07-27T12:36:07+00:00&quot;</span><span class="p">,</span><span class="nt">&quot;tags&quot;</span><span class="p">:[</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="s2">&quot;plugins&quot;</span><span class="p">,</span><span class="s2">&quot;security&quot;</span><span class="p">,</span><span class="s2">&quot;authentication&quot;</span><span class="p">],</span><span class="nt">&quot;pid&quot;</span><span class="p">:</span><span class="mi">1216</span><span class="p">,</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;License is not available, authentication is not possible.&quot;</span><span class="p">}</span>
<span class="err">kiba</span><span class="kc">na</span><span class="err">_</span><span class="mi">1</span><span class="w">                  </span><span class="err">|</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;log&quot;</span><span class="p">,</span><span class="nt">&quot;@timestamp&quot;</span><span class="p">:</span><span class="s2">&quot;2022-07-27T12:36:07+00:00&quot;</span><span class="p">,</span><span class="nt">&quot;tags&quot;</span><span class="p">:[</span><span class="s2">&quot;warning&quot;</span><span class="p">,</span><span class="s2">&quot;plugins&quot;</span><span class="p">,</span><span class="s2">&quot;licensing&quot;</span><span class="p">],</span><span class="nt">&quot;pid&quot;</span><span class="p">:</span><span class="mi">1216</span><span class="p">,</span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;License information could not be obtained from Elasticsearch due to {\&quot;error\&quot;:{\&quot;root_cause\&quot;:[{\&quot;type\&quot;:\&quot;circuit_breaking_exception\&quot;,\&quot;reason\&quot;:\&quot;[parent] Data too large, data for [&lt;http_request&gt;] would be [1028220976/980.5mb], which is larger than the limit of [1020054732/972.7mb], real usage: [1028220976/980.5mb], new bytes reserved: [0/0b], usages [request=0/0b, fielddata=0/0b, in_flight_requests=0/0b, model_inference=0/0b, eql_sequence=0/0b, accounting=76757928/73.2mb]\&quot;,\&quot;bytes_wanted\&quot;:1028220976,\&quot;bytes_limit\&quot;:1020054732,\&quot;durability\&quot;:\&quot;PERMANENT\&quot;}],\&quot;type\&quot;:\&quot;circuit_breaking_exception\&quot;,\&quot;reason\&quot;:\&quot;[parent] Data too large, data for [&lt;http_request&gt;] would be [1028220976/980.5mb], which is larger than the limit of [1020054732/972.7mb], real usage: [1028220976/980.5mb], new bytes reserved: [0/0b], usages [request=0/0b, fielddata=0/0b, in_flight_requests=0/0b, model_inference=0/0b, eql_sequence=0/0b, accounting=76757928/73.2mb]\&quot;,\&quot;bytes_wanted\&quot;:1028220976,\&quot;bytes_limit\&quot;:1020054732,\&quot;durability\&quot;:\&quot;PERMANENT\&quot;},\&quot;status\&quot;:429} error&quot;</span><span class="p">}</span>
</code></pre></div></p>
<h3 id="more-memory">More memory<a class="headerlink" href="#more-memory" title="Permanent link">#</a></h3>
<p>The day before, I gave more memory to ES to see if it was the problem, but it's not (see <a href="https://github.com/openfoodfacts/openfoodfacts-monitoring/pull/54">openfoodfacts-monitoring:#54</a>).</p>
<h3 id="continue-diagnosis">Continue diagnosis<a class="headerlink" href="#continue-diagnosis" title="Permanent link">#</a></h3>
<p>If we go on kibana container we can reproduce error:</p>
<div class="highlight"><pre><span></span><code>docker-compose exec kibana bash
</code></pre></div>
<p>ES is there:
<div class="highlight"><pre><span></span><code>curl -XGET http://elasticsearch:9200
</code></pre></div></p>
<p>but we get the circuit_breaking_exception while querying
<div class="highlight"><pre><span></span><code><span class="err">curl</span><span class="w"> </span><span class="mi">-</span><span class="err">XGET</span><span class="w"> </span><span class="err">h</span><span class="kc">tt</span><span class="err">p</span><span class="p">:</span><span class="c1">//elasticsearch:9200/_license?pretty=true</span>
<span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;root_cause&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;circuit_breaking_exception&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;reason&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;[parent] Data too large, data for [&lt;http_request&gt;] would be [1027528328/979.9mb], which is larger than the limit of [1020054732/972.7mb], real usage: [1027528328/979.9mb], new bytes reserved: [0/0b], usages [request=0/0b, fielddata=0/0b, in_flight_requests=0/0b, model_inference=0/0b, eql_sequence=0/0b, accounting=76607288/73mb]&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;bytes_wanted&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1027528328</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;bytes_limit&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1020054732</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;durability&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;PERMANENT&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;circuit_breaking_exception&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;reason&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;[parent] Data too large, data for [&lt;http_request&gt;] would be [1027528328/979.9mb], which is larger than the limit of [1020054732/972.7mb], real usage: [1027528328/979.9mb], new bytes reserved: [0/0b], usages [request=0/0b, fielddata=0/0b, in_flight_requests=0/0b, model_inference=0/0b, eql_sequence=0/0b, accounting=76607288/73mb]&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;bytes_wanted&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1027528328</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;bytes_limit&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1020054732</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;durability&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;PERMANENT&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">429</span>
<span class="p">}</span>
</code></pre></div></p>
<p>trying to <a href="https://www.elastic.co/guide/en/elasticsearch//reference/current/cluster-nodes-stats.html">get stats</a> for breaker:
<div class="highlight"><pre><span></span><code>curl -XGET elasticsearch:9200/_nodes/stats/breaker?pretty=true
</code></pre></div>
we see:
<div class="highlight"><pre><span></span><code><span class="nt">&quot;parent&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;limit_size_in_bytes&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1020054732</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;limit_size&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;972.7mb&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;estimated_size_in_bytes&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1030370648</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;estimated_size&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;982.6mb&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;overhead&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;tripped&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">39108</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div></p>
<p>Parent is the responsible for all memory according to <a href="">amazon help center</a> :</p>
<blockquote>
<p>The parent circuit breaker (a circuit breaker type) is responsible for the overall memory usage of your cluster.</p>
</blockquote>
<p>I tried to clear out <code>fielddata</code> cache:</p>
<p><div class="highlight"><pre><span></span><code>curl -XPOST http://elasticsearch:9200/*/_cache/clear?fielddata=true
</code></pre></div>
but it does not solve the problem.</p>
<h3 id="tunning-parent-circuit-breaker">Tunning parent circuit breaker<a class="headerlink" href="#tunning-parent-circuit-breaker" title="Permanent link">#</a></h3>
<p>Comparing to <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.0/circuit-breaker.html#parent-circuit-breaker">reference documentation</a>,
our settings seems a bit low compared to defaults.</p>
<p>I will try to augment the parent size for now, and set it to real memory tracking.</p>
<p>Edited the docker-compose to add configuration (through environment variables):</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nt">elasticsearch</span><span class="p">:</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>

<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">- &quot;indices.breaker.total.use_real_memory=true&quot;</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">- &quot;indices.breaker.request.limit=95%&quot;</span>
</code></pre></div>
<p>and restarted the container
<div class="highlight"><pre><span></span><code>docker-compose restart elasticsearch
</code></pre></div></p>
<p>It's not enough.</p>
<p>The issue might be that we have too much  data (17Gb indexes)</p>
<h3 id="garbage-collection">Garbage collection ?<a class="headerlink" href="#garbage-collection" title="Permanent link">#</a></h3>
<p>Is that maybe related to Garbage collection ?
Listing <code>/usr/share/elasticsearch/config/jvm.options</code> in the container shows that G1GC is in use:</p>
<div class="highlight"><pre><span></span><code><span class="c1">## GC configuration</span>
<span class="m">8</span>-13:-XX:+UseConcMarkSweepGC
<span class="m">8</span>-13:-XX:CMSInitiatingOccupancyFraction<span class="o">=</span><span class="m">75</span>
<span class="m">8</span>-13:-XX:+UseCMSInitiatingOccupancyOnly

<span class="c1">## G1GC Configuration</span>
<span class="c1"># NOTE: G1 GC is only supported on JDK version 10 or later</span>
<span class="c1"># to use G1GC, uncomment the next two lines and update the version on the</span>
<span class="c1"># following three lines to your version of the JDK</span>
<span class="c1"># 10-13:-XX:-UseConcMarkSweepGC</span>
<span class="c1"># 10-13:-XX:-UseCMSInitiatingOccupancyOnly</span>
<span class="m">14</span>-:-XX:+UseG1GC
</code></pre></div>
<p>line <code>14-:</code> applies for we are on version 16 of the jdk:</p>
<div class="highlight"><pre><span></span><code># jdk/bin/java --version
openjdk 16.0.2 2021-07-20
</code></pre></div>
<h3 id="data-size">Data size<a class="headerlink" href="#data-size" title="Permanent link">#</a></h3>
<p>In elasticsearch container:
<div class="highlight"><pre><span></span><code>curl localhost:9200/_cluster/stats?pretty=true
</code></pre></div></p>
<p>We got
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="err">...</span>
<span class="w"> </span><span class="nt">&quot;segments&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;count&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">2390</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;memory_in_bytes&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">76423432</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;terms_memory_in_bytes&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">65353984</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;stored_fields_memory_in_bytes&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1225392</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;term_vectors_memory_in_bytes&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;norms_memory_in_bytes&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">9117696</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;points_memory_in_bytes&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;doc_values_memory_in_bytes&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">726360</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;index_writer_memory_in_bytes&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">35328144</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;version_map_memory_in_bytes&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;fixed_bit_set_memory_in_bytes&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">960</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;max_unsafe_auto_id_timestamp&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1658927252002</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;file_sizes&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w"> </span><span class="err">...</span>
<span class="p">}</span>
</code></pre></div>
other memory values (for <code>querycache</code> or <code>fielddata</code>) ar <code>0</code> or near <code>0</code>.</p>
<p>This is 188,175,008 bytes in total, which is 180m.</p>
<p>If we look at nodes using <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.14/cat-nodes.html">cat nodes API</a>:</p>
<p><div class="highlight"><pre><span></span><code>curl -XGET &quot;localhost:9200/_cat/nodes?v=true&amp;h=name,node*,heap*&quot;
name         id   node.role   heap.current heap.percent heap.max
0665175f0369 3vOq cdfhilmrstw      978.5mb           95      1gb
</code></pre></div>
we see two potential problems:</p>
<ul>
<li>heap size is only 1gb (it should be 2 according to our heap settings)</li>
<li>our a node use 95% memory</li>
</ul>
<h3 id="too-many-shards">Too many shards ?<a class="headerlink" href="#too-many-shards" title="Permanent link">#</a></h3>
<p>following <a href="https://www.elastic.co/blog/managing-and-troubleshooting-elasticsearch-memory">Es blog on memory troubleshooting</a></p>
<p>Over sharding is a usual suspect, let see:</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="err">curl</span><span class="w"> </span><span class="mi">-</span><span class="err">XGET</span><span class="w"> </span><span class="s2">&quot;localhost:9200/_cluster/health?filter_path=status,*_shards&amp;pretty=true&quot;</span>
<span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;active_primary_shards&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">317</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;active_shards&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">317</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;relocating_shards&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;initializing_shards&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;unassigned_shards&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">302</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;delayed_unassigned_shards&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="p">}</span>
</code></pre></div>
<p>while recommanded for our setting (2Gb) is 40 shards !
Also having <code>unassigned_shards</code> seems a bad news !</p>
<p>The problems comes from the fact that we have many indices. The ILM (Index Life Cycle Management) should prevent that, but it does not.</p>
<h2 id="repairing-backup-then-remove-old-indices">Repairing (backup then remove old indices)<a class="headerlink" href="#repairing-backup-then-remove-old-indices" title="Permanent link">#</a></h2>
<h3 id="more-memory_1">More memory<a class="headerlink" href="#more-memory_1" title="Permanent link">#</a></h3>
<p>First I need to snapshot to eventually clear some indices. But with the exception I can't do it, I can't even check a snapshot repository already exists:</p>
<div class="highlight"><pre><span></span><code>$ curl -XGET 127.0.0.1:9200/_snapshot
{&quot;error&quot;:{&quot;root_cause&quot;:[{&quot;type&quot;:&quot;circuit_breaking_exception&quot;,&quot;reason&quot;:&quot;[parent] Data too large, data for [&lt;http_request&gt;] would be [1026619992/979mb], which is larger than the limit of [1020054732/972.7mb], real usage: [1026619992/979mb], new bytes reserved: [0/0b], usages [request=0/0b, fielddata=815/815b, in_flight_request...
</code></pre></div>
<p>No choice then, we have to give ES enough memory to be able to handle current indices we go for a hype of 8G.
I change the <code>docker-compose.yml</code>:
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nt">elasticsearch</span><span class="p">:</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">...</span>

<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">- &quot;ES_JAVA_OPTS=-Xms8048m -Xmx8048m&quot;</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="nt">mem_limit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9g</span>
</code></pre></div></p>
<p>But then again after a while we are blocked by the exception again :-(
Even stranger, we have a larger than the limit of [1020054732/972.7mb]</p>
<p>circuit breaker limit was for request not total !
changed <code>indices.breaker.request.limit=95%</code> to <code>indices.breaker.total.limit=95%</code>.
... same result !</p>
<h3 id="snapshoting-backup">Snapshoting (backup)<a class="headerlink" href="#snapshoting-backup" title="Permanent link">#</a></h3>
<p>Trying to backup:</p>
<ul>
<li>
<p>modified docker-compose.yml to add</p>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">elasticsearch</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>

<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">- &quot;path.repo=/opt/elasticsearch/backups&quot;</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">elasticsearch-backup:/opt/elasticsearch</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="nn">...</span>
<span class="nt">elasticsearch-backup</span><span class="p">:</span>
</code></pre></div>
</li>
</ul>
<ul>
<li>
<p>Create directories</p>
<div class="highlight"><pre><span></span><code>docker-compose<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>elasticsearch<span class="w"> </span>bash
<span class="nb">cd</span><span class="w"> </span>/opt/elasticsearch
mkdir<span class="w"> </span>backups
chown<span class="w"> </span>elasticsearch<span class="w"> </span>/opt/elasticsearch/<span class="w"> </span>-R
</code></pre></div>
</li>
</ul>
<ul>
<li>
<p>Recreated container</p>
<div class="highlight"><pre><span></span><code>docker-compose<span class="w"> </span>rm<span class="w"> </span>-sf<span class="w"> </span>elasticsearch
docker-compose<span class="w"> </span>up<span class="w"> </span>-d<span class="w"> </span>elasticsearch
</code></pre></div>
</li>
</ul>
<ul>
<li>Created the snapshot repository
  <div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>PUT<span class="w"> </span><span class="s2">&quot;http://localhost:9200/_snapshot/backups?pretty&quot;</span><span class="w"> </span>-H<span class="w"> </span><span class="s1">&#39;Content-Type: application/json&#39;</span><span class="w">     </span>-d<span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">  &quot;type&quot;: &quot;fs&quot;,</span>
<span class="s1">  &quot;settings&quot;: {</span>
<span class="s1">    &quot;location&quot;: &quot;/opt/elasticsearch/backups&quot;</span>
<span class="s1">  }</span>
<span class="s1">}</span>
<span class="s1">&#39;</span>
</code></pre></div>
  <strong>Note:</strong> (we had to retry several times because of circuit breaking exceptions)</li>
</ul>
<ul>
<li>get all indices names<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-XGET<span class="w"> </span><span class="s2">&quot;http://localhost:9200/*?pretty=true&quot;</span><span class="p">|</span>grep<span class="w"> </span><span class="s1">&#39;^  &quot;logs&#39;</span>
</code></pre></div>
</li>
</ul>
<ul>
<li>
<p>make a global snapshot, in a screen !!!</p>
<p><div class="highlight"><pre><span></span><code>screen
...
curl<span class="w"> </span>-X<span class="w"> </span>PUT<span class="w"> </span><span class="s2">&quot;localhost:9200/_snapshot/backups/2022-07-31?wait_for_completion=true&amp;pretty&quot;</span><span class="w"> </span>-H<span class="w">   </span><span class="s1">&#39;Content-Type: application/json&#39;</span><span class="w"> </span>-d<span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">  &quot;indices&quot;: [],</span>
<span class="s1">  &quot;ignore_unavailable&quot;: true,</span>
<span class="s1">  &quot;include_global_state&quot;: false,</span>
<span class="s1">  &quot;metadata&quot;: {</span>
<span class="s1">    &quot;taken_by&quot;: &quot;alex&quot;,</span>
<span class="s1">    &quot;taken_because&quot;: &quot;backup before removing some indices&quot;</span>
<span class="s1">  }</span>
<span class="s1">}</span>
<span class="s1">&#39;</span>
</code></pre></div>
And it's a success !</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="nt">&quot;snapshot&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;snapshot&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-07-31&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;uuid&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;kHQXBTGhQb-4-jH0m5mMfg&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;repository&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;backups&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;version_id&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">7140199</span><span class="p">,</span>
<span class="w">  </span><span class="err">...</span>
<span class="w">  </span><span class="nt">&quot;state&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SUCCESS&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;start_time&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-07-31T18:06:51.220Z&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;start_time_in_millis&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1659290811220</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;end_time&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-07-31T18:15:08.301Z&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;end_time_in_millis&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1659291308301</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;duration_in_millis&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">497081</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;failures&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;shards&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;total&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">322</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;failed&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;successful&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">322</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;feature_states&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">]</span>
<span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ul>
<p>So we start removing indices !</p>
<h3 id="removing-indices">Removing indices<a class="headerlink" href="#removing-indices" title="Permanent link">#</a></h3>
<p>Let's remove 2021 logs</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>DELETE<span class="w"> </span><span class="s2">&quot;localhost:9200/logs-2021.*?pretty=true&quot;</span>
</code></pre></div>
<p>Is hard to pass, so we restart elasticsearch and try again success.</p>
<p>Lets remove 2022.01 until 04</p>
<p>Finally it works !</p>
<h2 id="fixing-snapshot-policy-and-ilm-policy">Fixing Snapshot policy and ILM policy<a class="headerlink" href="#fixing-snapshot-policy-and-ilm-policy" title="Permanent link">#</a></h2>
<p>It is a temporary fix now we have to use kibana to setup a better policy (and maybe take ES memory down a bit again ?)</p>
<h3 id="create-snapshot-policy">Create snapshot policy<a class="headerlink" href="#create-snapshot-policy" title="Permanent link">#</a></h3>
<p>In Kibana, go to Management -&gt; Stack Management -&gt; Snapshot and restore</p>
<p>In "Repositories" we see the <code>backups</code> repository that was created before, pointing to <code>/opt/elasticsearch/backups</code></p>
<p>Remember that we had to edit the <code>docker-compose.yml</code> file to add the <code>path.repo</code> environment variable and the <code>elasticsearch-backup</code> volume.</p>
<p>In "Policies", we create a policy named <code>weekly-snapshots</code> as follow:</p>
<ul>
<li>Snapshot name: <code>&lt;weekly-snap-{now/d}&gt;</code></li>
<li>Repository: backups</li>
<li>Schedule : weekly</li>
<li>Data streams and indices: All indices</li>
<li>Ignore unavailable indices: No</li>
<li>Allow partial shards: No</li>
<li>Include global state: Yes</li>
<li>Retention: delete after 360d</li>
<li>Min count: 20</li>
</ul>
<h3 id="create-index-lifecycle-management-policy">Create Index Lifecycle Management policy<a class="headerlink" href="#create-index-lifecycle-management-policy" title="Permanent link">#</a></h3>
<p>This part is very important. Logs are creating a lot of indices (as logrotate would) and so we have to automatically manage what happens with old indices so that we do not go beyond hardware capabilities (too much indices takes too much memory).
ES has a mechanism for that called Index Lifecycle Management (ILM).</p>
<p>In Kibana, go to Management -&gt; Stack Management -&gt; Index Lifecycle Policy</p>
<p>There is already a log policy. Edit it to have this:</p>
<ul>
<li>Hot phase (the phase where the index is the active index for logs)<ul>
<li>Roll over : use recommended defaults</li>
<li>set index priority to 100</li>
</ul>
</li>
<li>Warm phase (the phase where the index is history of logs, you want to search)<ul>
<li>Move data into phase when 58 days old</li>
<li>replicas: 0</li>
<li>Shrink: to 1</li>
<li>Force merge to 1 + compress</li>
<li>mark read only</li>
<li>index priority: 50</li>
</ul>
</li>
<li>Cold phase (historical data, last phase before removal)<ul>
<li>Move data into phase when: 119 days old</li>
<li>Do not make them searchable</li>
</ul>
</li>
<li>Delete phase:<ul>
<li>move data intor phase when 240 days old</li>
<li>Wait for snapshot policy: weekly-snapshots</li>
</ul>
</li>
</ul>
<h3 id="attach-policy-to-index-template">Attach policy to index template<a class="headerlink" href="#attach-policy-to-index-template" title="Permanent link">#</a></h3>
<p>Attach the logs policy you edited to the logs index template.</p>
<p>In Management -&gt; Stack Management -&gt; Index Lifecycle Policy,</p>
<ul>
<li>On the line corresponding to <strong>logs</strong> policy, use <em>Action</em> button + <em>Add policy to index template</em></li>
<li>Set template to <strong>logs</strong></li>
<li>Set alias to <strong>logs-current</strong></li>
</ul>
<p>We notice that logs template pattern was not coherent, as it was <code>logs-*-*</code>, so we also add <code>logs-*.*.*</code> that match our indexes names.
To do this goes to Management -&gt; Stack Management -&gt; Index Management -&gt; Index Templates, and edit the logs template.</p>
<p>Now we have to create the active alias. It should correspond to our last index. This was <code>logs-2022.08.18</code> at time of writing.</p>
<p>In the Dev Tool -&gt; Console, we run:</p>
<div class="highlight"><pre><span></span><code>POST _aliases
{
  &quot;actions&quot;: [
    {
      &quot;add&quot;: {
        &quot;index&quot;: &quot;logs-2022.08.18&quot;,
        &quot;alias&quot;: &quot;logs-current&quot;,
         &quot;is_write_index&quot;: true
      }
    }
  ]
}
</code></pre></div>
<p>We then go to  Management -&gt; Stack Management -&gt; Index Management</p>
<p>Select <em>logs-2022.08.18</em> and use "Manage" apply log policy, with:</p>
<ul>
<li>policy: logs</li>
<li>alias: logs-current</li>
</ul>
<h3 id="attach-old-index-to-a-policy">Attach old index to a policy<a class="headerlink" href="#attach-old-index-to-a-policy" title="Permanent link">#</a></h3>
<p>This will add it for future indices, but we want to add it to existing indices (we follow <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/ilm-with-existing-indices.html">ES doc, section Manage existing indices</a>).</p>
<ul>
<li>going to Management -&gt; Stack Management -&gt; Index Lifecycle Policy
  we create a policy that is exactly the same as logs policy but:<ul>
<li>name is logs-old</li>
<li>rollover is disabled</li>
</ul>
</li>
<li>we apply it to 05 logs, in Dev Tool -&gt; Console, by running (put the unix timestamp value corresponding to the month in <code>origination_date</code><sup id="fnref:origination_date"><a class="footnote-ref" href="#fn:origination_date">1</a></sup>):
  <div class="highlight"><pre><span></span><code>PUT logs-2022.05.*/_settings
{
  &quot;index&quot;: {
    &quot;lifecycle&quot;: {
      &quot;name&quot;: &quot;logs-old&quot;
      &quot;origination_date&quot;: &quot;xxxxx&quot;
    }
  }
}
</code></pre></div></li>
<li>we do the  same for every monthes until 08, but beware not to apply it to 2022.08.18 !</li>
</ul>
<h2 id="useful-resources">Useful resources<a class="headerlink" href="#useful-resources" title="Permanent link">#</a></h2>
<p>About circuit breaker exception:</p>
<ul>
<li>https://aws.amazon.com/premiumsupport/knowledge-center/opensearch-circuit-breaker-exception/</li>
<li>https://www.elastic.co/blog/improving-node-resiliency-with-the-real-memory-circuit-breaker</li>
<li>https://www.elastic.co/guide/en/elasticsearch/reference/7.0/circuit-breaker.html#parent-circuit-breaker</li>
</ul>
<p>About index lifecycle management (ILM):</p>
<ul>
<li>https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started-index-lifecycle-management.html</li>
<li>https://www.elastic.co/guide/en/elasticsearch/reference/current/index-lifecycle-management.html</li>
</ul>
<div class="footnote">
<hr />
<ol>
<li id="fn:origination_date">
<p>this is the timestamp used to calculate the index age for its phase transitions. If not specified, today date is taken.
see <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.6/ilm-settings.html#index-lifecycle-origination-date">documentation</a>.
You can get timestamp, eg in python with <code>datetime(year, month, date).timestamp()</code>.&#160;<a class="footnote-backref" href="#fnref:origination_date" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.3220b9d7.min.js"></script>
      
    
  <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>