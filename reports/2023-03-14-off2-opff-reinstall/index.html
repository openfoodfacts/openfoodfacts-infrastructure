
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../2023-02-24-zfs-introduction/">
      
      
        <link rel="next" href="../2023-04-27-moving-docker-stagging-to-ovh1/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.14">
    
    
      
        <title>2023-03 OFF2 reinstall - opff migration - Open Food Facts Infrastructure documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.10ba22f1.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2023-03-off2-reinstall-opff-migration" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Open Food Facts Infrastructure documentation" class="md-header__button md-logo" aria-label="Open Food Facts Infrastructure documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Open Food Facts Infrastructure documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2023-03 OFF2 reinstall - opff migration
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/openfoodfacts/openfoodfacts-infrastructure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Open Food Facts Infrastructure documentation" class="md-nav__button md-logo" aria-label="Open Food Facts Infrastructure documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Open Food Facts Infrastructure documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/openfoodfacts/openfoodfacts-infrastructure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OpenFoodFacts Infrastructure
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cicd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Continous Integration and Continuous Delivery
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../discourse/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Discourse
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../disks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Disks
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker at Open Food Facts
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../docker_architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker architecture
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../docker_onboarding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Onboarding
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../explain-server-config-in-git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Explanation on server configuration with git
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../folksonomy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Folksonomy API
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../free-datacenter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Free Datacenter
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-add-disk-space-on-qemu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to add disk space on a Qemu VM
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-fail2ban-ban-bots/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to use fail2ban to ban bots
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-fail2ban-debian-11%2B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to install fail2ban on debian 11+
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-have-server-config-in-git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to have server config in git
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to-mitigate-crawlers-on-prod/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to mitigate crawlers in case of too much traffic
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux-server/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux server
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-off1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    off1 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-off2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    off2 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-off3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    off3 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-ovh1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ovh1 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-ovh2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ovh2 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logs-ovh3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ovh3 server logs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mail/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mail on Open Food Facts infrastructure
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../matomo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Matomo
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mongodb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MongoDB
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../munin/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Munin
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../nginx-reverse-proxy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NGINX Reverse proxy
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Observability
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../odoo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Odoo: our relationship management (connect.openfoodfacts.org)
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../postgres/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PostgreSQL
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../prod-architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Production architecture
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../producers_sftp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Producers SFTP
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../product-opener/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Product Opener
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../proxmox/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Proxmox
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../rclone/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rclone
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sanoid/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sanoid
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../slackin/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    auto Slack invitation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../stunnel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Stunnel
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../zammad/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Zammad
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../zfs-overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ZFS overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_42" checked>
        
          
          <label class="md-nav__link" for="__nav_42" id="__nav_42_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reports
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_42_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_42">
            <span class="md-nav__icon md-icon"></span>
            Reports
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-02-22-matomo-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Matomo install
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-10-03-network-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    [Postmortem] OpenFoodFacts.net down (#1)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-12-21-disk-extension/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Disk extension for preprod and containers prod (ovh2)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2021-12-22-preprod-crash/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preprod crash 2021 12
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-18-ovh-reverse-proxy-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    [Postmortem] Reverse proxy down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-proxmox-mail-gateway-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Install of proxmox gateway server
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-02-remove-containers-ovh1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-02 Removing some containers on ovh1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-03-03-zammad-elasticsearch-not-running/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Elasticsearch not running on Zammad
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-03-off2-PCI-NVMe-problems/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-03 Problem with PCI supporting NVMe
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-07-08-journey-to-deploy-off-search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deploying openfoodfacts-search to staging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-07-11-infra-workshop/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Infrastructure future - workshop on 11th July 2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-07-kibana-down-es-circuit-breaking-exception/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kibana down because of Elasticsearch circuit_breaking_exception
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-08-17-openfoodfacts-net-unreachable/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-08-17 openfoodfacts.net unreachable
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2022-11-09-monitoring-move-to-own-vm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-11 moving monitoring to its own machine
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-13-zammad-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-02-13 Zammad down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-16-off2-shutdown/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 02 16 off2 shutdown
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-17-off2-upgrade/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-02-17 Off2 Upgrade
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-02-24-zfs-introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 02 24 zfs introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    2023-03 OFF2 reinstall - opff migration
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    2023-03 OFF2 reinstall - opff migration
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#storage-situation-before-re-install" class="md-nav__link">
    <span class="md-ellipsis">
      Storage situation before re-install
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx-reverse-proxy-install" class="md-nav__link">
    <span class="md-ellipsis">
      NGINX reverse proxy install
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NGINX reverse proxy install">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing-container" class="md-nav__link">
    <span class="md-ellipsis">
      Installing Container
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-the-ip" class="md-nav__link">
    <span class="md-ellipsis">
      Adding the IP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#re-enforcing-security-thanks-to-fail2ban" class="md-nav__link">
    <span class="md-ellipsis">
      Re-enforcing security thanks to fail2ban
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#declaring-dns-entry" class="md-nav__link">
    <span class="md-ellipsis">
      declaring DNS entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloning-git-infra-repository" class="md-nav__link">
    <span class="md-ellipsis">
      Cloning git infra repository
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      NGINX configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openpetfoodfacts-host" class="md-nav__link">
    <span class="md-ellipsis">
      OpenPetFoodFacts host
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#certbot-wildcard-certificates-using-ovh-dns" class="md-nav__link">
    <span class="md-ellipsis">
      certbot wildcard certificates using OVH DNS
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#putting-data-in-zfs-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      Putting data in zfs datasets
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Putting data in zfs datasets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      creating datasets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#products-for-all-flavors" class="md-nav__link">
    <span class="md-ellipsis">
      Products (for all flavors)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#users" class="md-nav__link">
    <span class="md-ellipsis">
      Users
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#products-images" class="md-nav__link">
    <span class="md-ellipsis">
      Products images
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-data-and-cache" class="md-nav__link">
    <span class="md-ellipsis">
      other data (and cache)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snapshots-and-syncs-with-sanoid" class="md-nav__link">
    <span class="md-ellipsis">
      Snapshots and Syncs with sanoid
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Snapshots and Syncs with sanoid">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing" class="md-nav__link">
    <span class="md-ellipsis">
      Installing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setting-up-snapshot-and-syncs" class="md-nav__link">
    <span class="md-ellipsis">
      setting up snapshot and syncs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#open-pet-food-facts-container-install" class="md-nav__link">
    <span class="md-ellipsis">
      Open Pet Food Facts container install
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Open Pet Food Facts container install">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-container" class="md-nav__link">
    <span class="md-ellipsis">
      Creating Container
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-packages" class="md-nav__link">
    <span class="md-ellipsis">
      Installing packages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoip-updates" class="md-nav__link">
    <span class="md-ellipsis">
      GeoIP updates
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mounting-volumes" class="md-nav__link">
    <span class="md-ellipsis">
      Mounting volumes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing-opff-code" class="md-nav__link">
    <span class="md-ellipsis">
      Installing OPFF code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Installing OPFF code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getting-the-code" class="md-nav__link">
    <span class="md-ellipsis">
      Getting the code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linking-data" class="md-nav__link">
    <span class="md-ellipsis">
      linking data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linking-logs" class="md-nav__link">
    <span class="md-ellipsis">
      linking logs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linking-translations" class="md-nav__link">
    <span class="md-ellipsis">
      linking translations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify-config-links" class="md-nav__link">
    <span class="md-ellipsis">
      verify config links
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#some-broken-strange-links" class="md-nav__link">
    <span class="md-ellipsis">
      some broken / strange links
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-git" class="md-nav__link">
    <span class="md-ellipsis">
      Using git
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#finding-opff-version" class="md-nav__link">
    <span class="md-ellipsis">
      Finding OPFF version
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modifying-git-code-to-match-opff-code" class="md-nav__link">
    <span class="md-ellipsis">
      modifying git code to match opff code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swapping-code-for-the-one-of-the-git-repo" class="md-nav__link">
    <span class="md-ellipsis">
      Swapping code for the one of the git repo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-dists" class="md-nav__link">
    <span class="md-ellipsis">
      Adding dists
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-openfoodfacts-web" class="md-nav__link">
    <span class="md-ellipsis">
      Adding openfoodfacts-web
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Adding openfoodfacts-web">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cloning-repo" class="md-nav__link">
    <span class="md-ellipsis">
      Cloning repo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linking-content" class="md-nav__link">
    <span class="md-ellipsis">
      Linking content
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linking-images" class="md-nav__link">
    <span class="md-ellipsis">
      Linking images
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-cpan" class="md-nav__link">
    <span class="md-ellipsis">
      Installing CPAN
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-services" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up services
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setting up services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nginx-for-opff-inside-container" class="md-nav__link">
    <span class="md-ellipsis">
      NGINX for OPFF (inside container)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apache" class="md-nav__link">
    <span class="md-ellipsis">
      Apache
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-systemd-units-for-timers-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      creating systemd units for timers jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-failure-notification-for-apache-and-nginx-in-systemd" class="md-nav__link">
    <span class="md-ellipsis">
      Adding failure notification for apache and nginx in systemd
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    <span class="md-ellipsis">
      Testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verifying-if-we-need-apache2connectionxforwardedfor" class="md-nav__link">
    <span class="md-ellipsis">
      Verifying if we need Apache2::Connection::XForwardedFor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#log-rotate-perl-logs" class="md-nav__link">
    <span class="md-ellipsis">
      log rotate perl logs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-mongodb-client" class="md-nav__link">
    <span class="md-ellipsis">
      Installing mongodb client
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#opff-nginx-reverse-proxy-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      OPFF NGINX reverse proxy configuration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debugs-and-fixing" class="md-nav__link">
    <span class="md-ellipsis">
      Debugs and fixing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Debugs and fixing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#testing_1" class="md-nav__link">
    <span class="md-ellipsis">
      Testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongodb-access" class="md-nav__link">
    <span class="md-ellipsis">
      Mongodb access
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fixing-geoip" class="md-nav__link">
    <span class="md-ellipsis">
      Fixing GeoIP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#x-forwarded-for-problem" class="md-nav__link">
    <span class="md-ellipsis">
      X-Forwarded-For problem
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fixing-lang-problem" class="md-nav__link">
    <span class="md-ellipsis">
      Fixing lang problem
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enabling-migration-by-cross-nfs-mounting-folders" class="md-nav__link">
    <span class="md-ellipsis">
      Enabling migration by cross nfs mounting folders
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Enabling migration by cross nfs mounting folders">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mount-off1-zfs-dataset-on-off2" class="md-nav__link">
    <span class="md-ellipsis">
      Mount off1 ZFS dataset on off2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bind-mount" class="md-nav__link">
    <span class="md-ellipsis">
      Bind mount
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sharing-users-with-nfs" class="md-nav__link">
    <span class="md-ellipsis">
      Sharing users with NFS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Sharing users with NFS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prepare-to-mount-off2-datasets-on-off1" class="md-nav__link">
    <span class="md-ellipsis">
      Prepare to mount off2 datasets on off1
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#improvment" class="md-nav__link">
    <span class="md-ellipsis">
      Improvment
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Improvment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-git-for-off2-configurations" class="md-nav__link">
    <span class="md-ellipsis">
      using git for off2 configurations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#procedure-for-switch-of-opff-from-off1-to-off2" class="md-nav__link">
    <span class="md-ellipsis">
      Procedure for switch of opff from off1 to off2
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#still-todo" class="md-nav__link">
    <span class="md-ellipsis">
      Still TODO
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Still TODO">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#done" class="md-nav__link">
    <span class="md-ellipsis">
      DONE
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#improve" class="md-nav__link">
    <span class="md-ellipsis">
      Improve
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#todo-for-off-install" class="md-nav__link">
    <span class="md-ellipsis">
      TODO for off install
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-04-27-moving-docker-stagging-to-ovh1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-04-27 moving docker staging to OVH1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-12-refresh-staging-clones/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022-05-12 refresh staging clones
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-19-overload-of-osm-machine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-05-18 Mongodb down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-23-move-images-to-zfs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-05-23 move Images to ZFS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-05-off2-110-unreachable/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-05-23 off2 - container 110 unreachable from 101
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-01-robotoff-backups/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-01 Robotoff backups
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-07-off2-opf-obf-reinstall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-07 OPF and OBF reinstall on off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-08-stalled-zfs-sync-off-products/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2012-06-08 Stalled ZFS Sync for off products on ovh3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-06-30-sanoid-checks-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-30 Sanoid checks install
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-07-16-ovh3-sdc-broken/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Post-mortem 2023-07-16 Disk sdc errors on OVH3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-07-26-off1-rpool-products-full/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-07-26 rpool/off/products dataset full on off1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-07-off-reinstall--prod-files-diff/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023 07 off reinstall  prod files diff
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-07-off2-off-reinstall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-06-07 OFF and OFF-pro reinstall on off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-08-31-off2-products-snapshots-clean/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-08-31 OFF2 products snapshots clean
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-09-27-expired-ssl-certificate-for-images-on-off2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-09-27 / Expired SSL certificate for images.openfoodfacts.org on off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-10-14-mongodb-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-10-14: mongodb-down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-11-28-google-drive-backup-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-11-28 setup a google drive backup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-11-28-ovh3-sdf-broken/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Post-mortem 2023-11-28 Disk sdf errors on OVH3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-12-08-off1-upgrade/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-12-08 off1 upgrade
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2023-12-11-matomo-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023-12-11 Matomo down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-02-monitoring-disk-space/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01-02 monitoring disk space - filebeat
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-03-mongodb-migration-off1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01-03 MongoDB migration on off3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-04-setting-up-stunnel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024 01 04 setting up stunnel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-19-certbot-failure-off2-proxy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01-19 Certbot failure on off2 reverse proxy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-24-move-old-productopener-folders-to-backup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01-24 Move old Product Opener folders to backup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-01-matomo-perf-tunning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-01 Matomo performance tunning
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-06-cleanup-products-snapshots/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-06 cleanup of products ssnapshots on off2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-08-prod-redis-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-08 Production Redis install
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-13-chatwoot-translation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-13 Chatwoot translation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-13-matomo-fix-queue0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2014-02-13 Matomo fix Queue0
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-20-exporter-on-mongodb-ct/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-20 Installing a prometheus exporter on mongodb container
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-02-28-upgrade-redis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-02-28 Upgrade Redis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-03-17-ovh1-down/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-03-17 OVH1 Down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-03-restructure-backups/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-03 Restructure backups
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2024-03-separate-hdd-docker-vms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024-03 separate HDD on docker VMs
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#storage-situation-before-re-install" class="md-nav__link">
    <span class="md-ellipsis">
      Storage situation before re-install
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx-reverse-proxy-install" class="md-nav__link">
    <span class="md-ellipsis">
      NGINX reverse proxy install
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NGINX reverse proxy install">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing-container" class="md-nav__link">
    <span class="md-ellipsis">
      Installing Container
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-the-ip" class="md-nav__link">
    <span class="md-ellipsis">
      Adding the IP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#re-enforcing-security-thanks-to-fail2ban" class="md-nav__link">
    <span class="md-ellipsis">
      Re-enforcing security thanks to fail2ban
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#declaring-dns-entry" class="md-nav__link">
    <span class="md-ellipsis">
      declaring DNS entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloning-git-infra-repository" class="md-nav__link">
    <span class="md-ellipsis">
      Cloning git infra repository
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nginx-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      NGINX configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openpetfoodfacts-host" class="md-nav__link">
    <span class="md-ellipsis">
      OpenPetFoodFacts host
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#certbot-wildcard-certificates-using-ovh-dns" class="md-nav__link">
    <span class="md-ellipsis">
      certbot wildcard certificates using OVH DNS
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#putting-data-in-zfs-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      Putting data in zfs datasets
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Putting data in zfs datasets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      creating datasets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#products-for-all-flavors" class="md-nav__link">
    <span class="md-ellipsis">
      Products (for all flavors)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#users" class="md-nav__link">
    <span class="md-ellipsis">
      Users
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#products-images" class="md-nav__link">
    <span class="md-ellipsis">
      Products images
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-data-and-cache" class="md-nav__link">
    <span class="md-ellipsis">
      other data (and cache)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#snapshots-and-syncs-with-sanoid" class="md-nav__link">
    <span class="md-ellipsis">
      Snapshots and Syncs with sanoid
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Snapshots and Syncs with sanoid">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installing" class="md-nav__link">
    <span class="md-ellipsis">
      Installing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setting-up-snapshot-and-syncs" class="md-nav__link">
    <span class="md-ellipsis">
      setting up snapshot and syncs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#open-pet-food-facts-container-install" class="md-nav__link">
    <span class="md-ellipsis">
      Open Pet Food Facts container install
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Open Pet Food Facts container install">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-container" class="md-nav__link">
    <span class="md-ellipsis">
      Creating Container
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-packages" class="md-nav__link">
    <span class="md-ellipsis">
      Installing packages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geoip-updates" class="md-nav__link">
    <span class="md-ellipsis">
      GeoIP updates
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mounting-volumes" class="md-nav__link">
    <span class="md-ellipsis">
      Mounting volumes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing-opff-code" class="md-nav__link">
    <span class="md-ellipsis">
      Installing OPFF code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Installing OPFF code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getting-the-code" class="md-nav__link">
    <span class="md-ellipsis">
      Getting the code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linking-data" class="md-nav__link">
    <span class="md-ellipsis">
      linking data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linking-logs" class="md-nav__link">
    <span class="md-ellipsis">
      linking logs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linking-translations" class="md-nav__link">
    <span class="md-ellipsis">
      linking translations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify-config-links" class="md-nav__link">
    <span class="md-ellipsis">
      verify config links
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#some-broken-strange-links" class="md-nav__link">
    <span class="md-ellipsis">
      some broken / strange links
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-git" class="md-nav__link">
    <span class="md-ellipsis">
      Using git
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#finding-opff-version" class="md-nav__link">
    <span class="md-ellipsis">
      Finding OPFF version
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modifying-git-code-to-match-opff-code" class="md-nav__link">
    <span class="md-ellipsis">
      modifying git code to match opff code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swapping-code-for-the-one-of-the-git-repo" class="md-nav__link">
    <span class="md-ellipsis">
      Swapping code for the one of the git repo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-dists" class="md-nav__link">
    <span class="md-ellipsis">
      Adding dists
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-openfoodfacts-web" class="md-nav__link">
    <span class="md-ellipsis">
      Adding openfoodfacts-web
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Adding openfoodfacts-web">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cloning-repo" class="md-nav__link">
    <span class="md-ellipsis">
      Cloning repo
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linking-content" class="md-nav__link">
    <span class="md-ellipsis">
      Linking content
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#linking-images" class="md-nav__link">
    <span class="md-ellipsis">
      Linking images
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-cpan" class="md-nav__link">
    <span class="md-ellipsis">
      Installing CPAN
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-services" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up services
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setting up services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nginx-for-opff-inside-container" class="md-nav__link">
    <span class="md-ellipsis">
      NGINX for OPFF (inside container)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apache" class="md-nav__link">
    <span class="md-ellipsis">
      Apache
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-systemd-units-for-timers-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      creating systemd units for timers jobs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-failure-notification-for-apache-and-nginx-in-systemd" class="md-nav__link">
    <span class="md-ellipsis">
      Adding failure notification for apache and nginx in systemd
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    <span class="md-ellipsis">
      Testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verifying-if-we-need-apache2connectionxforwardedfor" class="md-nav__link">
    <span class="md-ellipsis">
      Verifying if we need Apache2::Connection::XForwardedFor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#log-rotate-perl-logs" class="md-nav__link">
    <span class="md-ellipsis">
      log rotate perl logs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-mongodb-client" class="md-nav__link">
    <span class="md-ellipsis">
      Installing mongodb client
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#opff-nginx-reverse-proxy-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      OPFF NGINX reverse proxy configuration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debugs-and-fixing" class="md-nav__link">
    <span class="md-ellipsis">
      Debugs and fixing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Debugs and fixing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#testing_1" class="md-nav__link">
    <span class="md-ellipsis">
      Testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongodb-access" class="md-nav__link">
    <span class="md-ellipsis">
      Mongodb access
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fixing-geoip" class="md-nav__link">
    <span class="md-ellipsis">
      Fixing GeoIP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#x-forwarded-for-problem" class="md-nav__link">
    <span class="md-ellipsis">
      X-Forwarded-For problem
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fixing-lang-problem" class="md-nav__link">
    <span class="md-ellipsis">
      Fixing lang problem
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enabling-migration-by-cross-nfs-mounting-folders" class="md-nav__link">
    <span class="md-ellipsis">
      Enabling migration by cross nfs mounting folders
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Enabling migration by cross nfs mounting folders">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mount-off1-zfs-dataset-on-off2" class="md-nav__link">
    <span class="md-ellipsis">
      Mount off1 ZFS dataset on off2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bind-mount" class="md-nav__link">
    <span class="md-ellipsis">
      Bind mount
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sharing-users-with-nfs" class="md-nav__link">
    <span class="md-ellipsis">
      Sharing users with NFS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Sharing users with NFS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prepare-to-mount-off2-datasets-on-off1" class="md-nav__link">
    <span class="md-ellipsis">
      Prepare to mount off2 datasets on off1
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#improvment" class="md-nav__link">
    <span class="md-ellipsis">
      Improvment
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Improvment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-git-for-off2-configurations" class="md-nav__link">
    <span class="md-ellipsis">
      using git for off2 configurations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#procedure-for-switch-of-opff-from-off1-to-off2" class="md-nav__link">
    <span class="md-ellipsis">
      Procedure for switch of opff from off1 to off2
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#still-todo" class="md-nav__link">
    <span class="md-ellipsis">
      Still TODO
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Still TODO">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#done" class="md-nav__link">
    <span class="md-ellipsis">
      DONE
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#improve" class="md-nav__link">
    <span class="md-ellipsis">
      Improve
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#todo-for-off-install" class="md-nav__link">
    <span class="md-ellipsis">
      TODO for off install
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="2023-03-off2-reinstall-opff-migration">2023-03 OFF2 reinstall - opff migration<a class="headerlink" href="#2023-03-off2-reinstall-opff-migration" title="Permanent link">#</a></h1>
<h2 id="storage-situation-before-re-install">Storage situation before re-install<a class="headerlink" href="#storage-situation-before-re-install" title="Permanent link">#</a></h2>
<pre class="mermaid"><code>---
title: current state
---
flowchart TB
    subgraph free datacenter
        subgraph off1
            OFF1products(OFF1 products)
            OFF1srv(OFF1 srv)
            OFF1images(OFF1 images - non ZFS)
        end
        subgraph off2
            OFF2images(OFF2 images)
            OFF2products(OFF2 products)
        end
    end
    subgraph OVH Datacenter
        subgraph ovh3
            OVH3products(OVH3 products)
            OVH3images(OVH3 images - zfs)
            OVH3backup(OVH3 backup)
            OVH3products --&gt; OVH3ProdSnapshots(OVH3 products snapshots)
            OVH3ProdSnapshots --&gt;|ZFS clone R/W| DotNETProdclone(.net products)
            OVH3images --&gt; OVH3ImgSnapshots(OVH3 images snapshots)
            OVH3ImgSnapshots --&gt;|ZFS clone R/W| DotNetImgclone(.net images)
        end
    end
    %% inter graph links
    OFF1srv --&gt;|Rsync - daily| OVH3backup
    OFF1products --&gt;|ZFS sync| OVH3products
    OFF1images(OFF1 images) --&gt;|RSync - **manual**| OVH3images
    OVH3images --&gt;|ZFS sync| OFF2images
    OVH3images --&gt;|ZFS sync ???| OFF2products</code></pre>
<h2 id="nginx-reverse-proxy-install">NGINX reverse proxy install<a class="headerlink" href="#nginx-reverse-proxy-install" title="Permanent link">#</a></h2>
<h3 id="installing-container">Installing Container<a class="headerlink" href="#installing-container" title="Permanent link">#</a></h3>
<p>I followed <a href="../../proxmox/#how-to-create-a-new-container">How to create a new Container</a></p>
<p>I add a problem running <code>ct_postinstall</code> as it wasn't able to fetch debian archives. Indeed there was no network in the CT.</p>
<ol>
<li>I had to choose vmbr1 as the network bridge</li>
<li>I had to edit the host settings for vmbr1 in <code>/etc/network/interfaces</code> to add:
   <code>post-up echo 1 &gt; /proc/sys/net/ipv4/ip_forward
        post-up   iptables -t nat -A POSTROUTING -s '10.1.0.0/16' -o vmbr0 -j MASQUERADE
        post-down iptables -t nat -D POSTROUTING -s '10.1.0.0/16' -o vmbr0 -j MASQUERADE</code>
    I also tweak a bit to have
    <code>bash
    # ip route list
    default via 213.36.253.222 dev vmbr0 proto kernel onlink
    10.0.0.0/8 dev vmbr1 proto kernel scope link src 10.0.0.2
    213.36.253.192/27 dev vmbr0 proto kernel scope link src 213.36.253.208</code></li>
<li>I also had to reboot the host</li>
</ol>
<p>I then simply install <code>nginx</code> and <code>stunnel4</code> using apt.</p>
<p>I also <a href="../mail#postfix-configuration">configure postfix</a> and tested it.</p>
<h3 id="adding-the-ip">Adding the IP<a class="headerlink" href="#adding-the-ip" title="Permanent link">#</a></h3>
<p>Using proxmox interface, on container 110, I add net1, on vmbr0, IP 213.36.253.214/27, Gateway 213.36.253.222 (copied from Host config).</p>
<p><strong>Important</strong>: I removed the gateway on net0 (see <a href="../../nginx-reverse-proxy/#network-specific-interface">here</a>).</p>
<p>I reboot the container 101, and it seems to work.</p>
<h3 id="re-enforcing-security-thanks-to-fail2ban">Re-enforcing security thanks to fail2ban<a class="headerlink" href="#re-enforcing-security-thanks-to-fail2ban" title="Permanent link">#</a></h3>
<p>Created a <code>confs/proxy-off/fail2ban/jail.d/nginx</code> using debian provided feature for nginx
Then:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/proxy-off/fail2ban/jail.d/nginx.conf<span class="w"> </span>/etc/fail2ban/jail.d/
systemctl<span class="w"> </span>reload<span class="w"> </span>fail2ban
</code></pre></div></p>
<p><strong>NOTE</strong>: it's really not enough, but to analyze 403 / 401 we need a specific plugin that analyze logs.</p>
<h3 id="declaring-dns-entry">declaring DNS entry<a class="headerlink" href="#declaring-dns-entry" title="Permanent link">#</a></h3>
<p>I added an A record <code>proxy-off.openfoodfacts.org</code> to point to this IP in OVH DNS zones.</p>
<h3 id="cloning-git-infra-repository">Cloning git infra repository<a class="headerlink" href="#cloning-git-infra-repository" title="Permanent link">#</a></h3>
<p>as root, I created a ssh key as root:
<div class="highlight"><pre><span></span><code>ssh-keygen<span class="w"> </span>-t<span class="w"> </span>ed25519<span class="w"> </span>-C<span class="w"> </span><span class="s2">&quot;off@proxy-off.openfoodfacts.org&quot;</span>
cat<span class="w"> </span>/root/.ssh/id_ed25519.pub
</code></pre></div>
and add it as <a href="https://github.com/openfoodfacts/openfoodfacts-infrastructure/settings/keys">authorized key in openfoodfacts-infrastructure</a> with write authorization (as it will be mainly modified directly in the container).</p>
<p>Then I cloned the repository in /opt
<div class="highlight"><pre><span></span><code>cd /opt
git clone git@github.com:openfoodfacts/openfoodfacts-infrastructure.git
</code></pre></div></p>
<h3 id="nginx-configuration">NGINX configuration<a class="headerlink" href="#nginx-configuration" title="Permanent link">#</a></h3>
<p>To have same config as on ovh1, I added a <code>log_format.conf</code> file with log format definition:
<div class="highlight"><pre><span></span><code>log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
                  &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
                  &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;
</code></pre></div>
It's in the git repository, so then:</p>
<div class="highlight"><pre><span></span><code>ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/proxy-off/nginx/log_format.conf<span class="w"> </span>/etc/nginx/conf.d/log_format.conf
</code></pre></div>
<h3 id="openpetfoodfacts-host">OpenPetFoodFacts host<a class="headerlink" href="#openpetfoodfacts-host" title="Permanent link">#</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># some shared files</span>
ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/proxy-off/www/off/<span class="w"> </span>/var/www/off
<span class="c1"># conf</span>
ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/proxy-off/nginx/openpetfoodfacts.org<span class="w">  </span>/etc/nginx/sites-enabled/openpetfoodfacts.org
nginx<span class="w"> </span>-t
systemctl<span class="w"> </span>restart<span class="w"> </span>nginx
</code></pre></div>
<h3 id="certbot-wildcard-certificates-using-ovh-dns">certbot wildcard certificates using OVH DNS<a class="headerlink" href="#certbot-wildcard-certificates-using-ovh-dns" title="Permanent link">#</a></h3>
<p>Official documentation: https://certbot-dns-ovh.readthedocs.io/en/stable/ and https://certbot.eff.org/instructions?ws=nginx&amp;os=debianbuster
Official documentation requires snapd we are not keen on that, and moreover, in a lxc container <a href="https://forum.proxmox.com/threads/cant-install-snap-in-lxc-container.68708/">it does not seems to work well</a>.
So we go the alternate way, using the debian package.</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>update
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>certbot<span class="w"> </span>python3-certbot-dns-ovh
</code></pre></div>
<p>Generate credential, following https://eu.api.ovh.com/createToken/</p>
<p>(useful resource for <a href="https://gandrille.github.io/linux-notes/Web_API/OVH_API/OVH_API_Keys_management.html">OVH keys management</a>)</p>
<p>Using:</p>
<ul>
<li>GET /domain/zone/</li>
<li>GET/PUT/POST/DELETE /domain/zone/openfoodfacts.org/*</li>
</ul>
<p><a class="glightbox" href="../../img/2023-05-ovh-create-token-openfoodfacts.org-form.png" data-type="image" data-width="auto" data-height="auto" data-title="token creation at form at OVH" data-desc-position="bottom"><img alt="token creation at form at OVH" src="../../img/2023-05-ovh-create-token-openfoodfacts.org-form.png" title="token creation at form at OVH" width="50%" /></a>
<a class="glightbox" href="../../img/2023-05-ovh-create-token-openfoodfacts.org-result.png" data-type="image" data-width="auto" data-height="auto" data-title="token creation result" data-desc-position="bottom"><img alt="token creation result" src="../../img/2023-05-ovh-create-token-openfoodfacts.org-result.png" title="token creation result" width="50%" /></a></p>
<p>and we put config file in <code>/root/.ovhapi/openpetfoodfacts.org</code>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mkdir<span class="w"> </span>/root/.ovhapi
$<span class="w"> </span>vim<span class="w"> </span>/root/.ovhapi/openpetfoodfacts.org
...
$<span class="w"> </span>cat<span class="w"> </span>/root/.ovhapi/openpetfoodfacts.org
<span class="c1"># OVH API credentials used by Certbot</span>
<span class="nv">dns_ovh_endpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ovh-eu
<span class="nv">dns_ovh_application_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>***********
<span class="nv">dns_ovh_application_secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>***********
<span class="nv">dns_ovh_consumer_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>***********

<span class="c1"># ensure no reading by others</span>
$<span class="w"> </span>chmod<span class="w"> </span>og-rwx<span class="w"> </span>-R<span class="w"> </span>/root/.ovhapi
</code></pre></div></p>
<p>Try to get a wildcard using certbot, we will choose to obtain certificates using a DNS TXT record, and use tech -at- off.org for notifications
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>certbot<span class="w"> </span>certonly<span class="w"> </span>--test-cert<span class="w"> </span>--dns-ovh<span class="w"> </span>--dns-ovh-credentials<span class="w"> </span>/root/.ovhapi/openpetfoodfacts.org<span class="w"> </span>-d<span class="w"> </span>openpetfoodfacts.org<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;*.openpetfoodfacts.org&quot;</span>
...
Plugins<span class="w"> </span>selected:<span class="w"> </span>Authenticator<span class="w"> </span>dns-ovh,<span class="w"> </span>Installer<span class="w"> </span>None
Requesting<span class="w"> </span>a<span class="w"> </span>certificate<span class="w"> </span><span class="k">for</span><span class="w"> </span>openpetfoodfacts.org<span class="w"> </span>and<span class="w"> </span>*.openpetfoodfacts.org
Performing<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>challenges:
dns-01<span class="w"> </span>challenge<span class="w"> </span><span class="k">for</span><span class="w"> </span>openpetfoodfacts.org
dns-01<span class="w"> </span>challenge<span class="w"> </span><span class="k">for</span><span class="w"> </span>openpetfoodfacts.org
Waiting<span class="w"> </span><span class="m">30</span><span class="w"> </span>seconds<span class="w"> </span><span class="k">for</span><span class="w"> </span>DNS<span class="w"> </span>changes<span class="w"> </span>to<span class="w"> </span>propagate
Waiting<span class="w"> </span><span class="k">for</span><span class="w"> </span>verification...
Cleaning<span class="w"> </span>up<span class="w"> </span>challenges
...

<span class="w"> </span>-<span class="w"> </span>Congratulations!<span class="w"> </span>Your<span class="w"> </span>certificate<span class="w"> </span>and<span class="w"> </span>chain<span class="w"> </span>have<span class="w"> </span>been<span class="w"> </span>saved<span class="w"> </span>at:
<span class="w">   </span>/etc/letsencrypt/live/openpetfoodfacts.org/fullchain.pem
</code></pre></div></p>
<p>now we can do a real certificate, by removing the <code>--test-cert</code> option. We will ask to renew &amp; replace the existing certificate (as ith was a test one):</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>certbot<span class="w"> </span>certonly<span class="w"> </span>--test-cert<span class="w"> </span>--dns-ovh<span class="w"> </span>--dns-ovh-credentials<span class="w"> </span>/root/.ovhapi/openpetfoodfacts.org<span class="w"> </span>-d<span class="w"> </span>openpetfoodfacts.org<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;*.openpetfoodfacts.org&quot;</span>
...

<span class="w"> </span>-<span class="w"> </span>Congratulations!<span class="w"> </span>Your<span class="w"> </span>certificate<span class="w"> </span>and<span class="w"> </span>chain<span class="w"> </span>have<span class="w"> </span>been<span class="w"> </span>saved<span class="w"> </span>at:
<span class="w">   </span>/etc/letsencrypt/live/openpetfoodfacts.org/fullchain.pem
...
</code></pre></div>
<p>Now we install it on our website, we did it manually
<div class="highlight"><pre><span></span><code>server {
    listen 80;
    listen [::]:80;
    server_name openpetfoodfacts.org *.openpetfoodfacts.org;

    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name openpetfoodfacts.org *.openpetfoodfacts.org;

    # SSL/TLS settings
    ssl_certificate /etc/letsencrypt/live/openpetfoodfacts.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/openpetfoodfacts.org/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/openpetfoodfacts.org/chain.pem;

...
}
</code></pre></div></p>
<h2 id="putting-data-in-zfs-datasets">Putting data in zfs datasets<a class="headerlink" href="#putting-data-in-zfs-datasets" title="Permanent link">#</a></h2>
<h3 id="creating-datasets">creating datasets<a class="headerlink" href="#creating-datasets" title="Permanent link">#</a></h3>
<p>I init a dataset for each projects: <code>zfs create opff</code>, <code>zfs create opff</code>, etc for <code>off</code>, <code>off-pro</code>, <code>obf</code> and <code>opf</code></p>
<p>I then create <code>zfs create zfs-hdd/opff/html_data</code>, <code>zfs create zfs-hdd/opff/images</code>, <code>zfs create zfs-hdd/opff/cache</code> (not products because we will sync it).</p>
<p>And change permissions of directories:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>chown<span class="w"> </span><span class="m">1000</span>:1000<span class="w">  </span>/zfs-hdd/opff/<span class="w"> </span>/zfs-hdd/opff/html_data<span class="w"> </span>/zfs-hdd/opff/images<span class="w"> </span>/zfs-hdd/opff/cache
</code></pre></div>
<h3 id="products-for-all-flavors">Products (for all flavors)<a class="headerlink" href="#products-for-all-flavors" title="Permanent link">#</a></h3>
<p>Notice: the script to sync is not working out of the box because it use <code>-i</code> even if distant snapshot is empty !</p>
<p>Initiate:
real    0m0.714s
<div class="highlight"><pre><span></span><code><span class="nb">time</span><span class="w"> </span>zfs<span class="w"> </span>send<span class="w"> </span>rpool/opff/products@20230405-1800<span class="w"> </span><span class="p">|</span>ssh<span class="w">  </span><span class="m">10</span>.0.0.2<span class="w"> </span>zfs<span class="w"> </span>recv<span class="w"> </span>zfs-hdd/opff/products
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nb">time</span><span class="w"> </span>zfs<span class="w"> </span>send<span class="w"> </span>rpool/opf/products@20230405-1730<span class="w"> </span><span class="p">|</span>ssh<span class="w">  </span><span class="m">10</span>.0.0.2<span class="w"> </span>zfs<span class="w"> </span>recv<span class="w">  </span>zfs-hdd/opf/products
real<span class="w">    </span>0m11.802s
</code></pre></div></p>
<div class="highlight"><pre><span></span><code><span class="nb">time</span><span class="w"> </span>zfs<span class="w"> </span>send<span class="w"> </span>rpool/obf/products@20230405-1730<span class="w"> </span><span class="p">|</span>ssh<span class="w">  </span><span class="m">10</span>.0.0.2<span class="w"> </span>zfs<span class="w"> </span>recv<span class="w">  </span>zfs-hdd/obf/products
real<span class="w">    </span>2m6.629s
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nb">time</span><span class="w"> </span>zfs<span class="w"> </span>send<span class="w"> </span>rpool/off/products@20230405-1730<span class="w"> </span><span class="p">|</span>ssh<span class="w">  </span><span class="m">10</span>.0.0.2<span class="w"> </span>zfs<span class="w"> </span>recv<span class="w">  </span>zfs-hdd/off/products
real<span class="w">    </span>117m16.799s
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># time zfs send rpool/off-pro/products@20230406-1000 |ssh  10.0.0.2 zfs recv  zfs-hdd/off-pro</span>
/products

real<span class="w">    </span>5m59.378s
</code></pre></div>
<p>Then I put off2 in the sync products scripts. So that sync products script synchronize to both machines.</p>
<p>Note: as we move a flavor to production on off2, we will change the sync as off2 will become the master.</p>
<h3 id="users">Users<a class="headerlink" href="#users" title="Permanent link">#</a></h3>
<p>~~Users are not currently in a zfs on prod but we have them on zfs on ovh3 and there is a sync every day.~~</p>
<p>We will nfs mount the users folder of off1.</p>
<h3 id="products-images">Products images<a class="headerlink" href="#products-images" title="Permanent link">#</a></h3>
<p>We will do a rsync, that we will have to repeat when putting in production.</p>
<p>On off2 (in a screen):</p>
<p><div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/opff/html/images/products<span class="w">  </span>/zfs-hdd/opff/images
</code></pre></div>
this took 12 minutes.</p>
<p>Then I sync to ovh3 (see also below <a href="#sanoid">sanoid usage</a>):</p>
<div class="highlight"><pre><span></span><code><span class="nb">time</span><span class="w"> </span>sudo<span class="w">  </span>syncoid<span class="w"> </span>--no-sync-snap<span class="w"> </span>zfs-hdd/opff/images<span class="w"> </span>root@ovh3.openfoodfacts.org:rpool/opff/images
</code></pre></div>
<p>After first sync (which took 44 min), I also added it to sanoid.conf ovh3, but using synced template.</p>
<p>I also add the main dataset and images to be synced to ovh3 by adding to <code>/etc/sanoid/syncoid-args.conf</code>
<div class="highlight"><pre><span></span><code>--no-sync-snap<span class="w"> </span>zfs-hdd/opff/images<span class="w"> </span>root@ovh3.openfoodfacts.org:rpool/opff/images
</code></pre></div></p>
<h3 id="other-data-and-cache">other data (and cache)<a class="headerlink" href="#other-data-and-cache" title="Permanent link">#</a></h3>
<p>I rsync cache data on ofF2:</p>
<p><div class="highlight"><pre><span></span><code>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/opff/<span class="o">{</span>build-cache,tmp,debug,new_images<span class="o">}</span><span class="w"> </span>/zfs-hdd/opff/cache
</code></pre></div>
<code>build-cache</code> does not exist, not a problem !</p>
<p>I rsync other data on ofF2:
<div class="highlight"><pre><span></span><code>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/opff/<span class="o">{</span>deleted.images,data<span class="o">}</span><span class="w"> </span>/zfs-hdd/opff/
</code></pre></div></p>
<h3 id="snapshots-and-syncs-with-sanoid">Snapshots and Syncs with sanoid<a class="headerlink" href="#snapshots-and-syncs-with-sanoid" title="Permanent link">#</a></h3>
<p>I decided to use <a href="https://github.com/jimsalterjrs/sanoid">sanoid</a> (packaged on debian bullseyes) to handle snapshots and syncs.</p>
<h4 id="installing">Installing<a class="headerlink" href="#installing" title="Permanent link">#</a></h4>
<p>On OVH3 I have <a href="https://github.com/jimsalterjrs/sanoid/blob/master/INSTALL.md#debianubuntu">to install it</a>.
I exactly follow the instructions.</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/jimsalterjrs/sanoid.git
<span class="nb">cd</span><span class="w"> </span>sanoid
<span class="c1"># checkout latest stable release or stay on master for bleeding edge stuff (but expect bugs!)</span>
git<span class="w"> </span>checkout<span class="w"> </span><span class="k">$(</span>git<span class="w"> </span>tag<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;^v&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="k">)</span>
ln<span class="w"> </span>-s<span class="w"> </span>packages/debian<span class="w"> </span>.
apt<span class="w"> </span>install<span class="w"> </span>debhelper<span class="w"> </span>libcapture-tiny-perl<span class="w"> </span>libconfig-inifiles-perl<span class="w"> </span>pv<span class="w"> </span>lzop<span class="w"> </span>mbuffer<span class="w"> </span>build-essential<span class="w"> </span>git
dpkg-buildpackage<span class="w"> </span>-uc<span class="w"> </span>-us
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>../sanoid_*_all.deb
</code></pre></div>
<p>And enabled it:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>sanoid.timer
</code></pre></div></p>
<p>~~On off2, I just apt installed it.~~<sup id="fnref:sanoid_debian"><a class="footnote-ref" href="#fn:sanoid_debian">1</a></sup> </p>
<p>On off2 I install same package as the one on ovh3 (<code>scp ovh3.openfoodfacts.org:/home/alex/sanoid_2.1.0_all.deb</code> and <code>sudo apt install ./sanoid_2.1.0_all.deb</code> and <code>sudo systemctl enable --now sanoid.timer</code>)</p>
<p>On ovh3 I wrote the <code>/etc/sanoid/sanoid.conf</code> file to snapshot users regularly.</p>
<p>On off2 I wrote the <code>etc/sandoid.conf</code></p>
<p>Tested it:
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>/usr/sbin/sanoid<span class="w"> </span>--take-snapshots<span class="w"> </span>--verbose
FATAL<span class="w"> </span>ERROR:<span class="w"> </span>I<span class="w"> </span>don<span class="s1">&#39;t understand the setting template you&#39;</span>ve<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">[</span>zfs-hdd/off/users<span class="o">]</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>/etc/sanoid/sanoid.conf.
</code></pre></div>
Had to modify my conf (I wrote <code>template=</code> instead of <code>use_template=</code>)</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>/usr/sbin/sanoid<span class="w"> </span>--take-snapshots<span class="w"> </span>--verbose
INFO:<span class="w"> </span>cache<span class="w"> </span>expired<span class="w"> </span>-<span class="w"> </span>updating<span class="w"> </span>from<span class="w"> </span>zfs<span class="w"> </span>list.
INFO:<span class="w"> </span>taking<span class="w"> </span>snapshots...
taking<span class="w"> </span>snapshot<span class="w"> </span>zfs-hdd/off/users@autosnap_2023-04-07_16:16:24_monthly
taking<span class="w"> </span>snapshot<span class="w"> </span>zfs-hdd/off/users@autosnap_2023-04-07_16:16:24_daily
taking<span class="w"> </span>snapshot<span class="w"> </span>zfs-hdd/off/users@autosnap_2023-04-07_16:16:24_hourly
INFO:<span class="w"> </span>cache<span class="w"> </span>expired<span class="w"> </span>-<span class="w"> </span>updating<span class="w"> </span>from<span class="w"> </span>zfs<span class="w"> </span>list.
</code></pre></div>
<p>I added off2 root public key (<code>cat /root/.ssh/id_rsa.pub</code>) to ovh3 (<code>/root/.ssh/authorized_keys</code>).</p>
<p>Made first syncoid by hand from off2, as root:
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="nb">time</span><span class="w"> </span>syncoid<span class="w"> </span>root@ovh3.openfoodfacts.org:rpool/off/users<span class="w"> </span>zfs-hdd/off/users
INFO:<span class="w"> </span>Sending<span class="w"> </span>oldest<span class="w"> </span>full<span class="w"> </span>snapshot<span class="w"> </span>rpool/off/users@20211113111816<span class="w"> </span><span class="o">(</span>~<span class="w"> </span><span class="m">154</span>.6<span class="w"> </span>MB<span class="o">)</span><span class="w"> </span>to<span class="w"> </span>new<span class="w"> </span>target<span class="w"> </span>filesystem:
<span class="w"> </span>270MiB<span class="w"> </span><span class="m">0</span>:00:02<span class="w"> </span><span class="o">[</span><span class="w"> </span>103MiB/s<span class="o">]</span><span class="w"> </span><span class="o">[=====================================================]</span><span class="w"> </span><span class="m">174</span>%<span class="w">            </span>
INFO:<span class="w"> </span>Updating<span class="w"> </span>new<span class="w"> </span>target<span class="w"> </span>filesystem<span class="w"> </span>with<span class="w"> </span>incremental<span class="w"> </span>rpool/off/users@20211113111816<span class="w"> </span>...<span class="w"> </span>syncoid_off2_2023-04-07:14:40:28<span class="w"> </span><span class="o">(</span>~<span class="w"> </span><span class="m">420</span>.1<span class="w"> </span>MB<span class="o">)</span>:
<span class="w"> </span>772MiB<span class="w"> </span><span class="m">0</span>:00:18<span class="w"> </span><span class="o">[</span><span class="m">41</span>,2MiB/s<span class="o">]</span><span class="w"> </span><span class="o">[=====================================================]</span><span class="w"> </span><span class="m">183</span>%<span class="w">            </span>

real<span class="w">    </span>0m59,934s

$<span class="w"> </span><span class="nb">time</span><span class="w"> </span>syncoid<span class="w"> </span>root@ovh3.openfoodfacts.org:rpool/off/users<span class="w"> </span>zfs-hdd/off/users
Sending<span class="w"> </span>incremental<span class="w"> </span>rpool/off/users@syncoid_off2_2023-04-07:14:40:28<span class="w"> </span>...<span class="w"> </span>syncoid_off2_2023-04-07:14:42:46<span class="w"> </span><span class="o">(</span>~<span class="w"> </span><span class="m">4</span><span class="w"> </span>KB<span class="o">)</span>:
<span class="m">1</span>,52KiB<span class="w"> </span><span class="m">0</span>:00:00<span class="w"> </span><span class="o">[</span><span class="m">3</span>,27KiB/s<span class="o">]</span><span class="w"> </span><span class="o">[===================</span>&gt;<span class="w">                                  </span><span class="o">]</span><span class="w"> </span><span class="m">38</span>%<span class="w">            </span>

real<span class="w">    </span>0m2,535s
</code></pre></div></p>
<p>I decide to use <code>--no-sync-snap</code> as we already have a snapshot strategy.</p>
<p>Also surprisingly, the <code>root@</code> specification is mandatory.</p>
<p>Now I need to do a systemd service and timer on off2 for syncoid.</p>
<p>Did the systemd service. It's working fine (after some tweaking of the interface)</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span>/etc/sanoid/syncoid-args.conf
--no-sync-snap<span class="w"> </span>root@ovh3.openfoodfacts.org:rpool/off/users<span class="w"> </span>zfs-hdd/off/users
</code></pre></div>
<p>And we notify systemd:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>daemon-reload
</code></pre></div>
<h4 id="setting-up-snapshot-and-syncs">setting up snapshot and syncs<a class="headerlink" href="#setting-up-snapshot-and-syncs" title="Permanent link">#</a></h4>
<p>I added the shares of opff to <code>sanoid.conf</code>
<div class="highlight"><pre><span></span><code>[zfs-hdd/opff]
  use_template=prod_data
  recursive=no

[zfs-hdd/opff/cache]
  use_template=prod_data
  recursive=no

[zfs-hdd/opff/data]
  use_template=prod_data
  recursive=no

[zfs-hdd/opff/images]
  use_template=prod_data
  recursive=no
</code></pre></div></p>
<p>It's easy to start the sync for data, cache and images.</p>
<p>For opff root dataset it's a bit more complicated because I had it created already on off2 and ovh3, so no sync possible ! (at time of doing it I had products and images)</p>
<p>To be able to sync it, here is what I did:</p>
<ul>
<li>on off2, sync opff to a dataset with a temporary name on ovh3:
  <div class="highlight"><pre><span></span><code><span class="w"> </span>sudo<span class="w"> </span>syncoid<span class="w"> </span>--no-sync-snap<span class="w"> </span>zfs-hdd/opff<span class="w">  </span>root@ovh3.openfoodfacts.org:rpool/opff-new
</code></pre></div></li>
<li>
<p>on ovh3:</p>
<ul>
<li>on off2 temporarily disable the syncoid service (because we already setup sync !)
  <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>disable<span class="w"> </span>syncoid
</code></pre></div></li>
<li>choose a time far from the products updates (to avoid having to disable it)</li>
<li>on ovh3<ul>
<li>move products and images dataset to opff-new
  <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>zfs<span class="w"> </span>rename<span class="w"> </span>rpool/opff<span class="o">{</span>,-new<span class="o">}</span>/products
sudo<span class="w"> </span>zfs<span class="w"> </span>rename<span class="w"> </span>rpool/opff<span class="o">{</span>,-new<span class="o">}</span>/images
</code></pre></div></li>
<li>move opff to opff-old
  <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>zfs<span class="w"> </span>rename<span class="w"> </span>rpool/opff<span class="o">{</span>,-old<span class="o">}</span>
</code></pre></div></li>
<li>rename opff-new to opff
  <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>zfs<span class="w"> </span>rename<span class="w"> </span>rpool/opff<span class="o">{</span>-new,<span class="o">}</span>
</code></pre></div></li>
</ul>
</li>
<li>on off2 reactivate syncoid service
  <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>syncoid
</code></pre></div></li>
<li>on ovh3<ul>
<li>verify opff-old is empty
  <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>ls<span class="w"> </span>-a<span class="w"> </span>/rpool/opff-old
sudo<span class="w"> </span>zfs<span class="w"> </span>list<span class="w"> </span>rpool/opff-old
sudo<span class="w"> </span>zfs<span class="w"> </span>list<span class="w"> </span>rpool/opff-old<span class="w"> </span>-t<span class="w"> </span>snapshot
</code></pre></div></li>
<li>and destroy it
  <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>zfs<span class="w"> </span>destroy<span class="w"> </span>rpool/opff-old
</code></pre></div></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Finally I added the opff sync to <code>syncoid-args.conf</code> on ovh3 and the snapshoting as synced on ovh3 in <code>sanoid.conf</code></p>
<p>I also did it for the data and cache dataset:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># from off2 to ovh3</span>
--no-sync-snap<span class="w"> </span>zfs-hdd/opff<span class="w"> </span>root@ovh3.openfoodfacts.org:rpool/opff
--no-sync-snap<span class="w"> </span>zfs-hdd/opff/cache<span class="w"> </span>root@ovh3.openfoodfacts.org:rpool/opff/cache
--no-sync-snap<span class="w"> </span>zfs-hdd/opff/data<span class="w"> </span>root@ovh3.openfoodfacts.org:rpool/opff/data
</code></pre></div>
<blockquote>
<p><strong>NOTE</strong> renaming dataset:
I had to rename data to html_data (I didn't spot there was another data dataset).
<code>zfs rename zfs-hdd/opff/data zfs-hdd/opff/html_data</code> on both ovh3 and off2
Then changed <code>/etc/sanoid/sanoid.conf</code> and <code>/etc/sanoid/syncoid_args.conf</code></p>
</blockquote>
<h2 id="open-pet-food-facts-container-install">Open Pet Food Facts container install<a class="headerlink" href="#open-pet-food-facts-container-install" title="Permanent link">#</a></h2>
<h3 id="creating-container">Creating Container<a class="headerlink" href="#creating-container" title="Permanent link">#</a></h3>
<p>I created a CT followings <a href="../../proxmox/#how-to-create-a-new-container">How to create a new Container</a> it went all smooth.
I choosed a 30Gb disk, 0B swap, 4 Cores and 6 Gb memory.</p>
<p>I also <a href="../mail#postfix-configuration">configure postfix</a> and tested it.</p>
<h3 id="installing-packages">Installing packages<a class="headerlink" href="#installing-packages" title="Permanent link">#</a></h3>
<p>Then I installed needed package following docker container:</p>
<div class="highlight"><pre><span></span><code>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>apache2<span class="w"> </span>apt-utils<span class="w"> </span>cpanminus<span class="w"> </span>g++<span class="w"> </span>gcc<span class="w"> </span>less<span class="w"> </span>libapache2-mod-perl2<span class="w"> </span>make<span class="w"> </span>gettext<span class="w"> </span>wget<span class="w"> </span>imagemagick<span class="w"> </span>graphviz<span class="w"> </span>tesseract-ocr<span class="w"> </span>libtie-ixhash-perl<span class="w"> </span>libwww-perl<span class="w"> </span>libimage-magick-perl<span class="w"> </span>libxml-encoding-perl<span class="w"> </span>libtext-unaccent-perl<span class="w"> </span>libmime-lite-perl<span class="w"> </span>libcache-memcached-fast-perl<span class="w"> </span>libjson-pp-perl<span class="w"> </span>libclone-perl<span class="w"> </span>libcrypt-passwdmd5-perl<span class="w"> </span>libencode-detect-perl<span class="w"> </span>libgraphics-color-perl<span class="w"> </span>libbarcode-zbar-perl<span class="w"> </span>libxml-feedpp-perl<span class="w"> </span>liburi-find-perl<span class="w"> </span>libxml-simple-perl<span class="w"> </span>libexperimental-perl<span class="w"> </span>libapache2-request-perl<span class="w"> </span>libdigest-md5-perl<span class="w"> </span>libtime-local-perl<span class="w"> </span>libdbd-pg-perl<span class="w"> </span>libtemplate-perl<span class="w"> </span>liburi-escape-xs-perl<span class="w"> </span>libmath-random-secure-perl<span class="w"> </span>libfile-copy-recursive-perl<span class="w"> </span>libemail-stuffer-perl<span class="w"> </span>liblist-moreutils-perl<span class="w"> </span>libexcel-writer-xlsx-perl<span class="w"> </span>libpod-simple-perl<span class="w"> </span>liblog-any-perl<span class="w"> </span>liblog-log4perl-perl<span class="w"> </span>liblog-any-adapter-log4perl-perl<span class="w"> </span>libgeoip2-perl<span class="w"> </span>libemail-valid-perl<span class="w"> </span>libmath-fibonacci-perl<span class="w"> </span>libev-perl<span class="w"> </span>libprobe-perl-perl<span class="w"> </span>libmath-round-perl<span class="w"> </span>libsoftware-license-perl<span class="w"> </span>libtest-differences-perl<span class="w"> </span>libtest-exception-perl<span class="w"> </span>libmodule-build-pluggable-perl<span class="w"> </span>libclass-accessor-lite-perl<span class="w"> </span>libclass-singleton-perl<span class="w"> </span>libfile-sharedir-install-perl<span class="w"> </span>libnet-idn-encode-perl<span class="w"> </span>libtest-nowarnings-perl<span class="w"> </span>libfile-chmod-perl<span class="w"> </span>libdata-dumper-concise-perl<span class="w"> </span>libdata-printer-perl<span class="w"> </span>libdata-validate-ip-perl<span class="w"> </span>libio-compress-perl<span class="w"> </span>libjson-maybexs-perl<span class="w"> </span>liblist-allutils-perl<span class="w"> </span>liblist-someutils-perl<span class="w"> </span>libdata-section-simple-perl<span class="w"> </span>libfile-which-perl<span class="w"> </span>libipc-run3-perl<span class="w"> </span>liblog-handler-perl<span class="w"> </span>libtest-deep-perl<span class="w"> </span>libwant-perl<span class="w"> </span>libfile-find-rule-perl<span class="w"> </span>liblinux-usermod-perl<span class="w"> </span>liblocale-maketext-lexicon-perl<span class="w"> </span>liblog-any-adapter-tap-perl<span class="w"> </span>libcrypt-random-source-perl<span class="w"> </span>libmath-random-isaac-perl<span class="w"> </span>libtest-sharedfork-perl<span class="w"> </span>libtest-warn-perl<span class="w"> </span>libsql-abstract-perl<span class="w"> </span>libauthen-sasl-saslprep-perl<span class="w"> </span>libauthen-scram-perl<span class="w"> </span>libbson-perl<span class="w"> </span>libclass-xsaccessor-perl<span class="w"> </span>libconfig-autoconf-perl<span class="w"> </span>libdigest-hmac-perl<span class="w"> </span>libpath-tiny-perl<span class="w"> </span>libsafe-isa-perl<span class="w"> </span>libspreadsheet-parseexcel-perl<span class="w"> </span>libtest-number-delta-perl<span class="w"> </span>libdevel-size-perl<span class="w"> </span>gnumeric<span class="w"> </span>libreadline-dev<span class="w"> </span>libperl-dev
</code></pre></div>
<p>Also installed mailx which is handy:</p>
<div class="highlight"><pre><span></span><code>apt<span class="w"> </span>install<span class="w"> </span>bsd-mailx
</code></pre></div>
<p>We also want nginx in this container:
<div class="highlight"><pre><span></span><code>apt<span class="w"> </span>install<span class="w"> </span>nginx
</code></pre></div></p>
<h3 id="geoip-updates">GeoIP updates<a class="headerlink" href="#geoip-updates" title="Permanent link">#</a></h3>
<p>install <code>geoipupdate</code> package:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>geoipupdate
</code></pre></div>
<p>It will be triggered by a systemd timer, but we want to test if it runs correctly:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>geoipupdate.service
sudo<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>geoipupdate.service
...
Process:<span class="w"> </span><span class="m">7819</span><span class="w"> </span><span class="nv">ExecCondition</span><span class="o">=</span>grep<span class="w"> </span>-q<span class="w"> </span>^AccountID<span class="w"> </span>.*<span class="o">[</span>^0<span class="o">]</span><span class="se">\+</span><span class="w"> </span>/etc/GeoIP.conf<span class="w"> </span><span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited,<span class="w"> </span>stat&gt;
<span class="w">        </span>CPU:<span class="w"> </span>2ms
...
mai<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">09</span>:12:23<span class="w"> </span>opff<span class="w"> </span>systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>geoipupdate.service:<span class="w"> </span>Skipped<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span><span class="s1">&#39;exec-condition&#39;</span>.
mai<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">09</span>:12:23<span class="w"> </span>opff<span class="w"> </span>systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>Condition<span class="w"> </span>check<span class="w"> </span>resulted<span class="w"> </span><span class="k">in</span><span class="w"> </span>Weekly<span class="w"> </span>GeoIP<span class="w"> </span>update<span class="w"> </span>being<span class="w"> </span>skipped.
</code></pre></div>
it does not work because we did not have an account and license key.</p>
<p>I had to <a href="https://www.maxmind.com/en/geolite2/signup?utm_source=kb&amp;utm_medium=kb-link&amp;utm_campaign=kb-create-account">create an account</a> to GeoipLite2 database at maxmind.com with tech at off.org (and saved the password in our keepassx).
After login, I then created a license key (at url indicated on https://dev.maxmind.com/geoip/updating-databases) and downloaded the provided GeoIP.conf, and installed it at <code>/etc/GeoIP.conf</code>
and did a <code>sudo chmod o-rwx /etc/GeoIP.conf</code></p>
<p>Test it again:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>geoipupdate.service
sudo<span class="w"> </span>systemctl<span class="w"> </span>status<span class="w"> </span>geoipupdate.service
...
mai<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">09</span>:45:27<span class="w"> </span>opff<span class="w"> </span>systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>Starting<span class="w"> </span>Weekly<span class="w"> </span>GeoIP<span class="w"> </span>update...
mai<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">09</span>:45:34<span class="w"> </span>opff<span class="w"> </span>systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>geoipupdate.service:<span class="w"> </span>Succeeded.
mai<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">09</span>:45:34<span class="w"> </span>opff<span class="w"> </span>systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>Finished<span class="w"> </span>Weekly<span class="w"> </span>GeoIP<span class="w"> </span>update.
</code></pre></div>
this works.</p>
<p><strong>NOTE:</strong> I don't put this configuration in git because it has the token. The token is saved in the shared keepass file.</p>
<h2 id="mounting-volumes">Mounting volumes<a class="headerlink" href="#mounting-volumes" title="Permanent link">#</a></h2>
<p>We will use bind mounts to make zfs datasets available inside the machine.</p>
<p>See: https://pve.proxmox.com/wiki/Linux_Container#_bind_mount_points</p>
<p>and https://pve.proxmox.com/wiki/Unprivileged_LXC_containers</p>
<p>We edit /etc/subuid and /etc/subgid to add <code>root:1000:10</code>. This allow container started by root to map ids 1000 to their same ids on system.</p>
<p>We edit 110 conf to add sub_id exceptions:</p>
<div class="highlight"><pre><span></span><code># uid map: from uid 0 map 999 uids (in the ct) to the range starting 100000 (on the host)
# so 0..999 (ct)  100000..100999 (host)
lxc.idmap = u 0 100000 999
lxc.idmap = g 0 100000 999
# we map 10 uid starting from uid 1000 onto 1000, so 1000..1010  1000..1010
lxc.idmap = u 1000 1000 10
lxc.idmap = g 1000 1000 10
# we map the rest of 65535 from 1010 upto 101010, so 1010..65535  101010..165535
lxc.idmap = u 1011 101011 64525
lxc.idmap = g 1011 101011 64525
</code></pre></div>
<p><div class="highlight"><pre><span></span><code># volumes
mp0: /zfs-hdd/opff,mp=/mnt/opff
mp1: /zfs-hdd/opff/products/,mp=/mnt/opff/products
mp2: /zfs-hdd/off/users/,mp=/mnt/opff/users
mp3: /zfs-hdd/opff/images,mp=/mnt/opff/images
mp4: /zfs-hdd/opff/html_data,mp=/mnt/opff/html_data
mp5: /zfs-hdd/opff/cache,mp=/mnt/opff/cache
</code></pre></div>
<strong>Important</strong>: the order is important for the first one, otherwise <code>/mnt/opff/products</code> will be invisibilized by the mount of <code>/mnt/opff</code>.</p>
<p>We restart <code>pct reboot 110</code></p>
<p>But we have a problem: we loose access to our home directory because of uids changes.
We fix this from the host:</p>
<div class="highlight"><pre><span></span><code>root@off2:# chown 1001:1001 -R /zfs-hdd/pve/subvol-110-disk-0/home/alex
root@off2:# chown 1000:1000 -R /zfs-hdd/pve/subvol-110-disk-0/home/off
</code></pre></div>
<h2 id="installing-opff-code">Installing OPFF code<a class="headerlink" href="#installing-opff-code" title="Permanent link">#</a></h2>
<p><strong>NOTE:</strong> I didn't choose to use git from the start. But for next install, I will instead use git to find the code and compare to existing (<a href="#using-git">see below</a>), instead of doing it this way</p>
<h3 id="getting-the-code">Getting the code<a class="headerlink" href="#getting-the-code" title="Permanent link">#</a></h3>
<p>I then rsync the content of <code>/srv/opff</code> from off1 to the machine, (with -x to avoid sending crossing filesystems and excluding logs and html/images/products/).</p>
<p>I copied the <code>/root/.ssh/id_rsa.pub</code>  off off2 in the <code>/root/.ssh/authorized_keys</code> of off1</p>
<p>On off2:</p>
<div class="highlight"><pre><span></span><code>sudo mkdir /zfs-hdd/pve/subvol-110-disk-0/srv/opff/
sudo rsync -x -a --info=progress2 --exclude &quot;logs/&quot; --exclude &quot;html/images/products/&quot; off1.openfoodfacts.org:/srv/opff/ /zfs-hdd/pve/subvol-110-disk-0/srv/opff/
</code></pre></div>
<p>Strangely /srv/opff/lang was not world readable, I changed this on off1: <code>chmod a+rX -R lang/</code> and did rsync again.</p>
<p>In the container:</p>
<ul>
<li>I created user off: <code>adduser off</code> with a complex password that I immediately forgot (on purpose).</li>
<li>I give ownership to off user and group to <code>/srv/opff</code>: <code>chown off:off -R /srv/opff</code> --&gt; it fails.
  In fact I don't have the permissions, it's because we are in a LXC container.</li>
</ul>
<ul>
<li>On the host, we have to setup ownership correctly on <code>/zfs-hdd/pve/subvol-110-disk-0/srv/opff/</code>
  but we have to apply user id translation (see UID Mapping in <a href="https://linuxcontainers.org/lxc/manpages/man5/lxc.container.conf.5.html">man lxc.containers.conf</a>)</li>
<li>To get correct Id:<ul>
<li>in the container, I created a simple file  <code>/srv/off.txt</code> and gave ownership to <code>off</code></li>
<li>on the host I <code>ls -ln /zfs-hdd/pve/subvol-110-disk-0/srv/off.txt</code> and get the id: 101000:101000.</li>
</ul>
</li>
<li>Then on the host: <code>sudo chown 101000:101000 -R /zfs-hdd/pve/subvol-110-disk-0/srv/opff/</code></li>
<li>In the container, I then created logs and html/images/products/:
  <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>mkdir<span class="w"> </span>logs
sudo<span class="w"> </span>mkdir<span class="w"> </span>html/images/products/
sudo<span class="w"> </span>chown<span class="w"> </span>off:off<span class="w"> </span>html/images/products/<span class="w"> </span>logs
</code></pre></div></li>
</ul>
<h3 id="linking-data">linking data<a class="headerlink" href="#linking-data" title="Permanent link">#</a></h3>
<p>Unless stated operation are done with user off.</p>
<p>Create a backup folder to be sure
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>mkdir<span class="w"> </span>/srv/backup/
sudo<span class="w"> </span>chown<span class="w"> </span>off:off<span class="w"> </span>/srv/backup/
</code></pre></div></p>
<p>Remove old links:
<div class="highlight"><pre><span></span><code>unlink<span class="w"> </span>/srv/opff/products
unlink<span class="w"> </span>/srv/opff/users
mv<span class="w"> </span>/srv/opff/users_emails.sto<span class="w"> </span>/srv/backup
</code></pre></div></p>
<p>Create links for users and products
<div class="highlight"><pre><span></span><code>ln<span class="w"> </span>-s<span class="w"> </span>/mnt/opff/products<span class="w"> </span>/srv/opff/products
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/opff/users<span class="w"> </span>/srv/opff/users
<span class="c1"># old versions of Product opener needs users_emails.sto in /srv/xxx</span>
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/opff/users/users_emails.sto<span class="w"> </span>/srv/opff/users_emails.sto
</code></pre></div></p>
<p>Create links for data folders, also moving data zfs parts:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># html data</span>
sudo<span class="w"> </span>rsync<span class="w"> </span>-a<span class="w"> </span>/srv/opff/html/data/<span class="w"> </span>/mnt/opff/html_data/
sudo<span class="w"> </span>mv<span class="w"> </span>/srv/opff/html/data/<span class="w"> </span>/srv/backup/
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/opff/html_data/<span class="w"> </span>/srv/opff/html/data
<span class="c1"># product images</span>
sudo<span class="w"> </span>rmdir<span class="w"> </span>/srv/opff/html/images/products/
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/opff/images/products<span class="w">  </span>/srv/opff/html/images/products
</code></pre></div>
<p>We also want to move Lang file and deleted.images in data folder but keep compatibility (it's an old version)</p>
<div class="highlight"><pre><span></span><code><span class="c1"># deleted.images</span>
mv<span class="w"> </span>/srv/opff/deleted.images<span class="w"> </span>/mnt/opff/
ln<span class="w"> </span>-s<span class="w">  </span>/<span class="o">{</span>mnt,srv<span class="o">}</span>/opff/deleted.images
mv<span class="w"> </span>/srv/opff/Lang.openpetfoodfacts.org.sto<span class="w"> </span>/mnt/opff/data/
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/opff/data/Lang.openpetfoodfacts.org.sto<span class="w"> </span>/srv/opff/
</code></pre></div>
<p>Same for cache folders
<div class="highlight"><pre><span></span><code><span class="c1"># build-cache (was non existent)</span>
mkdir<span class="w"> </span>/mnt/opff/cache/build-cache
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/opff/cache/build-cache<span class="w"> </span>/srv/opff/build-cache
mv<span class="w"> </span>/srv/<span class="o">{</span>opff,backup<span class="o">}</span>/tmp/
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/opff/cache/tmp<span class="w"> </span>/srv/opff/tmp
mv<span class="w"> </span>/srv/<span class="o">{</span>opff,backup<span class="o">}</span>/debug<span class="w"> </span>
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/opff/cache/debug<span class="w"> </span>/srv/opff/debug
mv<span class="w"> </span>/srv/<span class="o">{</span>opff,backup<span class="o">}</span>/new_images
ln<span class="w"> </span>-s<span class="w"> </span>/mnt/opff/cache/new_images<span class="w"> </span>/srv/opff/new_images
</code></pre></div></p>
<h3 id="linking-logs">linking logs<a class="headerlink" href="#linking-logs" title="Permanent link">#</a></h3>
<p>We want logs to go in /var/logs.</p>
<p>We will create a directory for opff and also add links to nginx and apache2 logs.</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>mkdir<span class="w"> </span>/var/log/opff
sudo<span class="w"> </span>chown<span class="w"> </span>off:off<span class="w"> </span>-R<span class="w"> </span>/var/log/opff
sudo<span class="w"> </span>-u<span class="w"> </span>off<span class="w"> </span>rmdir<span class="w"> </span>/srv/opff/logs/
sudo<span class="w"> </span>-u<span class="w"> </span>off<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/var/log/opff<span class="w"> </span>/srv/opff/logs
sudo<span class="w">  </span>-u<span class="w"> </span>off<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>../apache2<span class="w"> </span>/var/log/opff
sudo<span class="w"> </span>-u<span class="w"> </span>off<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>../nginx<span class="w"> </span>/var/log/opff
</code></pre></div>
<h3 id="linking-translations">linking translations<a class="headerlink" href="#linking-translations" title="Permanent link">#</a></h3>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>-u<span class="w"> </span>off<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/opff/po/openpetfoodfacts<span class="w"> </span>/srv/opff/po/site-specific
</code></pre></div>
<h3 id="verify-config-links">verify config links<a class="headerlink" href="#verify-config-links" title="Permanent link">#</a></h3>
<p>They where normaly kept in the transfer, but for the record:
<div class="highlight"><pre><span></span><code>ls<span class="w"> </span>-l<span class="w"> </span>/srv/opff/lib/ProductOpener/<span class="o">{</span>SiteLang,Config<span class="o">}</span>.pm
lrwxrwxrwx<span class="w"> </span><span class="m">1</span><span class="w"> </span>off<span class="w"> </span>off<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">30</span><span class="w"> </span>mars<span class="w">    </span><span class="m">2017</span><span class="w"> </span>/srv/opff/lib/ProductOpener/Config.pm<span class="w"> </span>-&gt;<span class="w"> </span>Config_opff.pm
lrwxrwxrwx<span class="w"> </span><span class="m">1</span><span class="w"> </span>off<span class="w"> </span>off<span class="w"> </span><span class="m">16</span><span class="w">  </span><span class="m">2</span><span class="w"> </span>janv.<span class="w">   </span><span class="m">2018</span><span class="w"> </span>/srv/opff/lib/ProductOpener/SiteLang.pm<span class="w"> </span>-&gt;<span class="w"> </span>SiteLang_opff.pm
</code></pre></div>
and <code>/srv/opff/lib/ProductOpener/Config2.pm</code> is specific.</p>
<h3 id="some-broken-strange-links">some broken / strange links<a class="headerlink" href="#some-broken-strange-links" title="Permanent link">#</a></h3>
<p>Finding broken links:
<code>find /srv/opff -xtype l | xargs ls -l</code></p>
<p>We have a lot in new_images and in html images folders, we can just remove them all
<code>find /srv/opff/new_images/ /srv/opff/html/images/bak/misc/ /srv/opff/html/images/misc.nok/ -xtype l |xargs -L 1 unlink</code></p>
<p>We also have some html contents linked to off <strong>FIXME decide what to do</strong></p>
<ul>
<li>/srv/opff/products -&gt; /rpool/opff/products</li>
<li>/srv/opff/ingredients/additifs/authorized_additives.txt -&gt; /home/off-fr/cgi/authorized_additives.pl</li>
</ul>
<h3 id="using-git">Using git<a class="headerlink" href="#using-git" title="Permanent link">#</a></h3>
<p>After using a copy of code, I decided to use git and have an opff-main branch to track change.
This is because I wanted to also track the container services configuration files there.</p>
<p>Here is what I did (but next time, it is better to just start from the git code).</p>
<h3 id="finding-opff-version">Finding OPFF version<a class="headerlink" href="#finding-opff-version" title="Permanent link">#</a></h3>
<p>on off1 in /srv/opff:
<div class="highlight"><pre><span></span><code>find<span class="w"> </span>.<span class="w"> </span>-xdev<span class="w">  </span>-iregex<span class="w"> </span><span class="s2">&quot;.*\.\(pl\|pm\|txt\)&quot;</span><span class="p">|</span>xargs<span class="w"> </span>ls<span class="w"> </span>-l<span class="w"> </span>--time-style<span class="o">=</span>+<span class="s1">&#39;%Y-%m-%d&#39;</span><span class="p">|</span>tr<span class="w"> </span>-s<span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">|</span>cut<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span>-f<span class="w"> </span><span class="m">6</span>-<span class="p">|</span>sort
</code></pre></div></p>
<p>Interesting data retained <code>2020-05-30</code>.</p>
<p>To get modified files along with versions <code>git log --name-only</code></p>
<p>I then compared code with various commits. Finally I put the tag <a href="https://github.com/openfoodfacts/openfoodfacts-server/releases/tag/OPFF-v1">OPFF-v1</a> on commit <a href="https://github.com/openfoodfacts/openfoodfacts-server/commit/34a1c355049b2c1017a65b9ab6419c79fe083f3c">34a1c35</a></p>
<p>It's approximate because we apparently got less up to date taxonomies.</p>
<h3 id="modifying-git-code-to-match-opff-code">modifying git code to match opff code<a class="headerlink" href="#modifying-git-code-to-match-opff-code" title="Permanent link">#</a></h3>
<p>Created /srv/opff-git to clone and compare:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>mkdir<span class="w"> </span>/srv/opff-git
sudo<span class="w"> </span>chown<span class="w"> </span>off:off<span class="w"> </span>/srv/opff-git
</code></pre></div></p>
<p>Create a key for off (as off user), without a passphrase:
<div class="highlight"><pre><span></span><code>ssh-keygen<span class="w"> </span>-t<span class="w"> </span>ed25519<span class="w"> </span>-C<span class="w"> </span><span class="s2">&quot;off@opff.openfoodfacts.org&quot;</span>
cat<span class="w"> </span>/home/off/.ssh/id_ed25519.pub
</code></pre></div></p>
<p>In github add the <code>/home/off/.ssh/id_ed25519.pub</code> to deploy keys for openfoodfacts-server and  (<a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/managing-deploy-keys#deploy-keys">github docs</a>): going to settings / deploy keys / add deploy key. I did not gave write access.</p>
<p>With user off, clone git:
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>/srv/opff-git/
git<span class="w"> </span>clone<span class="w"> </span>-b<span class="w"> </span>OPFF-v1<span class="w"> </span>--single-branch<span class="w"> </span>--depth<span class="o">=</span><span class="m">10</span><span class="w"> </span>git@github.com:openfoodfacts/openfoodfacts-server.git<span class="w"> </span>.
</code></pre></div>
Compared both:
<div class="highlight"><pre><span></span><code>diff<span class="w"> </span>--no-dereference<span class="w"> </span>/srv/opff-git/<span class="w"> </span>/srv/opff<span class="w"> </span>&gt;<span class="w"> </span>/tmp/opff.diff
</code></pre></div>
Important differences spotted:</p>
<ul>
<li>cpanfile -- many differences ! But in fact on off1 it was not really use, so we will take the one in git</li>
<li>bower.json is no more in git, not a problem</li>
<li>log.conf
  <div class="highlight"><pre><span></span><code><span class="gh">diff --no-dereference --ignore-space-change --strip-trailing-cr /srv/opff-git/log.conf /srv/opff/log.conf</span>
<span class="gu">3,4d2</span>
<span class="gd">&lt; log4perl.PatternLayout.cspec.S = sub { my $context = Log::Log4perl::MDC-&gt;get_context; use Data::Dumper (); local $Data::Dumper::Indent    = 0; local $Data::Dumper::Terse     = 1; local $Data::Dumper::Sortkeys  = 1; local $Data::Dumper::Quotekeys = 0; local $Data::Dumper::Deparse   = 1; my $str = Data::Dumper::Dumper($context); $str =~ s/[\n\r]/ /g; return $str; }</span>
<span class="gd">&lt; </span>
<span class="gu">6c4</span>
<span class="gd">&lt; log4perl.appender.LOGFILE.filename=./logs/log4perl.log</span>
<span class="gs">---</span>
<span class="gi">&gt; log4perl.appender.LOGFILE.filename=/srv/opff/logs/log4perl.log</span>
10c8
<span class="gd">&lt; log4perl.appender.LOGFILE.layout.ConversionPattern=[%r] %F %L %c %S %m{chomp}%n</span>
<span class="gs">---</span>
<span class="gi">&gt; log4perl.appender.LOGFILE.layout.ConversionPattern=[%r] %F %L %c - %m%n</span>
</code></pre></div></li>
</ul>
<p>Added files that are symlinks:</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>/srv/opff/lib/ProductOpener
ln<span class="w"> </span>-s<span class="w"> </span>Config_opff.pm<span class="w"> </span>Config.pm
ln<span class="w"> </span>-s<span class="w"> </span>SiteLang_opff.pm<span class="w">  </span>SiteLang.pm
ln<span class="w"> </span>-s<span class="w"> </span>SiteQuality_off.pm<span class="w"> </span>SiteQuality.pm
<span class="nb">cd</span><span class="w"> </span>/srv/off
<span class="c1"># ln -s ../node_modules/@bower_components /srv/opff/html/bower_components</span>
</code></pre></div>
<p>After that, to be able to fetch opff-main remote branche:
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>remote<span class="w"> </span>set-branches<span class="w"> </span>--add<span class="w"> </span>origin<span class="w"> </span><span class="s1">&#39;opff-main&#39;</span>
$<span class="w"> </span>git<span class="w"> </span>remote<span class="w"> </span>set-branches<span class="w"> </span>--add<span class="w"> </span>origin<span class="w"> </span><span class="s1">&#39;opff-reinstall&#39;</span>
$<span class="w"> </span>git<span class="w"> </span>fetch<span class="w"> </span>-v<span class="w"> </span>--depth<span class="o">=</span><span class="m">1</span>
</code></pre></div></p>
<p>I also had to add some files from <code>po/</code> that where missing from the repository</p>
<h3 id="swapping-code-for-the-one-of-the-git-repo">Swapping code for the one of the git repo<a class="headerlink" href="#swapping-code-for-the-one-of-the-git-repo" title="Permanent link">#</a></h3>
<p><div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>mv<span class="w"> </span>/srv/opff<span class="o">{</span>,-old<span class="o">}</span>
sudo<span class="w"> </span>mv<span class="w"> </span>/srv/opff<span class="o">{</span>-git,<span class="o">}</span>
</code></pre></div>
Update needed file:</p>
<ol>
<li>apache and nginx conf is wrong, copy it in git version:</li>
</ol>
<div class="highlight"><pre><span></span><code>cp<span class="w"> </span>/etc/apache2/sites-available/opff.conf<span class="w"> </span>conf/apache-2.4/sites-available/opff.conf
cp<span class="w"> </span>/srv/opff-old/conf/nginx/sites-available/opff<span class="w"> </span>conf/nginx/sites-available/opff
</code></pre></div>
<p>I add to replace <code>log.conf</code>:
<div class="highlight"><pre><span></span><code>ln<span class="w"> </span>-s<span class="w"> </span>conf/opff-log.conf<span class="w"> </span>/srv/opff/log.conf
</code></pre></div></p>
<p>I add to redo all links done above in the new folder</p>
<p>Note: to share the repo to off group, see https://stackoverflow.com/a/7268608/2886726</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>adduser<span class="w"> </span>alex<span class="w"> </span>off
sudo<span class="w"> </span>-u<span class="w"> </span>off<span class="w"> </span>git<span class="w"> </span>config<span class="w"> </span>core.sharedRepository<span class="w"> </span><span class="nb">true</span>
sudo<span class="w"> </span>chmod<span class="w"> </span>g+rwX<span class="w"> </span>-R<span class="w"> </span>.
</code></pre></div>
<h3 id="adding-dists">Adding dists<a class="headerlink" href="#adding-dists" title="Permanent link">#</a></h3>
<p>Create a folder for dist:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>mkdir<span class="w"> </span>/srv/opff-dist
sudo<span class="w"> </span>chown<span class="w"> </span>off:off<span class="w"> </span>/srv/opff-dist<span class="w"> </span>
</code></pre></div></p>
<p>As off, transfer dists in it:
<div class="highlight"><pre><span></span><code>cp<span class="w"> </span>-r<span class="w">  </span>/srv/opff-old/html/images/icons/dist/<span class="w"> </span>/srv/opff-dist/icons
cp<span class="w"> </span>-r<span class="w"> </span>/srv/opff-old/html/css/dist<span class="w">  </span>/srv/opff-dist/css
cp<span class="w"> </span>-r<span class="w"> </span>/srv/opff-old/html/js/dist<span class="w">  </span>/srv/opff-dist/js
<span class="c1"># only for off ?</span>
cp<span class="w"> </span>-r<span class="w"> </span>/srv/opff-old/html/images/attributes<span class="w">  </span>/srv/opff-dist/attributes
</code></pre></div></p>
<p>And use symbolic links in folders:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># first link for whole folder</span>
ln<span class="w"> </span>-s<span class="w"> </span>/srv/opff-dist<span class="w"> </span>/srv/opff/dist
<span class="c1"># relative links for the rest</span>
ln<span class="w"> </span>-s<span class="w"> </span>../../../dist/icons<span class="w"> </span>/srv/opff/html/images/icons/dist
ln<span class="w"> </span>-s<span class="w"> </span>../../dist/css<span class="w"> </span>/srv/opff/html/css/dist
ln<span class="w"> </span>-s<span class="w"> </span>../../dist/js<span class="w"> </span>/srv/opff/html/js/dist
</code></pre></div>
<h3 id="adding-openfoodfacts-web">Adding openfoodfacts-web<a class="headerlink" href="#adding-openfoodfacts-web" title="Permanent link">#</a></h3>
<p>We have some content that we want to take from openfoodfacts-web (also because shared with off). So we want to clone it.</p>
<h4 id="cloning-repo">Cloning repo<a class="headerlink" href="#cloning-repo" title="Permanent link">#</a></h4>
<p>Note that I add to make two deploys keys as explained in <a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/managing-deploy-keys#using-multiple-repositories-on-one-server">github documentation</a> and use a specific ssh_config hostname for openfoodfacts-web:</p>
<p>Create new key:
<div class="highlight"><pre><span></span><code><span class="c1"># deploy key for openfoodfacts-web</span>
ssh-keygen<span class="w"> </span>-t<span class="w"> </span>ed25519<span class="w"> </span>-C<span class="w"> </span><span class="s2">&quot;off@opff.off2.openfoodfacts.org&quot;</span>
</code></pre></div></p>
<p>Add a specific host in ssh config
<div class="highlight"><pre><span></span><code># /home/off/.ssh/config
Host github.com-off-web
    Hostname github.com
    IdentityFile=/home/off/.ssh/id_ed25519_off-web
</code></pre></div></p>
<p>In github add the <code>/home/off/.ssh/id_ed25519_off-web.pub</code> to deploy keys for openfoodfacts-web.</p>
<p>Cloning:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>mkdir<span class="w"> </span>/srv/openfoodfacts-web
sudo<span class="w"> </span>chown<span class="w"> </span>off:off<span class="w"> </span>/srv/openfoodfacts-web
sudo<span class="w"> </span>-u<span class="w"> </span>off<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>git@github.com-off-web:openfoodfacts/openfoodfacts-web.git
</code></pre></div></p>
<h4 id="linking-content">Linking content<a class="headerlink" href="#linking-content" title="Permanent link">#</a></h4>
<p>We clearly want opff folder to come from off-web:</p>
<div class="highlight"><pre><span></span><code>rm<span class="w"> </span>-rf<span class="w"> </span>/srv/opff/lang/opff/
ln<span class="w"> </span>-s<span class="w"> </span>/srv/openfoodfacts-web/lang/opff/<span class="w"> </span>/srv/opff/lang/opff
</code></pre></div>
<p>We then will link press, contacts, term of use
<div class="highlight"><pre><span></span><code><span class="c1"># USE WITH CARE !</span>
<span class="nb">cd</span><span class="w"> </span>/srv/opff/lang
<span class="k">for</span><span class="w"> </span>FNAME<span class="w"> </span><span class="k">in</span><span class="w"> </span>contacts.html<span class="w"> </span>press.html<span class="w"> </span>terms-of-use.html<span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span>LANG<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>ls<span class="w"> </span>-d<span class="w"> </span>??<span class="w"> </span>??_*<span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="nv">FILE_PATH</span><span class="o">=</span><span class="nv">$LANG</span>/texts/<span class="nv">$FNAME</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-e<span class="w"> </span>/srv/openfoodfacts-web/lang/<span class="nv">$FILE_PATH</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>rm<span class="w"> </span><span class="nv">$FILE_PATH</span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/openfoodfacts-web/lang/<span class="nv">$FILE_PATH</span><span class="w"> </span><span class="nv">$FILE_PATH</span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="k">fi</span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="k">done</span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="k">done</span><span class="p">;</span>
</code></pre></div></p>
<p>We can verify with:
<div class="highlight"><pre><span></span><code>ls<span class="w"> </span>-l<span class="w"> </span>*/texts/<span class="o">{</span>contacts,press,terms-of-use<span class="o">}</span>.html
</code></pre></div></p>
<p>We keep the rest as is for now.</p>
<p>Opff specific content
<div class="highlight"><pre><span></span><code><span class="c1"># USE WITH CARE !</span>
<span class="nb">cd</span><span class="w"> </span>/srv/opff/lang
<span class="k">for</span><span class="w"> </span>FNAME<span class="w"> </span><span class="k">in</span><span class="w"> </span>index.html<span class="w"> </span>data.html<span class="w"> </span>open-pet-food-facts-mobile-app.html<span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span>LANG<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>ls<span class="w"> </span>-d<span class="w"> </span>??<span class="w"> </span>??_*<span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="nv">FILE_PATH</span><span class="o">=</span><span class="nv">$LANG</span>/texts/<span class="nv">$FNAME</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-e<span class="w"> </span>/srv/openfoodfacts-web/lang/opff/<span class="nv">$FILE_PATH</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>unlink<span class="w"> </span><span class="nv">$FILE_PATH</span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/openfoodfacts-web/lang/opff/<span class="nv">$FILE_PATH</span><span class="w"> </span><span class="nv">$FILE_PATH</span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="k">fi</span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="k">done</span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="k">done</span><span class="p">;</span>
</code></pre></div></p>
<p>A specific one:
<div class="highlight"><pre><span></span><code>ln<span class="w"> </span>-s<span class="w"> </span>application-mobile-open-food-facts.html<span class="w"> </span>fr/texts/application-mobile-open-pet-food-facts.html
</code></pre></div></p>
<p><strong>FIXME</strong>: add a ticket to understand if we want to use off-web for all the content</p>
<h3 id="linking-images">Linking images<a class="headerlink" href="#linking-images" title="Permanent link">#</a></h3>
<p>App use openfoodfacts logo name and we link files to openpetfoodfacts logo !
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>/srv/opff/html/images/misc/
<span class="c1"># also for &quot;en&quot; because of . vs -</span>
<span class="k">for</span><span class="w"> </span>LANG<span class="w"> </span><span class="k">in</span><span class="w"> </span>ar<span class="w"> </span>ca<span class="w"> </span>de<span class="w"> </span>en<span class="w"> </span>es<span class="w"> </span>fa<span class="w"> </span>fr<span class="w"> </span>he<span class="w"> </span>it<span class="w"> </span>nl<span class="w"> </span>no<span class="w"> </span>pl<span class="w"> </span>pt<span class="w"> </span>ru<span class="w"> </span>sq<span class="w"> </span>uk<span class="w"> </span>vi<span class="w"> </span>zh<span class="w"> </span>zh-tw<span class="p">;</span><span class="k">do</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>unlink<span class="w"> </span>openfoodfacts-logo-<span class="nv">$LANG</span>-356x300.png<span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>ln<span class="w"> </span>-s<span class="w">  </span>openpetfoodfacts-logo-en-356x300.png<span class="w"> </span>openfoodfacts-logo-<span class="nv">$LANG</span>-356x300.png<span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>unlink<span class="w"> </span>openfoodfacts-logo-<span class="nv">$LANG</span>-178x150.png<span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>ln<span class="w"> </span>-s<span class="w">  </span>openpetfoodfacts-logo-en-178x150.png<span class="w"> </span>openfoodfacts-logo-<span class="nv">$LANG</span>-178x150.png<span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="k">done</span><span class="p">;</span>
</code></pre></div></p>
<p>A last image:
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>/srv/opff/html/images/misc/
ln<span class="w"> </span>-s<span class="w"> </span>android-apk.svg<span class="w"> </span>android-apk-40x135.svg
</code></pre></div></p>
<h3 id="installing-cpan">Installing CPAN<a class="headerlink" href="#installing-cpan" title="Permanent link">#</a></h3>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>/srv/opff
sudo<span class="w"> </span>cpanm<span class="w"> </span>--notest<span class="w"> </span>--quiet<span class="w"> </span>--skip-satisfied<span class="w"> </span>--installdeps<span class="w"> </span>.
Successfully<span class="w"> </span>installed<span class="w"> </span>CLDR-Number-0.19
Successfully<span class="w"> </span>installed<span class="w"> </span>Mojolicious-9.31
Successfully<span class="w"> </span>installed<span class="w"> </span>Minion-10.25
You<span class="w"> </span>have<span class="w"> </span>CLDR::Number<span class="w"> </span><span class="o">(</span><span class="m">0</span>.19<span class="o">)</span>
Successfully<span class="w"> </span>installed<span class="w"> </span>Modern-Perl-1.20230106
Successfully<span class="w"> </span>installed<span class="w"> </span>Heap-0.80
Successfully<span class="w"> </span>installed<span class="w"> </span>Set-Object-1.42
Successfully<span class="w"> </span>installed<span class="w"> </span>Graph-0.9726
Successfully<span class="w"> </span>installed<span class="w"> </span>GraphViz2-2.67
Successfully<span class="w"> </span>installed<span class="w"> </span>Algorithm-CheckDigits-v1.3.6
You<span class="w"> </span>have<span class="w"> </span>CLDR::Number::Format::Percent<span class="w"> </span><span class="o">(</span><span class="m">0</span>.19<span class="o">)</span>
Successfully<span class="w"> </span>installed<span class="w"> </span>XML-Rules-1.16
Successfully<span class="w"> </span>installed<span class="w"> </span>Text-Fuzzy-0.29
Successfully<span class="w"> </span>installed<span class="w"> </span>LEOCHARRE-DEBUG-1.14
Successfully<span class="w"> </span>installed<span class="w"> </span>LEOCHARRE-CLI-1.19
Successfully<span class="w"> </span>installed<span class="w"> </span>Image-OCR-Tesseract-1.26
Successfully<span class="w"> </span>installed<span class="w"> </span>Action-CircuitBreaker-0.1
Successfully<span class="w"> </span>installed<span class="w"> </span>Text-CSV_XS-1.50
Successfully<span class="w"> </span>installed<span class="w"> </span>Spreadsheet-CSV-0.20
Successfully<span class="w"> </span>installed<span class="w"> </span>UUID-URandom-0.001
Successfully<span class="w"> </span>installed<span class="w"> </span>MongoDB-v2.2.2
You<span class="w"> </span>have<span class="w"> </span>Mojolicious::Lite<span class="w"> </span><span class="o">(</span>undef<span class="o">)</span>
Successfully<span class="w"> </span>installed<span class="w"> </span>Module-Build-Pluggable-CPANfile-0.05
Successfully<span class="w"> </span>installed<span class="w"> </span>IO-Interactive-Tiny-0.2
Successfully<span class="w"> </span>installed<span class="w"> </span>Data-Dumper-AutoEncode-1.00
Successfully<span class="w"> </span>installed<span class="w"> </span>SQL-Abstract-2.000001<span class="w"> </span><span class="o">(</span>upgraded<span class="w"> </span>from<span class="w"> </span><span class="m">1</span>.87<span class="o">)</span>
Successfully<span class="w"> </span>installed<span class="w"> </span>SQL-Abstract-Pg-1.0
Successfully<span class="w"> </span>installed<span class="w"> </span>Mojo-Pg-4.27
Successfully<span class="w"> </span>installed<span class="w"> </span>Encode-Punycode-1.002
Successfully<span class="w"> </span>installed<span class="w"> </span>B-Keywords-1.24
Successfully<span class="w"> </span>installed<span class="w"> </span>Config-Tiny-2.29
Successfully<span class="w"> </span>installed<span class="w"> </span>Task-Weaken-1.06
Successfully<span class="w"> </span>installed<span class="w"> </span>PPI-1.276
Successfully<span class="w"> </span>installed<span class="w"> </span>PPIx-Regexp-0.088
You<span class="w"> </span>have<span class="w"> </span>PPIx::Regexp::Util<span class="w"> </span><span class="o">(</span><span class="m">0</span>.088<span class="o">)</span>
Successfully<span class="w"> </span>installed<span class="w"> </span>PPIx-Utils-0.003
Successfully<span class="w"> </span>installed<span class="w"> </span>String-Format-1.18
You<span class="w"> </span>have<span class="w"> </span>PPI<span class="w"> </span><span class="o">(</span><span class="m">1</span>.276<span class="o">)</span>
You<span class="w"> </span>have<span class="w"> </span>PPI::Node<span class="w"> </span><span class="o">(</span><span class="m">1</span>.276<span class="o">)</span>
Successfully<span class="w"> </span>installed<span class="w"> </span>PPIx-QuoteLike-0.023
You<span class="w"> </span>have<span class="w"> </span>PPI::Token::Quote::Single<span class="w"> </span><span class="o">(</span><span class="m">1</span>.276<span class="o">)</span>
Successfully<span class="w"> </span>installed<span class="w"> </span>Perl-Tidy-20230309
You<span class="w"> </span>have<span class="w"> </span>PPI::Document::File<span class="w"> </span><span class="o">(</span><span class="m">1</span>.276<span class="o">)</span>
You<span class="w"> </span>have<span class="w"> </span>PPI::Document<span class="w"> </span><span class="o">(</span><span class="m">1</span>.276<span class="o">)</span>
Successfully<span class="w"> </span>installed<span class="w"> </span>Lingua-EN-Inflect-1.905
Successfully<span class="w"> </span>installed<span class="w"> </span>Pod-Spell-1.26
Successfully<span class="w"> </span>installed<span class="w"> </span>Perl-Critic-1.150
You<span class="w"> </span>have<span class="w"> </span>Perl::Critic::Utils<span class="w"> </span><span class="o">(</span><span class="m">1</span>.150<span class="o">)</span>
Successfully<span class="w"> </span>installed<span class="w"> </span>MCE-1.884
You<span class="w"> </span>have<span class="w"> </span>Perl::Critic::Violation<span class="w"> </span><span class="o">(</span><span class="m">1</span>.150<span class="o">)</span>
Successfully<span class="w"> </span>installed<span class="w"> </span>Test-Perl-Critic-1.04
Successfully<span class="w"> </span>installed<span class="w"> </span>Text-CSV-2.02
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/README:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/Changes:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/LICENSE:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/dist.ini:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/META.yml:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/MANIFEST:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/Build.PL:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/t/linear.t:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/t:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/Makefile.PL:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/t/constant.t:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/t/fibonacci.t:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/t/00-compile.t:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/t/nonblocking.t:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/t/check_params.t:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/lib/Action/Retry.pm:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/lib/Action:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/t/release-distmeta.t:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/t/release-pod-coverage.t:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/lib/Action/Retry/Strategy.pm:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/lib/Action/Retry/Strategy/Linear.pm:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/lib/Action/Retry/Strategy/Constant.pm:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/lib/Action/Retry/Strategy/Fibonacci.pm:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/lib/Action/Retry/Strategy/HelperRole/RetriesLimit.pm:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/lib/Action/Retry/Strategy/HelperRole/SleepCapping.pm:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/lib/Action/Retry/Strategy/HelperRole/SleepTimeout.pm:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/lib/Action/Retry/Strategy/HelperRole:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/lib/Action/Retry/Strategy:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24/lib/Action/Retry:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Action-Retry-0.24:<span class="w"> </span>Cannot<span class="w"> </span>change<span class="w"> </span>ownership<span class="w"> </span>to<span class="w"> </span>uid<span class="w"> </span><span class="m">3957780</span>,<span class="w"> </span>gid<span class="w"> </span><span class="m">10902869</span>:<span class="w"> </span>Invalid<span class="w"> </span>argument
/usr/bin/tar:<span class="w"> </span>Exiting<span class="w"> </span>with<span class="w"> </span>failure<span class="w"> </span>status<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span>previous<span class="w"> </span>errors
Successfully<span class="w"> </span>installed<span class="w"> </span>Action-Retry-0.24
Successfully<span class="w"> </span>installed<span class="w"> </span>Locale-Maketext-Lexicon-Getcontext-0.05
Successfully<span class="w"> </span>installed<span class="w"> </span>Crypt-ScryptKDF-0.010
<span class="m">44</span><span class="w"> </span>distributions<span class="w"> </span>installed
</code></pre></div>
<h2 id="setting-up-services">Setting up services<a class="headerlink" href="#setting-up-services" title="Permanent link">#</a></h2>
<h3 id="nginx-for-opff-inside-container">NGINX for OPFF (inside container)<a class="headerlink" href="#nginx-for-opff-inside-container" title="Permanent link">#</a></h3>
<p>Installed nginx <code>apt install nginx</code>.</p>
<p>Removed default site <code>unlink /etc/nginx/sites-enabled/default</code></p>
<p>Copied production nginx configuration of off1 in <code>/etc/nginx/sites-enabled/opff</code> to off2 in <code>/srv/opff/conf/nginx/sites-available/opff</code></p>
<p>Modified it's configuration to remove ssl section (<strong>FIXME:</strong> to be commited in off-server)</p>
<p>Then made a symlink: <code>ln -s /srv/opff/conf/nginx/sites-available/opff /etc/nginx/sites-enabled/opff</code></p>
<p>But we want to have config files in the git, so here is what we did.</p>
<p>Nginx conf:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/opff/conf/nginx/sites-available<span class="w"> </span>/etc/nginx/sites-enabled/opff
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/opff/conf/nginx/snippets/expires-no-json-xml.conf<span class="w"> </span>/etc/nginx/snippets
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/opff/conf/nginx/snippets/off.cors-headers.include<span class="w"> </span>/etc/nginx/snippets
sudo<span class="w"> </span>rm<span class="w"> </span>/etc/nginx/mime.types
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/opff/conf/nginx/mime.types<span class="w"> </span>/etc/nginx/
<span class="c1"># add specific files</span>
ln<span class="w"> </span>-s<span class="w"> </span>/srv/opff/conf/nginx/snippets/off.cors-headers.include<span class="w"> </span>/etc/nginx/snippets
</code></pre></div>
<p>test it and restart:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>nginx<span class="w"> </span>-t
sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>nginx
</code></pre></div></p>
<h3 id="apache">Apache<a class="headerlink" href="#apache" title="Permanent link">#</a></h3>
<p>On off1 conf is in <code>/etc/apache2-opff/</code>, here we can set it up in directly in system apache configuration.</p>
<p>On off2:</p>
<ul>
<li>Remove default config (or it will conflict on port 80 with nginx):
  <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>unlink<span class="w"> </span>/etc/apache2/sites-enabled/000-default.conf
</code></pre></div></li>
</ul>
<ul>
<li>We disable mpm event and enable mpm prefork:
  <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>a2dismod<span class="w"> </span>mpm_event
sudo<span class="w"> </span>a2enmod<span class="w"> </span>mpm_prefork
</code></pre></div></li>
</ul>
<ul>
<li>add the configuration for opff (as stored openfoodfacts-server project)
  copied the opff.conf file in <code>/etc/apache2/sites-available</code> and activate it:
  <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>a2ensite<span class="w"> </span>opff.conf
</code></pre></div></li>
</ul>
<ul>
<li>edit <code>/etc/apache2-opf/envvars</code>
  <div class="highlight"><pre><span></span><code>#export APACHE_RUN_USER=www-data
export APACHE_RUN_USER=off
#export APACHE_RUN_GROUP=www-data
export APACHE_RUN_GROUP=off
</code></pre></div></li>
</ul>
<ul>
<li>edit <code>/etc/apache2/mods-available/mpm_prefork.conf</code>
  <div class="highlight"><pre><span></span><code>      StartServers                     2
      MinSpareServers           2
      MaxSpareServers          4
      MaxRequestWorkers         20
      MaxConnectionsPerChild   500
</code></pre></div></li>
</ul>
<ul>
<li>change ports apache is listening in <code>/etc/apache2/ports.conf</code> (because we need port 80 for nginx):
  <div class="highlight"><pre><span></span><code>Listen 8001

#&lt;IfModule ssl_module&gt;
#       Listen 443
#&lt;/IfModule&gt;

#&lt;IfModule mod_gnutls.c&gt;
#       Listen 443
#&lt;/IfModule&gt;
</code></pre></div></li>
</ul>
<p>We also have to change permissions on log since we changed run user:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>chown<span class="w"> </span>off:off<span class="w"> </span>-R<span class="w"> </span>/var/log/apache2<span class="w"> </span>/var/run/apache2
</code></pre></div>
<p>We want to put it all in git:</p>
<div class="highlight"><pre><span></span><code>ln<span class="w"> </span>-s<span class="w"> </span>/srv/opff/conf/apache-2.4/sites-available/opff.conf<span class="w"> </span>/etc/apache2/sites-enabled/opff.conf
<span class="c1"># we replace mpm_prefork conf</span>
ln<span class="w"> </span>-s<span class="w"> </span>/srv/opff/conf/apache-2.4/opff-mpm_prefork.conf<span class="w"> </span>/etc/apache2/mods-available/mpm_prefork.conf
<span class="c1"># replace ports.conf</span>
ln<span class="w"> </span>-s<span class="w"> </span>/srv/opff/conf/apache-2.4/opff-ports.conf<span class="w"> </span>/etc/apache2/ports.conf
</code></pre></div>
<p>test it:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apache2ctl<span class="w"> </span>configtest
</code></pre></div></p>
<h3 id="creating-systemd-units-for-timers-jobs">creating systemd units for timers jobs<a class="headerlink" href="#creating-systemd-units-for-timers-jobs" title="Permanent link">#</a></h3>
<p>Good source:</p>
<ul>
<li>https://trstringer.com/systemd-timer-vs-cronjob/</li>
<li>https://dev.to/setevoy/linux-systemd-unit-files-edit-restart-on-failure-and-email-notifications-5h3k</li>
<li>https://www.freedesktop.org/software/systemd/man/systemd.unit.html to use "instance names"</li>
</ul>
<p>See git for actual units and timers and the service for email notifications.</p>
<p>We want them to be in git, so finally:</p>
<p>Systemd units:
<div class="highlight"><pre><span></span><code>ln<span class="w"> </span>-s<span class="w"> </span>/srv/opff/conf/systemd/gen_feeds<span class="se">\@</span>.timer<span class="w"> </span>/etc/systemd/system
ln<span class="w"> </span>-s<span class="w"> </span>/srv/opff/conf/systemd/gen_feeds_daily<span class="se">\@</span>.service<span class="w"> </span>/etc/systemd/system
ln<span class="w"> </span>-s<span class="w"> </span>/srv/opff/conf/systemd/gen_feeds_daily<span class="se">\@</span>.timer<span class="w"> </span>/etc/systemd/system
ln<span class="w"> </span>-s<span class="w"> </span>/srv/opff/conf/systemd/email-failures<span class="se">\@</span>.service<span class="w"> </span>/etc/systemd/system
</code></pre></div></p>
<p>Test failure notification is working:</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>start<span class="w"> </span>email-failures@gen_feeds__opff.service
</code></pre></div>
<p>Test systemclt gen_feeds services are working:</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>start<span class="w"> </span>gen_feeds_daily@opff.service
systemctl<span class="w"> </span>start<span class="w"> </span>gen_feeds@opff.service
</code></pre></div>
<p>Activate systemd units:</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>gen_feeds@opff.timer
systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>gen_feeds_daily@opff.timer
systemctl<span class="w"> </span>daemon-reload
</code></pre></div>
<h3 id="adding-failure-notification-for-apache-and-nginx-in-systemd">Adding failure notification for apache and nginx in systemd<a class="headerlink" href="#adding-failure-notification-for-apache-and-nginx-in-systemd" title="Permanent link">#</a></h3>
<p>We can add the on failure notification we created for timers to apache2.service and nginx.service:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>grep<span class="w"> </span>-B<span class="w"> </span><span class="m">4</span><span class="w"> </span>email-failure<span class="w"> </span>/usr/lib/systemd/system/apache2.service
<span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>The<span class="w"> </span>Apache<span class="w"> </span>HTTP<span class="w"> </span>Server
<span class="nv">After</span><span class="o">=</span>network.target<span class="w"> </span>remote-fs.target<span class="w"> </span>nss-lookup.target
<span class="nv">Documentation</span><span class="o">=</span>https://httpd.apache.org/docs/2.4/
<span class="nv">OnFailure</span><span class="o">=</span>email-failures@apache2-opff.service
$<span class="w"> </span>grep<span class="w"> </span>-B<span class="w"> </span><span class="m">4</span><span class="w"> </span>email-failure<span class="w"> </span>/usr/lib/systemd/system/nginx.service
<span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>A<span class="w"> </span>high<span class="w"> </span>performance<span class="w"> </span>web<span class="w"> </span>server<span class="w"> </span>and<span class="w"> </span>a<span class="w"> </span>reverse<span class="w"> </span>proxy<span class="w"> </span>server
<span class="nv">Documentation</span><span class="o">=</span>man:nginx<span class="o">(</span><span class="m">8</span><span class="o">)</span>
<span class="nv">After</span><span class="o">=</span>network.target<span class="w"> </span>nss-lookup.target
<span class="nv">OnFailure</span><span class="o">=</span>email-failures@nginx-opff.service
</code></pre></div>
<p>But we want to put that in git, so:</p>
<div class="highlight"><pre><span></span><code>cp<span class="w"> </span>/etc/systemd/system/apache2.service.d<span class="w"> </span>-r<span class="w"> </span>conf/systemd/
cp<span class="w"> </span>/etc/systemd/system/nginx.service.d/<span class="w"> </span>-r<span class="w"> </span>conf/systemd/
sudo<span class="w"> </span>rm<span class="w"> </span>/etc/systemd/system/apache2.service.d<span class="w"> </span>/etc/systemd/system/nginx.service.d<span class="w"> </span>-r
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/opff/conf/systemd/nginx.service.d<span class="w"> </span>/etc/systemd/system/
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/opff/conf/systemd/apache2.service.d<span class="w"> </span>/etc/systemd/system/
sudo<span class="w"> </span>systemctl<span class="w"> </span>daemon-reload
</code></pre></div>
<h3 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">#</a></h3>
<p>Direct apache call
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>localhost:8001/cgi/display.pl<span class="w"> </span>--header<span class="w"> </span><span class="s1">&#39;Host: fr.openpetfoodfacts.org&#39;</span>
</code></pre></div></p>
<p>Nginx call
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>localhost<span class="w"> </span>--header<span class="w"> </span><span class="s1">&#39;Host: fr.openpetfoodfacts.org&#39;</span>
</code></pre></div></p>
<h3 id="verifying-if-we-need-apache2connectionxforwardedfor">Verifying if we need Apache2::Connection::XForwardedFor<a class="headerlink" href="#verifying-if-we-need-apache2connectionxforwardedfor" title="Permanent link">#</a></h3>
<p>We want to verify if we need to install Apache2::Connection::XForwardedFor</p>
<p>For this after having deployed, and it's working ok, I log in the new site.
Then I use:</p>
<p><div class="highlight"><pre><span></span><code>cd /srv/opff/scripts
perl sto_to_json.pl /mnt/opff/users/alexg.sto|jq .
</code></pre></div>
and look at the higher timstamp for <code>user_sessions</code> and look at <code>ip</code>.
It's <code>10.1.0.101</code> so ip is masked to the app.</p>
<p>Install the package: </p>
<p>add <code>Apache2::Connection::XForwardedFor</code> and <code>Apache::Bootstrap</code> to cpanfile, then run: </p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>libapache2-mod-perl2-dev
sudo<span class="w"> </span>cpanm<span class="w"> </span>--notest<span class="w"> </span>--quiet<span class="w"> </span>--skip-satisfied<span class="w"> </span>--installdeps<span class="w"> </span>.
</code></pre></div>
<p>then
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apachectl<span class="w"> </span>configtest
sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>apache2
</code></pre></div></p>
<p>It is not enough, I have two problems:</p>
<ol>
<li><code>opff-access.log</code> of ngix in opff container does not log the user ip adress, but the proxy ip adress (useless)</li>
<li>nginx in opff container should not change X-Real-IP and X-Forwarded-For provided by first proxy</li>
</ol>
<p>So I:</p>
<ul>
<li>tweak the nginx logging by adding a specific conf in <code>/srv/opff/conf/nginx/conf.d/log_format_realip.conf</code>:
  <div class="highlight"><pre><span></span><code># a log format for behing a proxy
log_format proxied_requests
  &#39;$http_x_forwarded_for - $remote_user [$time_local] &#39;
  &#39;&quot;$request&quot; $status $body_bytes_sent &#39;
  &#39;&quot;$http_referer&quot; &quot;$http_user_agent&quot;&#39;;
</code></pre></div>
  and use it:
  <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/opff/conf/nginx/conf.d/log_format_realip.conf<span class="w"> </span>/etc/nginx/conf.d/log_format_realip.conf
</code></pre></div></li>
<li>then change the configuration to use this log format for opff <code>/srv/opff/conf/nginx/sites-available/opff</code>:
  <div class="highlight"><pre><span></span><code>...
        access_log /var/log/nginx/opff-access.log proxied_requests;
...
       location / {
              proxy_set_header Host $host;
              # those headers are set by the first reverse proxy
              #proxy_set_header X-Real-IP $remote_addr;
              #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

              proxy_pass http://127.0.0.1:8001/cgi/display.pl?;
      }

      location /cgi/ {
              proxy_set_header Host $host;
              # those headers are set by the first reverse proxy
              #proxy_set_header X-Real-IP $remote_addr;
              #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_pass http://127.0.0.1:8001;
      }
</code></pre></div></li>
</ul>
<ul>
<li>restart nginx
  <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>nginx<span class="w"> </span>-t
sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>nginx
</code></pre></div></li>
</ul>
<p>Later on, I discovered the <a href="https://nginx.org/en/docs/http/ngx_http_realip_module.html"><code>set_real_ip_from</code> directive</a> which is really tailored for this situation, and so my configuration became:</p>
<div class="highlight"><pre><span></span><code>...
 location / {
                proxy_set_header Host $host;
                # recursive hosts as we are proxying behind a proxy
                set_real_ip_from 10.0.0.0/8;
                real_ip_recursive on;
                proxy_pass http://127.0.0.1:8001/cgi/display.pl?;
        }

        location /cgi/ {
                proxy_set_header Host $host;
                # recursive hosts as we are proxying behind a proxy
                set_real_ip_from 10.0.0.0/8;
                real_ip_recursive on;
                proxy_pass http://127.0.0.1:8001;
        }
</code></pre></div>
<h3 id="log-rotate-perl-logs">log rotate perl logs<a class="headerlink" href="#log-rotate-perl-logs" title="Permanent link">#</a></h3>
<p>Perl logs rotation requires an apache restart, so we will replace the apache conf to use our log rotate with all considered files.</p>
<p>So I wrote <code>conf/logrotate/apache</code> and then:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>rm<span class="w"> </span>/etc/logrotate.d/apache
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/srv/opff/conf/logrotate/apache2<span class="w"> </span>/etc/logrotate.d/apache2
<span class="c1"># logrotate needs root ownerships</span>
sudo<span class="w"> </span>chown<span class="w"> </span>root:root<span class="w"> </span>/srv/opff/conf/logrotate/apache2
</code></pre></div></p>
<p>We can test with:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>logrotate<span class="w"> </span>/etc/logrotate.conf<span class="w"> </span>--debug
</code></pre></div></p>
<h3 id="installing-mongodb-client">Installing mongodb client<a class="headerlink" href="#installing-mongodb-client" title="Permanent link">#</a></h3>
<p>In opff.</p>
<p>We need mongodb client to be able to export the database in gen_feeds.</p>
<p>I'll follow official doc for 4.4 https://www.mongodb.com/docs/v4.4/tutorial/install-mongodb-on-debian/,
but we are on bullseye, and we just want to install tools.</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://pgp.mongodb.com/server-4.4.asc<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>sudo<span class="w"> </span>gpg<span class="w"> </span>-o<span class="w"> </span>/usr/share/keyrings/mongodb-server-4.4.gpg<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>--dearmor
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;deb [ signed-by=/usr/share/keyrings/mongodb-server-4.4.gpg ] http://repo.mongodb.org/apt/debian bullseye/mongodb-org/4.4 main&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/mongodb-org-4.4.list
sudo<span class="w"> </span>apt<span class="w"> </span>update
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w">  </span>mongodb-database-tools
</code></pre></div>
<p>We can see if we will be able to use mongoexport</p>
<h2 id="opff-nginx-reverse-proxy-configuration">OPFF NGINX reverse proxy configuration<a class="headerlink" href="#opff-nginx-reverse-proxy-configuration" title="Permanent link">#</a></h2>
<p>We follow <a href="../../nginx-reverse-proxy/#steps-to-create-nginx-configuration">Steps to create Nginx configuration</a>
but we put host in <code>/opt/openfoodfacts-infrastructure/confs/proxy-off/nginx</code></p>
<p>See also how we <a href="#certbot-wildcard-certificates-using-ovh-dns">setup wildcard certificates, above</a></p>
<h2 id="debugs-and-fixing">Debugs and fixing<a class="headerlink" href="#debugs-and-fixing" title="Permanent link">#</a></h2>
<h3 id="testing_1">Testing<a class="headerlink" href="#testing_1" title="Permanent link">#</a></h3>
<p>To test my installation I added this to <code>/etc/hosts</code> on my computer:
<div class="highlight"><pre><span></span><code>213.36.253.214 fr.openpetfoodfacts.org world-fr.openpetfoodfacts.org static.openpetfoodfacts.org images.openpetfoodfacts.org world.openpetfoodfacts.org
</code></pre></div></p>
<h3 id="mongodb-access">Mongodb access<a class="headerlink" href="#mongodb-access" title="Permanent link">#</a></h3>
<p>I wasn't able to connect to mongodb from opff container.</p>
<p>On off2:
<div class="highlight"><pre><span></span><code>nc<span class="w"> </span>-vz<span class="w"> </span><span class="m">10</span>.0.0.3<span class="w"> </span><span class="m">27017</span>
</code></pre></div>
did not suceed.</p>
<p>I had to go on off3 and add an iptables rule:</p>
<div class="highlight"><pre><span></span><code>iptables<span class="w"> </span>-A<span class="w"> </span>INPUT<span class="w"> </span>-s<span class="w"> </span><span class="m">10</span>.0.0.2/32<span class="w"> </span>-i<span class="w"> </span>ens19<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">27017</span><span class="w"> </span>-m<span class="w"> </span>conntrack<span class="w"> </span>--ctstate<span class="w"> </span>NEW,ESTABLISHED<span class="w"> </span>-j<span class="w"> </span>ACCEPT
iptables<span class="w"> </span>-A<span class="w"> </span>INPUT<span class="w"> </span>-s<span class="w"> </span><span class="m">10</span>.1.0.1/24<span class="w"> </span>-i<span class="w"> </span>ens19<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-m<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">27017</span><span class="w"> </span>-m<span class="w"> </span>conntrack<span class="w"> </span>--ctstate<span class="w"> </span>NEW,ESTABLISHED<span class="w"> </span>-j<span class="w"> </span>ACCEPT
</code></pre></div>
<p>I also added it to <code>/etc/iptables/rules.v4</code>.</p>
<p>There was also a route problem on off3: route is only defined for <code>10.0.0.3/24</code> while our containers are in <code>10.1.x.x</code>.</p>
<p>To solve this, on off3:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">10</span>.1.0.0/16<span class="w"> </span>dev<span class="w"> </span>ens19<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.0.0.3
</code></pre></div>
and I modified <code>/etc/network/interfaces</code> to add a post-up rule:
<div class="highlight"><pre><span></span><code># The internal network interface
auto ens19
iface ens19 inet static
        address 10.0.0.3/24
        # needed for off2 containers to access mongodb
        post-up ip route add 10.1.0.0/16 dev ens19 proto kernel scope link src 10.0.0.3
        pre-down ip route del 10.1.0.0/16 dev ens19 proto kernel scope link src 10.0.0.3
</code></pre></div></p>
<h3 id="fixing-geoip">Fixing GeoIP<a class="headerlink" href="#fixing-geoip" title="Permanent link">#</a></h3>
<p>GeoIP does not seems to work. If I had a new product from https://world.openpetfoodfacts.org country where soled is not pre-filled.</p>
<p>I found a script helps debugging geoip issues. To test I run:
<div class="highlight"><pre><span></span><code>perl<span class="w"> </span>-I/srv/opff/lib<span class="w"> </span>-d<span class="w"> </span>scripts/test_geoip.pl
</code></pre></div>
It wait's for a IP input.</p>
<p>As it does not work, I try to debug it, using the <code>-d</code> flag. It seems <code>$gi</code> gloabl which is geo ip database is not loaded.
Indeed the file specified by <code>$geolite2_path</code> does not exists.</p>
<p>I look at what packages provides:
<div class="highlight"><pre><span></span><code>dpkg-query<span class="w"> </span>-L<span class="w"> </span>geoip-database
dpkg-query<span class="w"> </span>-L<span class="w"> </span>geoipupdate
</code></pre></div>
We seems to have a <code>/usr/share/GeoIP/GeoIP.dat</code> (and <code>/usr/share/GeoIP/GeoIPv6.dat</code>)</p>
<p>Trying in debugger:
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="n">DB</span><span class="sr">&lt;2&gt;</span><span class="w"> </span><span class="nv">$gi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">GeoIP2::Database::Reader</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="n">file</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&#39;/usr/share/GeoIP/GeoIP.dat&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="n">DB</span><span class="sr">&lt;4&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nv">$gi</span>
<span class="mi">0</span><span class="w">  </span><span class="nn">GeoIP2::Database::</span><span class="n">Reader</span><span class="o">=</span><span class="n">HASH</span><span class="p">(</span><span class="mh">0x55a4cca974c0</span><span class="p">)</span>
<span class="w">   </span><span class="s">&#39;file&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&#39;/usr/share/GeoIP/GeoIP.dat&#39;</span>
<span class="w">   </span><span class="s">&#39;locales&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">ARRAY</span><span class="p">(</span><span class="mh">0x55a4ccbdfdd8</span><span class="p">)</span>
<span class="w">      </span><span class="mi">0</span><span class="w">  </span><span class="s">&#39;en&#39;</span>
<span class="w">  </span><span class="n">DB</span><span class="sr">&lt;5&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="nv">$gi</span><span class="o">-&gt;</span><span class="n">country</span><span class="p">(</span><span class="n">ip</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&#39;*.*.*.*&#39;</span><span class="p">);</span><span class="w">  </span><span class="c1"># removed id</span>
<span class="nn">MaxMind::DB::Reader::</span><span class="n">XS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="n">opening</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="s">&quot;/usr/share/GeoIP/GeoIP.dat&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">MaxMind</span><span class="w"> </span><span class="n">DB</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="sr">/usr/</span><span class="n">lib</span><span class="sr">/x86_64-linux-gnu/</span><span class="n">perl5</span><span class="sr">/5.32/</span><span class="n">MaxMind</span><span class="sr">/DB/</span><span class="n">Reader</span><span class="o">/</span><span class="n">XS</span><span class="o">.</span><span class="n">pm</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="mi">73</span><span class="p">,</span><span class="w"> </span><span class="sr">&lt;STDIN&gt;</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="mi">1</span><span class="o">.</span>
</code></pre></div></p>
<p>It's not this.
But looking at <a href="https://manpages.debian.org/bullseye/geoipupdate/GeoIP.conf.5.en.html"><code>GeoIP.conf</code> man page</a> I see it's in <code>/var/lib/GeoIP/</code> (very logically !).
Testing it again and it works.</p>
<p>So I edited <code>/srv/opff/lib/ProductOpener/Config2.pm</code> to have:
<div class="highlight"><pre><span></span><code><span class="nv">$geolite2_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;/var/lib/GeoIP/GeoLite2-Country.mmdb&#39;</span><span class="p">;</span>
</code></pre></div></p>
<h3 id="x-forwarded-for-problem">X-Forwarded-For problem<a class="headerlink" href="#x-forwarded-for-problem" title="Permanent link">#</a></h3>
<p>Reading at <code>/var/log/apache2/opff_access_log</code> the ip adress seemed to be 127.0.0.1.
But it was only because the LogFormat directive was ignored because of an error in the format name in CustomLog directive.</p>
<p>Fixing that it worked. But on the way to do it, I changed Nginx config as I discovered the <code>set_real_ip_from</code> directive.</p>
<h3 id="fixing-lang-problem">Fixing lang problem<a class="headerlink" href="#fixing-lang-problem" title="Permanent link">#</a></h3>
<p>Symptom: no images loaded on product. In console, 404 on https://static.openpetfoodfacts.org/data/i18n/en/lang.json</p>
<p>Indeed I didn't sync the data folder from off1 (because I wanted to see exports regenerated)</p>
<p>On off2:
<div class="highlight"><pre><span></span><code>rsync<span class="w"> </span>-a<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span><span class="m">10</span>.0.0.1://srv/opff/html/data/<span class="w"> </span>/zfs-hdd/opff/data/
</code></pre></div>
But I also forgot to link /srv/opff/html/data/ to /mnt/
<div class="highlight"><pre><span></span><code>mv<span class="w"> </span>/srv/opff/html/data<span class="o">{</span>,.old<span class="o">}</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/mnt/opff/html_data<span class="w"> </span>/srv/opff/html/data
</code></pre></div>
Fixed the problem.</p>
<h2 id="enabling-migration-by-cross-nfs-mounting-folders">Enabling migration by cross nfs mounting folders<a class="headerlink" href="#enabling-migration-by-cross-nfs-mounting-folders" title="Permanent link">#</a></h2>
<p>To be able to migrate products between instances, we need to:</p>
<ul>
<li>talk to same mongodb (it's already the case)</li>
<li>access products and images folders of other instances (todo)</li>
</ul>
<p>Working on moving images to ZFS (<strong>FIXME</strong>: link), I already setup sharing off2 ZFS dataset of zfs-hdd/off/images on off1.</p>
<p>Now we will:</p>
<ul>
<li>also mount products datasets on off1</li>
<li>install zfs server on off1 and share current products and images folders</li>
</ul>
<h3 id="mount-off1-zfs-dataset-on-off2">Mount off1 ZFS dataset on off2<a class="headerlink" href="#mount-off1-zfs-dataset-on-off2" title="Permanent link">#</a></h3>
<p>Install NFS server on off1:</p>
<div class="highlight"><pre><span></span><code>apt<span class="w"> </span>install<span class="w"> </span>nfs-kernel-server
</code></pre></div>
<p>Add volumes to NFS shares in <code>/etc/exports/</code>:</p>
<div class="highlight"><pre><span></span><code># share volumes to off2 using NFSv3
# note that products are directly shared through zfs
/srv2/off/html/images/products  10.0.0.2(rw,no_subtree_check,no_root_squash)
/srv2/off-pro/html/images/products      10.0.0.2(rw,no_subtree_check,no_root_squash)
/srv/obf/html/images/products   10.0.0.2(rw,no_subtree_check,no_root_squash)
/srv/opf/html/images/products   10.0.0.2(rw,no_subtree_check,no_root_squash)
</code></pre></div>
<p>Testing a mount on off2:</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>/mnt/off1/
mkdir<span class="w"> </span>/mnt/off1/off-images-products
mount<span class="w"> </span>-t<span class="w"> </span>nfs<span class="w"> </span>-o<span class="w"> </span>rw<span class="w"> </span><span class="s2">&quot;10.0.0.1://srv2/off/html/images/products&quot;</span><span class="w">  </span>/mnt/off1/off-images-products
ls<span class="w"> </span>off1/off-images-products/000/000/023/4/
</code></pre></div>
<p>It works.</p>
<p>Now we will share zfs volumes for products.</p>
<p>On off1:
<div class="highlight"><pre><span></span><code>zfs<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">sharenfs</span><span class="o">=</span><span class="s2">&quot;rw=@10.0.0.2/32&quot;</span><span class="w"> </span>rpool/obf/products
zfs<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">sharenfs</span><span class="o">=</span><span class="s2">&quot;rw=@10.0.0.2/32&quot;</span><span class="w"> </span>rpool/off/products
zfs<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">sharenfs</span><span class="o">=</span><span class="s2">&quot;rw=@10.0.0.2/32&quot;</span><span class="w"> </span>rpool/opf/products
zfs<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">sharenfs</span><span class="o">=</span><span class="s2">&quot;rw=@10.0.0.2/32&quot;</span><span class="w"> </span>rpool/opff/products
</code></pre></div></p>
<p>Test on off2:
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>off1/obf-products
mount<span class="w"> </span>-t<span class="w"> </span>nfs<span class="w"> </span>-o<span class="w"> </span>rw<span class="w"> </span><span class="s2">&quot;10.0.0.1://rpool/obf/products&quot;</span><span class="w">  </span>/mnt/off1/obf-products
<span class="c1"># test</span>
ls<span class="w"> </span>-l<span class="w"> </span>/mnt/off1/obf-products/000/000/614/7198
</code></pre></div></p>
<p>Creating mount points on off2:
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>/mnt/off1/o<span class="o">{</span>b,p,f<span class="o">}</span>f-products
mkdir<span class="w"> </span>/mnt/off1/o<span class="o">{</span>p,b,f<span class="o">}</span>f-images-products
</code></pre></div></p>
<p>Editing <code>/etc/fstab</code> on off2 to add all nfs shares:
<div class="highlight"><pre><span></span><code>10.0.0.1://srv2/off/html/images/products  /mnt/off1/off-images-products nfs rw,nolock  0 0
10.0.0.1://rpool/off/products  /mnt/off1/off-products nfs rw,nolock  0 0
10.0.0.1://srv/obf/html/images/products  /mnt/off1/obf-images-products nfs rw  0 0
10.0.0.1://rpool/obf/products  /mnt/off1/obf-products nfs rw,nolock  0 0
10.0.0.1://srv/opf/html/images/products  /mnt/off1/opf-images-products nfs rw  0 0
10.0.0.1://rpool/opf/products  /mnt/off1/opf-products nfs rw,nolock  0 0
</code></pre></div></p>
<p><strong>WARNING:</strong> the <code>nolock</code> (no inter-server lock, lock are local to a server only) here is not really safe, as we have processes on two machines, but it should be safe enough in this case (as the product is moving, so the lock on one side still stand, and the other side as really few chances to edit a product which does not yet exists), and for a relative short time.</p>
<h3 id="bind-mount">Bind mount<a class="headerlink" href="#bind-mount" title="Permanent link">#</a></h3>
<p>Note: I decided to bind mount the NFS mounts. I could have directly mouted the nfs volumes in the container, but as in target deployment they really will be bind mount, I prefer to do this for now. (Note than NFS inside lxc seems to require <a href="https://memo-linux.com/proxmox-5-ajout-dun-point-de-montage-nfs-dans-un-conteneur-lxc/">a specific apparmor settings</a>)</p>
<p>We bind mount the folders in our lxc container <code>/etc/pve/lxc/110.conf</code>:
<div class="highlight"><pre><span></span><code>
# temporary mount of off1 folders
mp6: /mnt/off1/off-products,mp=/mnt/off/products
mp7: /mnt/off1/off-images-products,mnt=/mnt/off/images
mp8: /mnt/off1/opf-products,mp=/mnt/opf/products
mp9: /mnt/off1/opf-images-products,mnt=/mnt/opf/images
mp10: /mnt/off1/obf-products,mp=/mnt/obf/products
mp11: /mnt/off1/obf-images-products,mnt=/mnt/obf/images

</code></pre></div>
Note: comments in conf file are put at begining of file by proxmox and populate notes in the interface.</p>
<p>Then restart container: <code>sudo pct reboot 110</code></p>
<p>Looking at data from inside the container, the current migration on images introduce a problem:
<div class="highlight"><pre><span></span><code><span class="o">(</span>opff<span class="o">))</span>$<span class="w"> </span>ls<span class="w"> </span>-l<span class="w"> </span>/mnt/off/images/000
lrwxrwxrwx<span class="w"> </span><span class="m">1</span><span class="w"> </span>nobody<span class="w"> </span>nogroup<span class="w"> </span><span class="m">33</span><span class="w">  </span><span class="m">1</span><span class="w"> </span>juin<span class="w">   </span><span class="m">09</span>:00<span class="w"> </span>/mnt/off/images/000<span class="w"> </span>-&gt;<span class="w"> </span>/mnt/off2/off-images/products/000
</code></pre></div>
this /mnt/off2/off-images/products/000 does not exists in the container
I can add it by adding one more MP.</p>
<p><strong>EDIT:</strong> after images migrations, I changed mounts to directly use the ZFS dataset for off/images.</p>
<p>We also have to mimic the old structure.
On opff as root:
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/srv/o<span class="o">{</span>f,p,b<span class="o">}</span>f/html/images/
$<span class="w"> </span>chown<span class="w"> </span>-R<span class="w"> </span>off:off<span class="w"> </span>-R<span class="w"> </span>/srv/o<span class="o">{</span>f,p,b<span class="o">}</span>f/
$<span class="w"> </span><span class="k">for</span><span class="w"> </span>site<span class="w"> </span><span class="k">in</span><span class="w"> </span>o<span class="o">{</span>f,p,b<span class="o">}</span>f<span class="p">;</span><span class="k">do</span><span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$site</span>/products<span class="w"> </span>/srv/<span class="nv">$site</span>/products<span class="p">;</span><span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/mnt/<span class="nv">$site</span>/images/products<span class="w"> </span>/srv/<span class="nv">$site</span>/html/images/products<span class="p">;</span><span class="k">done</span>
$<span class="w"> </span>ls<span class="w"> </span>-l<span class="w"> </span>/srv/o<span class="o">{</span>p,b,f<span class="o">}</span>f/<span class="w"> </span>/srv/o<span class="o">{</span>p,b,f<span class="o">}</span>f/html/images
</code></pre></div></p>
<h2 id="sharing-users-with-nfs">Sharing users with NFS<a class="headerlink" href="#sharing-users-with-nfs" title="Permanent link">#</a></h2>
<p>As I added nfs to expose off1 data to off2, I realized it could be better to use it to be able to continue to create users and have them synced on opff (let alone the lock, but it should be safe enough).</p>
<p>For that I have to mount a NFS mount of off1:/srv/off/users instead of the current zfs-hdd/off/users volume.</p>
<p>So I added <code>/srv/off/users</code> share in exports on off1:
<div class="highlight"><pre><span></span><code># share of off users until &quot;off&quot; migration to off2
/srv/off/users  10.0.0.2(rw,no_subtree_check,no_root_squash)
</code></pre></div>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span>reload<span class="w"> </span>nfs-server
</code></pre></div></p>
<p>On off2, I added in <code>/etc/fstab</code>:
<div class="highlight"><pre><span></span><code># TEMPORARY off users
10.0.0.1://srv/off/users  /mnt/off1/off-users nfs rw  0 0
</code></pre></div>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>/mnt/off1/off-users
mount<span class="w"> </span>/mnt/off1/off-users
<span class="c1"># test</span>
ls<span class="w"> </span>/mnt/off1/off-users/users_emails.sto
</code></pre></div></p>
<p>Replace mp2 volume in <code>/etc/pve/lxc/110.conf</code>
<div class="highlight"><pre><span></span><code>mp2: /mnt/off1/off-users,mp=/mnt/opff/users
</code></pre></div>
<div class="highlight"><pre><span></span><code>pct<span class="w"> </span>reboot<span class="w"> </span><span class="m">110</span>
</code></pre></div>
But it didn't start</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pct<span class="w"> </span>start<span class="w"> </span><span class="m">110</span>
run_buffer:<span class="w"> </span><span class="m">321</span><span class="w"> </span>Script<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span>status<span class="w"> </span><span class="m">116</span>
lxc_init:<span class="w"> </span><span class="m">847</span><span class="w"> </span>Failed<span class="w"> </span>to<span class="w"> </span>run<span class="w"> </span>lxc.hook.pre-start<span class="w"> </span><span class="k">for</span><span class="w"> </span>container<span class="w"> </span><span class="s2">&quot;110&quot;</span>
__lxc_start:<span class="w"> </span><span class="m">2008</span><span class="w"> </span>Failed<span class="w"> </span>to<span class="w"> </span>initialize<span class="w"> </span>container<span class="w"> </span><span class="s2">&quot;110&quot;</span>
startup<span class="w"> </span><span class="k">for</span><span class="w"> </span>container<span class="w"> </span><span class="s1">&#39;110&#39;</span><span class="w"> </span>failed
</code></pre></div>
<p>Trying to debug (<a href="https://forum.proxmox.com/threads/failed-to-run-lxc-hook-pre-start.33260/post-163472">as proposed here</a>):
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>lxc-start<span class="w"> </span>-n<span class="w"> </span><span class="m">110</span><span class="w"> </span>-F<span class="w"> </span>-lDEBUG<span class="w"> </span>-o<span class="w"> </span>/tmp/lxc-110.log
lxc-start:<span class="w"> </span><span class="m">110</span>:<span class="w"> </span>../src/lxc/conf.c:<span class="w"> </span>run_buffer:<span class="w"> </span><span class="m">321</span><span class="w"> </span>Script<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span>status<span class="w"> </span><span class="m">116</span>
lxc-start:<span class="w"> </span><span class="m">110</span>:<span class="w"> </span>../src/lxc/start.c:<span class="w"> </span>lxc_init:<span class="w"> </span><span class="m">847</span><span class="w"> </span>Failed<span class="w"> </span>to<span class="w"> </span>run<span class="w"> </span>lxc.hook.pre-start<span class="w"> </span><span class="k">for</span><span class="w"> </span>container<span class="w"> </span><span class="s2">&quot;110&quot;</span>
lxc-start:<span class="w"> </span><span class="m">110</span>:<span class="w"> </span>../src/lxc/start.c:<span class="w"> </span>__lxc_start:<span class="w"> </span><span class="m">2008</span><span class="w"> </span>Failed<span class="w"> </span>to<span class="w"> </span>initialize<span class="w"> </span>container<span class="w"> </span><span class="s2">&quot;110&quot;</span>
lxc-start:<span class="w"> </span><span class="m">110</span>:<span class="w"> </span>../src/lxc/tools/lxc_start.c:<span class="w"> </span>main:<span class="w"> </span><span class="m">306</span><span class="w"> </span>The<span class="w"> </span>container<span class="w"> </span>failed<span class="w"> </span>to<span class="w"> </span>start
lxc-start:<span class="w"> </span><span class="m">110</span>:<span class="w"> </span>../src/lxc/tools/lxc_start.c:<span class="w"> </span>main:<span class="w"> </span><span class="m">311</span><span class="w"> </span>Additional<span class="w"> </span>information<span class="w"> </span>can<span class="w"> </span>be<span class="w"> </span>obtained<span class="w"> </span>by<span class="w"> </span>setting<span class="w"> </span>the<span class="w"> </span>--logfile<span class="w"> </span>and<span class="w"> </span>--logpriority<span class="w"> </span>options
$<span class="w"> </span>cat<span class="w"> </span>/tmp/lxc-110.log

lxc-start<span class="w"> </span><span class="m">110</span><span class="w"> </span><span class="m">20230602130630</span>.394<span class="w"> </span>DEBUG<span class="w">    </span>conf<span class="w"> </span>-<span class="w"> </span>../src/lxc/conf.c:run_buffer:310<span class="w"> </span>-<span class="w"> </span>Script<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>/usr/share/lxc/hooks/lxc-pve-prestart-hook<span class="w"> </span><span class="m">110</span><span class="w"> </span>lxc<span class="w"> </span>pre-start<span class="w"> </span>produced<span class="w"> </span>output:<span class="w"> </span>directory<span class="w"> </span><span class="s1">&#39;/mnt/off1/off-products&#39;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist

lxc-start<span class="w"> </span><span class="m">110</span><span class="w"> </span><span class="m">20230602130630</span>.411<span class="w"> </span>ERROR<span class="w">    </span>conf<span class="w"> </span>-<span class="w"> </span>../src/lxc/conf.c:run_buffer:321<span class="w"> </span>-<span class="w"> </span>Script<span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span>status<span class="w"> </span><span class="m">116</span>

</code></pre></div></p>
<p>In fact I got
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ls<span class="w"> </span>/mnt/off1/
ls:<span class="w"> </span>cannot<span class="w"> </span>access<span class="w"> </span><span class="s1">&#39;/mnt/off1/obf-products&#39;</span>:<span class="w"> </span>Stale<span class="w"> </span>file<span class="w"> </span>handle
ls:<span class="w"> </span>cannot<span class="w"> </span>access<span class="w"> </span><span class="s1">&#39;/mnt/off1/off-products&#39;</span>:<span class="w"> </span>Stale<span class="w"> </span>file<span class="w"> </span>handle
ls:<span class="w"> </span>cannot<span class="w"> </span>access<span class="w"> </span><span class="s1">&#39;/mnt/off1/opf-products&#39;</span>:<span class="w"> </span>Stale<span class="w"> </span>file<span class="w"> </span>handle
$<span class="w"> </span>umount<span class="w"> </span>/mnt/off1/o<span class="o">{</span>p,f,b<span class="o">}</span>f-products
$<span class="w"> </span><span class="k">for</span><span class="w"> </span>f<span class="w"> </span><span class="k">in</span><span class="w"> </span>/mnt/off1/o<span class="o">{</span>p,f,b<span class="o">}</span>f-products<span class="p">;</span><span class="k">do</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$f</span><span class="p">;</span><span class="w"> </span>mount<span class="w"> </span><span class="nv">$f</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
/mnt/off1/opf-products
mount.nfs:<span class="w"> </span>access<span class="w"> </span>denied<span class="w"> </span>by<span class="w"> </span>server<span class="w"> </span><span class="k">while</span><span class="w"> </span>mounting<span class="w"> </span><span class="m">10</span>.0.0.1://rpool/opf/products
/mnt/off1/off-products
mount.nfs:<span class="w"> </span>access<span class="w"> </span>denied<span class="w"> </span>by<span class="w"> </span>server<span class="w"> </span><span class="k">while</span><span class="w"> </span>mounting<span class="w"> </span><span class="m">10</span>.0.0.1://rpool/off/products
/mnt/off1/obf-products
mount.nfs:<span class="w"> </span>access<span class="w"> </span>denied<span class="w"> </span>by<span class="w"> </span>server<span class="w"> </span><span class="k">while</span><span class="w"> </span>mounting<span class="w"> </span><span class="m">10</span>.0.0.1://rpool/obf/products
</code></pre></div>
This access denied is strange
After searching a bit, finally a <code>systemctl restart nfs-server</code> on off1 did resolve</p>
<p>Then <code>pct start 110</code> works.</p>
<h3 id="prepare-to-mount-off2-datasets-on-off1">Prepare to mount off2 datasets on off1<a class="headerlink" href="#prepare-to-mount-off2-datasets-on-off1" title="Permanent link">#</a></h3>
<p>After migration we want to be able to access opff products and images on off1 to ensure migrations works.</p>
<p>We just change sharenfs property:
<div class="highlight"><pre><span></span><code>zfs<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">sharenfs</span><span class="o">=</span><span class="nv">rw</span><span class="o">=</span>@10.0.0.1/32<span class="w"> </span>zfs-hdd/opff/products
zfs<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">sharenfs</span><span class="o">=</span><span class="nv">rw</span><span class="o">=</span>@10.0.0.1/32<span class="w"> </span>zfs-hdd/opff/images
</code></pre></div></p>
<p>And test on off1 it works:
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>/tmp/test-mount
mount<span class="w"> </span>-t<span class="w"> </span>nfs<span class="w"> </span>-o<span class="w"> </span>rw,nolock<span class="w"> </span><span class="s2">&quot;10.0.0.2://zfs-hdd/opff/products&quot;</span><span class="w">  </span>/tmp/test-mount
ls<span class="w"> </span>/tmp/test-mount/301/762/042/2003/
umount<span class="w"> </span>/tmp/test-mount
rmdir<span class="w"> </span>/tmp/test-mount
</code></pre></div></p>
<h2 id="improvment">Improvment<a class="headerlink" href="#improvment" title="Permanent link">#</a></h2>
<h3 id="using-git-for-off2-configurations">using git for off2 configurations<a class="headerlink" href="#using-git-for-off2-configurations" title="Permanent link">#</a></h3>
<p>Using <code>git</code> for off2 configuration (I'm omitting the moves / cp I add to do):</p>
<div class="highlight"><pre><span></span><code>ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/off2/sanoid/sanoid.conf/<span class="w"> </span>/etc/sanoid/sanoid.conf
ln<span class="w"> </span>-s<span class="w"> </span>/opt/openfoodfacts-infrastructure/confs/off2/sanoid/syncoid-args.conf<span class="w"> </span>/etc/sanoid/syncoid-args.conf
</code></pre></div>
<p>For <code>/etc/pve</code> symlinking is not possible (this is a fuse mount handled by proxmox). So I only copied current configuration.</p>
<h2 id="procedure-for-switch-of-opff-from-off1-to-off2">Procedure for switch of opff from off1 to off2<a class="headerlink" href="#procedure-for-switch-of-opff-from-off1-to-off2" title="Permanent link">#</a></h2>
<ol>
<li>
<p>change TTL for openpetfoodfacts domains to a low value in DNS</p>
</li>
<li>
<p>shutdown opff on off2
   <code>sudo systemctl stop apache2 nginx</code></p>
</li>
<li>
<p>Rync all data (on off2):
  <div class="highlight"><pre><span></span><code>date<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/opff/html/images/products/<span class="w">  </span>/zfs-hdd/opff/images/products/<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/opff/html/data/<span class="w">  </span>/zfs-hdd/opff/html_data/<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
sudo<span class="w"> </span>rsync<span class="w"> </span>--info<span class="o">=</span>progress2<span class="w"> </span>-a<span class="w"> </span>-x<span class="w"> </span><span class="m">10</span>.0.0.1:/srv/opff/deleted.images/<span class="w"> </span>/zfs-hdd/opff/deleted.images/<span class="w">  </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
date
</code></pre></div>
  opff/cache is skipped, nothing of interest.</p>
<p><em>took around 2min</em></p>
</li>
<li>
<p>products sync:</p>
<ul>
<li>remove opff from sync products script</li>
<li>do a zfs send of only opff products with a modified version of the script</li>
</ul>
</li>
<li>
<p>shutdown opff on both side
   on off1: <code>sudo systemctl stop apache2@opff</code> <code>unlink /etc/nginx/sites-enabled/opff &amp;&amp; systemctl reload nginx</code></p>
</li>
<li>
<p>change DNS to point to new machine</p>
</li>
<li>
<p>Rsync and zfs sync again</p>
</li>
<li>
<p>ensure migrations works using NFS:
   <div class="highlight"><pre><span></span><code><span class="c1"># move old prod</span>
mv<span class="w"> </span>/srv/opff<span class="w"> </span>/srv/opff.old
<span class="c1"># create dirs</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>/srv/opff/products<span class="w"> </span>/srv/opff/html/images/products
chown<span class="w"> </span>off:off<span class="w"> </span>-R<span class="w"> </span>/srv/opff
</code></pre></div>
   then change /etc/fstab to mount off1 there:
   <div class="highlight"><pre><span></span><code># mount of opff zfs datasets via NFS to enable products migrations
10.0.0.2:/zfs-hdd/opff/products  /srv/opff/products  nfs rw,nolock   0   0
10.0.0.2:/zfs-hdd/opff/images/products   /srv/opff/html/images/products  nfs rw,nolock   0   0
</code></pre></div>
   and mount:
   <div class="highlight"><pre><span></span><code>mount<span class="w"> </span>/srv/opff/products
mount<span class="w"> </span>/srv/opff/html/images/products
</code></pre></div></p>
</li>
<li>
<p>start opff on container off2/110 (opff): <code>sudo systemctl start apache2 nginx</code></p>
</li>
<li>check it works (remember to also clean your /etc/hosts if you modified it for tests)</li>
<li>
<p>disable opff service on off1:</p>
<ul>
<li><code>systemctl disable apache2@opff</code></li>
<li><code>unlink /etc/nginx/site-enabled/opff &amp;&amp; sytemctl reload nginx</code> (if not already done)</li>
</ul>
</li>
<li>
<p>on off2 and ovh3 modify sanoid configuration to have opff/products handled by sanoid and synced to ovh3</p>
</li>
<li>remove opff from snapshot-purge.sh on ovh3 (now handled by sanoid)</li>
<li>
<p>don't forget to test that it still work after that</p>
</li>
<li>
<p>cleanup:
    - remove opff gen feeds from <code>/srv/off/scripts/gen_all_feeds.sh</code> and <code>/srv/off/scripts/gen_all_feeds_daily.sh</code>
    - remove <code>/srv/opff/scripts/gen_opff_leaderboard.sh</code> from off crontab
    - remove or comment <code>/etc/logrotate.d/apache2-opff</code></p>
</li>
</ol>
<h2 id="still-todo">Still TODO<a class="headerlink" href="#still-todo" title="Permanent link">#</a></h2>
<h3 id="done">DONE<a class="headerlink" href="#done" title="Permanent link">#</a></h3>
<ul>
<li>image magick avec le format de mac HEIC - DONE on .net - TESTED OK</li>
<li>wilcard certificates on nginx proxy</li>
<li>GEOIP updates - verify it works and it's compatible (country of a product)</li>
</ul>
<ul>
<li>verify if compression is working on nginx ?
symlinks to check
find files that are symlinks in opff on off1:
<div class="highlight"><pre><span></span><code>$ find /srv/opff-old/ -xdev -type l -exec ls -l \{\} \;
</code></pre></div></li>
</ul>
<ul>
<li>logrotate:<ul>
<li>nginx specific logs -&gt; by system</li>
<li>apache logs -&gt; see above</li>
<li>product opener logs</li>
</ul>
</li>
</ul>
<ul>
<li>ssl headers on frontend ?:
  <div class="highlight"><pre><span></span><code>add_header Strict-Transport-Security &quot;max-age=63072000&quot;;
add_header X-Content-Type-Options nosniff;
add_header X-Frame-Options DENY;
</code></pre></div></li>
<li>ssl params on frontend ?
  <div class="highlight"><pre><span></span><code># from https://cipherli.st/
# and https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html

ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
ssl_prefer_server_ciphers on;
ssl_ciphers &quot;EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH&quot;;
ssl_ecdh_curve secp384r1;
#ssl_session_cache shared:SSL:10m;
ssl_session_tickets off;
ssl_stapling on;
ssl_stapling_verify on;
resolver 8.8.8.8 8.8.4.4 valid=300s;
resolver_timeout 5s;

include snippets/ssl-headers.conf;

ssl_dhparam /etc/ssl/certs/dhparam.pem;
</code></pre></div></li>
</ul>
<ul>
<li>mongodb export on mongodb server --&gt; installed client</li>
<li>mounting to enable products migration --&gt; NFS shares</li>
</ul>
<ul>
<li>/srv/opff/mediawiki folder is probably because this was initially stored in the git (it contains a php file).</li>
</ul>
<h3 id="improve">Improve<a class="headerlink" href="#improve" title="Permanent link">#</a></h3>
<ul>
<li>notification when important task fails</li>
<li>(DONE) verifications of state (last snapshot, last start date for a systemctl oneshot)</li>
<li>IP failover ? (maybe after off1 setup)</li>
<li>metrics ? prometheus-{apache,nginx}-exporter (+exposition via stunnel ?)</li>
<li>de we want to reintroduce this crontab entry: tail -n 10000 /srv/off/logs/access_log | grep search | /srv/off/logs/ban_abusive_ip.pl &gt; /dev/null 2&gt;&amp;1 ??? See if there are logs and if it works - can't we use nginx rate limitation instead ?</li>
<li>verification of snapshot state on off2 and ovh3</li>
<li>use chattr +i on mountpoints, see https://serverfault.com/questions/313994/how-to-prevent-access-to-unmounted-mount-point</li>
</ul>
<ul>
<li>remove svg of leaderboard on OPFF</li>
</ul>
<h3 id="todo-for-off-install">TODO for off install<a class="headerlink" href="#todo-for-off-install" title="Permanent link">#</a></h3>
<ul>
<li>Generate JS assets via github action and add to release</li>
<li>Minions for off</li>
<li>pb madenearme - WONTFIX ?</li>
<li></li>
</ul>
<div class="footnote">
<hr />
<ol>
<li id="fn:sanoid_debian">
<p>There seems to be a difference between debian bullseye packaging: it uses <code>cron.d</code> and <code>/etc/sanoid.conf</code>,
while the last stable version uses systemd timerss and <code>/etc/sanoid/sanoid.conf</code>.
So I prefered to go for the same version on all servers, and install the 2.1.0 deb that I built on ovh3.&#160;<a class="footnote-backref" href="#fnref:sanoid_debian" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.bd41221c.min.js"></script>
      
    
  <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>